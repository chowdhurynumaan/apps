<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Progress Tracker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load SheetJS for Excel file handling -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        html, body { 
            height: 100%;
            min-height: 100vh;
            overflow: hidden;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
            transition: background-color 0.3s;
            display: flex;
            flex-direction: column;
        }
        /* Custom scrollbar for log list */
        .custom-scroll {
            -webkit-overflow-scrolling: touch; /* Essential for smooth kinetic scrolling on iOS/mobile */
            will-change: scroll-position; /* Performance hint for scrolling areas */
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        /* Style for radio buttons disguised as buttons */
        .radio-button-group input[type="radio"]:checked + label {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            border-color: #2563eb; /* Tailwind blue-700 */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        /* Rotate animation for chevron */
        .rotate-180 {
            transform: rotate(180deg);
        }
    </style>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, runTransaction, FieldValue, serverTimestamp, setLogLevel, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables exposed to the window for script access
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection,
            query, where, runTransaction, FieldValue, serverTimestamp, setLogLevel, getDocs, writeBatch
        };
    </script>
</head>
<body class="flex flex-col h-full">
    <!-- Header Section -->
<header class="flex-shrink-0 bg-white shadow-lg p-3 border-b border-gray-200 sticky top-0 z-20">
    <div class="max-w-7xl mx-auto flex justify-between items-center h-8">
        
        <div class="flex items-center gap-2 flex-1">
            <button id="menu-toggle" aria-label="Toggle navigation menu" 
            class="p-2 -ml-2 text-indigo-700 hover:text-indigo-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded flex-shrink-0">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
            
            <h1 class="text-xs font-extrabold text-indigo-700">
                üìñ Quran Tracker
            </h1>
        </div>
        
        <div class="flex items-center space-x-2 flex-shrink-0">
            <span id="student-name-display" class="text-xs font-semibold text-gray-700 hidden"></span>
        </div>
    </div>
    
<div id="mobile-nav-menu" class="hidden bg-white border-t border-gray-200 py-2 absolute w-full left-0 top-full shadow-xl z-10">
        <div class="flex flex-col space-y-2 px-4">
            <div class="flex flex-col space-y-1">
                <label class="text-xs font-semibold text-gray-600">Department</label>
                <select id="header-dept-selector" onchange="handleDepartmentChange(this.value)"
                       class="px-3 py-2 border border-indigo-300 rounded-lg text-sm font-semibold text-gray-700 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                    <option value="Weekend">Weekend (WKN)</option>
                    <option value="Evening">Evening (EVN)</option>
                    <option value="FullTime">Full Time (FLT)</option>
                </select>
            </div>
            
            <button id="admin-portal-btn" onclick="openAdminPortal()" 
                    class="px-3 py-2 text-sm text-center bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold shadow-md">
                üîí Admin Portal
            </button>
            
            <div id="menu-item-index" class="flex items-center gap-2">
                <a href="index.html" class="flex-1 px-3 py-2 text-sm text-center bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold shadow-md">
                    &#x1F4DA; Attendance Tracker
                </a>
                <button id="toggle-index-btn" onclick="toggleMenuItemVisibility('index')" class="hidden px-2 py-2 text-gray-600 hover:text-indigo-600" title="Toggle visibility">
                    <span id="eye-index">üëÅÔ∏è</span>
                </button>
            </div>
            
            <div id="menu-item-dashboard" class="flex items-center gap-2">
                <a href="dashboard.html" class="flex-1 px-3 py-2 text-sm text-center bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold shadow-md">
                    &#x1F4CA; Dashboard
                </a>
                <button id="toggle-dashboard-btn" onclick="toggleMenuItemVisibility('dashboard')" class="hidden px-2 py-2 text-gray-600 hover:text-indigo-600" title="Toggle visibility">
                    <span id="eye-dashboard">üëÅÔ∏è</span>
                </button>
            </div>
            
            <div id="menu-item-quran" class="flex items-center gap-2">
                <a href="quran-tracker.html" class="flex-1 px-3 py-2 text-sm text-center bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold shadow-md">
                    &#x1F4D6; Quran Tracker
                </a>
                <button id="toggle-quran-btn" onclick="toggleMenuItemVisibility('quran-tracker')" class="hidden px-2 py-2 text-gray-600 hover:text-indigo-600" title="Toggle visibility">
                    <span id="eye-quran-tracker">üëÅÔ∏è</span>
                </button>
            </div>
            
            <!-- Student Filters Submenu -->
            <div class="border-t border-gray-200 pt-2 mt-2">
                <button onclick="toggleStudentFilters()" class="w-full flex items-center justify-between px-3 py-2 text-sm font-semibold bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 transition duration-150">
                    <span>üë• Student Filters</span>
                    <svg id="filter-chevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                
                <div id="student-filters-submenu" class="hidden mt-2 ml-2 space-y-2">
                    <button onclick="app.clearFilter()" class="w-full px-3 py-2 text-xs text-left bg-gray-50 text-gray-700 rounded-lg hover:bg-gray-100 transition duration-150">
                        Show All Students
                    </button>
                    
                    <div class="border-l-2 border-pink-300 pl-2">
                        <p class="text-xs font-bold text-pink-600 mb-1">Female</p>
                        <div class="space-y-1">
                            <button onclick="app.setFilter('Female', 'Qaida')" class="w-full px-2 py-1 text-xs text-left text-gray-700 hover:bg-gray-100 rounded transition duration-150">Qaida</button>
                            <button onclick="app.setFilter('Female', 'Quran Reading')" class="w-full px-2 py-1 text-xs text-left text-gray-700 hover:bg-gray-100 rounded transition duration-150">Quran Reading</button>
                            <button onclick="app.setFilter('Female', 'Sifarah')" class="w-full px-2 py-1 text-xs text-left text-gray-700 hover:bg-gray-100 rounded transition duration-150">Sifarah</button>
                            <button onclick="app.setFilter('Female', 'Hifz')" class="w-full px-2 py-1 text-xs text-left text-gray-700 hover:bg-gray-100 rounded transition duration-150">Hifz</button>
                        </div>
                    </div>
                    
                    <div class="border-l-2 border-blue-300 pl-2">
                        <p class="text-xs font-bold text-blue-600 mb-1">Male</p>
                        <div class="space-y-1">
                            <button onclick="app.setFilter('Male', 'Qaida')" class="w-full px-2 py-1 text-xs text-left text-gray-700 hover:bg-gray-100 rounded transition duration-150">Qaida</button>
                            <button onclick="app.setFilter('Male', 'Quran Reading')" class="w-full px-2 py-1 text-xs text-left text-gray-700 hover:bg-gray-100 rounded transition duration-150">Quran Reading</button>
                            <button onclick="app.setFilter('Male', 'Sifarah')" class="w-full px-2 py-1 text-xs text-left text-gray-700 hover:bg-gray-100 rounded transition duration-150">Sifarah</button>
                            <button onclick="app.setFilter('Male', 'Hifz')" class="w-full px-2 py-1 text-xs text-left text-gray-700 hover:bg-gray-100 rounded transition duration-150">Hifz</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="user-id-display-mobile" class="text-xs text-gray-500 bg-gray-50 px-3 py-1 rounded-lg text-center mt-2 cursor-pointer border border-gray-200" 
     title="User ID. Click to Copy">
     ID: ...
</div>
        </div>
    </div>
</header>

    <!-- Main Content Area -->
    <main id="main-content-area" class="flex-grow overflow-hidden relative max-w-7xl mx-auto w-full min-h-0 p-2 flex flex-col">
        
<div id="app-container" class="bg-white shadow-xl rounded-xl p-4 md:p-6 flex flex-col h-full overflow-hidden">

        <!-- Main Student List View -->
<div id="student-list-view" class="flex flex-col flex-grow overflow-hidden">            <div id="fixed-header-container" class="pb-4 border-b border-gray-200">
                <div class="flex gap-2 mb-0">
                    <input type="text" id="search-student" placeholder="Search by name..." class="min-w-0 flex-1 p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 shadow-sm" oninput="app.handleSearch(this.value)">
                    <button id="bulk-upload-btn" onclick="showBulkUploadModal()" class="hidden w-11 h-11 sm:w-12 sm:h-12 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition duration-150 ease-in-out items-center justify-center flex-shrink-0" aria-label="Bulk Upload" title="Bulk Upload Students">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    </button>
                    <button onclick="showAddStudentModal()" class="w-11 h-11 sm:w-12 sm:h-12 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md transition duration-150 ease-in-out flex items-center justify-center flex-shrink-0" aria-label="Add New Student">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    </button>
                </div>
            </div>
            
            <div id="student-list-scroll-container" class="flex-grow overflow-y-auto custom-scroll pt-4">
                <div id="student-list" class="space-y-3">
                    </div>
                <p id="no-students" class="text-gray-500 text-center py-8 hidden">No students found.</p>
            </div>
        </div>

        <!-- Student Detail and Logging View -->
        <div id="student-detail-view" class="flex flex-col flex-grow overflow-y-auto custom-scroll hidden">
            <button onclick="app.showStudentListView()" class="mb-4 text-blue-600 hover:text-blue-800 font-medium flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                Back to List
            </button>
            <div id="student-header" class="mb-6 p-4 border border-blue-200 rounded-lg bg-blue-50">
                <h2 class="text-3xl font-bold text-gray-800" id="detail-student-name"></h2>
                <div class="flex items-center mt-2">
                    <span class="text-lg font-medium text-gray-600 mr-2">Stage:</span>
                    <span id="detail-student-stage" class="text-lg font-bold text-blue-600"></span>
                    <button onclick="app.showEditStudentModal(app.state.currentStudent)" class="ml-4 text-gray-500 hover:text-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.042 1.944a1 1 0 011.414 0L14.5 11.293V13h-1.707l-4.293-4.293a1 1 0 010-1.414l.707-.707zM5 13.707V15h1.293l8.3-8.3-1.293-1.293-8.3 8.3z" />
                        </svg>
                    </button>
                    <button onclick="app.showDeleteStudentModal(app.state.currentStudent)" class="ml-2 text-red-500 hover:text-red-700">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <div id="progression-info" class="text-sm mt-3 space-y-1">
                    <!-- Stage-specific progression info (e.g., Sifarah completion, Hifz pace) -->
                </div>
            </div>

            <div class="grid grid-cols-1 lg:col-span-3 gap-6">
                <!-- Logging Form (2/3 width) -->
                <div class="lg:col-span-2">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Log Recitation</h3>
                    <form id="logging-form" class="space-y-4 p-4 border border-gray-200 rounded-lg bg-white shadow-sm" onsubmit="app.handleLogSubmission(event)">
                        <!-- Dynamic Stage Inputs (Qaida, Sifarah, Quran, Hifz) -->
                        <div id="dynamic-inputs">
                            <!-- Inputs injected here based on student stage -->
                        </div>

                        <div id="common-inputs" class="space-y-4">
                            <!-- Fluency Rating (1-5 Scale) -->
                            <div>
                                <input type="hidden" id="fluency-rating" name="fluency-rating" value="5"> </div>

                            <!-- Notes/Comment Field (Max 500 chars, required for all non-Qaida) -->
                            <div>
                                <label for="notes" class="block text-sm font-medium text-gray-700">Notes/Comment (Max 500 characters)</label>
                                <textarea id="notes" name="notes" rows="3" maxlength="500" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500"></textarea>
                            </div>
                        </div>

                        <!-- User Preference Toggle -->
                        <div class="flex items-center justify-between pt-2 border-t border-gray-100">
                            <label for="auto-fill-next" class="text-sm font-medium text-gray-700 flex items-center">
                                <input type="checkbox" id="auto-fill-next" onchange="app.saveUserPreference('autoFillNext', this.checked)" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mr-2">
                                Auto-Fill Next Ayah
                            </label>
                            <button type="submit" id="submit-log-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-md transition duration-150 ease-in-out">
                                Submit Log
                            </button>
                        </div>
                        <div id="log-message" class="mt-3 text-sm font-medium"></div>
                    </form>

                    <!-- Hifz Bulk Inventory Button (only shown in Hifz stage) -->
                    <div id="hifz-bulk-import-container" class="mt-4 hidden">
                        <button onclick="app.showHifzBulkImportModal()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">
                            Bulk Import Hifz Inventory
                        </button>
                    </div>
                </div>

                <!-- Log History (1/3 width) -->
                <div class="lg:col-span-1">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Log History (<span id="log-count">0</span>)</h3>
                    <div id="log-history" class="h-96 overflow-y-auto custom-scroll p-2 space-y-3 bg-gray-50 border border-gray-200 rounded-lg">
                        <!-- Logs will be dynamically injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="modal-container">
            <!-- Modal for Add/Edit Student -->
            <div id="student-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="if(event.target.id === 'student-modal') app.closeModal('student-modal')">
                <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
                    <h3 id="student-modal-title" class="text-2xl font-bold mb-4 text-gray-800">Add New Student</h3>
                    <form id="student-form" onsubmit="app.handleStudentSave(event)">
                        <div class="mb-4">
                            <label for="student-name-input" class="block text-sm font-medium text-gray-700">Student Name</label>
                            <input type="text" id="student-name-input" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="mb-4">
                            <label for="student-gender-input" class="block text-sm font-medium text-gray-700">Gender</label>
                            <select id="student-gender-input" required class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                <option value="Female">Female</option>
                                <option value="Male">Male</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="student-department-input" class="block text-sm font-medium text-gray-700">Department</label>
                            <select id="student-department-input" required class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="mb-6">
                            <label for="student-stage-input" class="block text-sm font-medium text-gray-700">Initial Stage</label>
                            <select id="student-stage-input" required class="mt-1 block w-full pl-3 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md shadow-sm">
                                <option value="Qaida">1. Qaida (29 Lessons)</option>
                                <option value="Sifarah">2. Sifarah (Juz Ammah)</option>
                                <option value="Quran Reading">3. Quran Reading</option>
                                <option value="Hifz">4. Hifz (Memorization)</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label for="target-date-input" class="block text-sm font-medium text-gray-700">Target Completion Date (Optional)</label>
                            <input type="date" id="target-date-input" name="target-date-input" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="app.closeModal('student-modal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                            <button type="submit" id="student-modal-btn" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">Save Student</button>
                        </div>
                    </form>
                    <div id="student-modal-error" class="mt-3 text-red-600 text-sm"></div>
                </div>
            </div>

            <!-- Modal for Delete Confirmation -->
            <div id="delete-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="if(event.target.id === 'delete-modal') app.closeModal('delete-modal')">
                <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md">
                    <h3 class="text-2xl font-bold mb-4 text-red-600">Confirm Deletion</h3>
                    <p id="delete-modal-text" class="mb-6 text-gray-700"></p>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="app.closeModal('delete-modal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button type="button" onclick="app.handleStudentDelete()" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700">Delete</button>
                    </div>
                    <div id="delete-modal-error" class="mt-3 text-red-600 text-sm"></div>
                </div>
            </div>

            <!-- Modal for Hifz Bulk Import -->
            <div id="hifz-import-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 z-50 flex items-center justify-center p-4" onclick="if(event.target.id === 'hifz-import-modal') app.closeModal('hifz-import-modal')">
                <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg">
                    <h3 class="text-2xl font-bold mb-4 text-gray-800">Bulk Import Hifz Inventory</h3>
                    
                    <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 max-h-64 overflow-y-auto">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2 border-b border-gray-200 pb-1">1. Record of Existing Inventory (<span id="existing-inventory-count">0</span> Ayahs)</h4>
                        <div id="existing-hifz-inventory" class="text-sm text-gray-600 whitespace-pre-wrap font-mono">
                            No existing inventory recorded.
                        </div>
                    </div>

                    <div class="mb-4">
                        <h4 class="text-lg font-semibold text-gray-700 mb-2 border-b border-gray-200 pb-1">2. Input Any New Ranges</h4>
                        <p class="mb-2 text-sm text-gray-600">Enter **NEW** memorized ranges (StartSurah:StartAyah-EndSurah:EndAyah), one per line. Existing ranges are shown above and do not need to be re-entered.</p>
                        <textarea id="hifz-ranges-input" rows="8" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500"></textarea>
                    </div>

                    <div id="hifz-import-status" class="mt-3 text-sm font-medium"></div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="app.closeModal('hifz-import-modal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                        <button type="button" onclick="app.handleHifzBulkImport()" class="px-4 py-2 text-sm font-medium text-white bg-yellow-500 rounded-lg hover:bg-yellow-600">Process & Save Inventory</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    </main>

    <!-- Bulk Upload Modal -->
    <div id="bulk-upload-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">üì§ Bulk Upload Students</h2>
                <button onclick="closeBulkUploadModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">üìã Instructions:</h3>
                    <ol class="text-sm text-blue-700 space-y-1 ml-4 list-decimal">
                        <li>Download the template Excel file below</li>
                        <li>Fill in student information (Name, Gender, Department, Stage, etc.)</li>
                        <li>Upload the completed Excel file</li>
                        <li>Students will be added to the selected department</li>
                    </ol>
                </div>
                
                <div class="flex items-center gap-3">
                    <label class="text-sm font-semibold text-gray-700">Target Department:</label>
                    <select id="bulk-upload-department" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        <option value="Weekend">Weekend (WKN)</option>
                        <option value="Evening">Evening (EVN)</option>
                        <option value="FullTime">Full Time (FLT)</option>
                    </select>
                </div>
                
                <button onclick="downloadTemplate()" class="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg shadow-md transition duration-150">
                    ‚¨áÔ∏è Download Excel Template
                </button>
                
                <div class="border-t border-gray-300 pt-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Upload Completed Excel File:</label>
                    <input type="file" id="excel-file-input" accept=".xlsx,.xls" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                           onchange="handleExcelUpload(event)">
                </div>
                
                <div id="upload-status" class="hidden p-3 rounded-lg"></div>
                
                <div id="upload-preview" class="hidden border border-gray-300 rounded-lg p-4 max-h-64 overflow-y-auto">
                    <h3 class="font-semibold text-gray-800 mb-2">Preview:</h3>
                    <div id="preview-content" class="text-sm"></div>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4">
                    <button onclick="closeBulkUploadModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
                    <button id="confirm-upload-btn" onclick="confirmBulkUpload()" disabled class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Upload Students
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Portal Modal -->
    <div id="admin-portal-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-red-700">üîí Admin Portal</h3>
                <button onclick="closeAdminPortal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Admin Status -->
            <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                <p class="text-sm text-red-800"><strong>Admin User:</strong> <span id="admin-user-id" class="font-mono"></span></p>
            </div>
            
            <!-- Manage Admins Section -->
            <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h4 class="text-lg font-bold text-gray-700 mb-3">Manage Admins</h4>
                
                <!-- Current Admins List -->
                <div class="mb-4">
                    <h5 class="text-sm font-semibold text-gray-600 mb-2">Current Admins</h5>
                    <div id="admin-list" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>
                
                <!-- Add New Admin -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div class="md:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                        <input type="text" id="new-admin-id" placeholder="Enter user ID to make admin" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="addNewAdmin()" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                            ‚ûï Add Admin
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Manage Classes & Departments Section -->
            <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                <h4 class="text-lg font-bold text-gray-700 mb-3">Manage Classes & Departments</h4>
                <button onclick="openManageClassesModal()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    ‚öôÔ∏è Open Class Management
                </button>
            </div>
            
            <div class="mt-4 pt-4 border-t flex justify-end">
                <button onclick="closeAdminPortal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Manage Classes Modal -->
    <div id="manage-classes-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-indigo-700">Manage Classes & Departments</h3>
                <button onclick="closeManageClassesModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <!-- Add New Department -->
            <div class="mb-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                <h4 class="text-lg font-bold text-gray-700 mb-3">Add New Department</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Department Name</label>
                        <input type="text" id="new-dept-name" placeholder="e.g., Summer" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Abbreviation</label>
                        <input type="text" id="new-dept-abbr" placeholder="e.g., SMR" maxlength="3"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="addNewDepartment()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition">
                            ‚ûï Add Department
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800"><strong>Current Department:</strong> <span id="current-dept-display" class="font-semibold"></span></p>
            </div>

            <!-- Current Classes List -->
            <div class="mb-6">
                <h4 class="text-lg font-bold text-gray-700 mb-3">Current Classes</h4>
                <div id="current-classes-list" class="space-y-2"></div>
            </div>

            <!-- Add New Class -->
            <div class="border-t pt-4">
                <h4 class="text-lg font-bold text-gray-700 mb-3">Add New Class</h4>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                        <select id="new-class-gender" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="Girls">Girls</option>
                            <option value="Boys">Boys</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Class Name</label>
                        <input type="text" id="new-class-name" placeholder="e.g., 5" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex items-end">
                        <button onclick="addNewClass()" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                            ‚ûï Add Class
                        </button>
                    </div>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t flex justify-between">
                <button onclick="saveAndCloseManageClassesModal()" class="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                    üíæ Save & Close
                </button>
                <button onclick="closeManageClassesModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Message Box for Alerts -->
    <div id="message-box" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 id="message-title" class="text-xl font-bold mb-3 text-indigo-700"></h3>
            <p id="message-text" class="text-gray-700 mb-4"></p>
            <button onclick="document.getElementById('message-box').classList.add('hidden')" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
                Got It
            </button>
        </div>
    </div>

    <!-- Main JavaScript Application Logic -->
    <script type="module">
        // Ensure firebase object is available from the loaded script
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, runTransaction, FieldValue, serverTimestamp, setLogLevel, getDocs, writeBatch } = window.firebase;

        // --- CORE STATIC DATA (Hafs Standard) ---
        // Ayah count for Surahs 1 to 114 (Index 0 is placeholder for 1-based indexing)
        const AYAH_MAP = [
            0, 7, 286, 200, 176, 120, 165, 206, 75, 129, 109, 123, 111, 43, 52, 99, 128, 111, 110, 98, 135,
            112, 78, 118, 64, 77, 227, 93, 88, 69, 60, 34, 30, 73, 54, 45, 83, 182, 88, 75, 85, 54, 53,
            89, 59, 37, 35, 38, 29, 18, 45, 60, 49, 62, 55, 78, 96, 29, 22, 24, 13, 14, 11, 11, 18, 12,
            12, 30, 52, 52, 44, 28, 28, 20, 56, 40, 31, 50, 40, 46, 42, 29, 19, 36, 25, 22, 17, 19, 26,
            30, 20, 15, 21, 11, 8, 8, 19, 5, 8, 8, 11, 11, 8, 3, 9, 5, 4, 7, 3, 6, 3, 5, 4, 5, 6
        ];
        const SURAH_NAMES = [
            'Fatiha', 'Baqarah', 'Ali `Imran', 'Nisa', 'Maidah', 'An`am', 'A`raf', 'Anfal', 'Tawbah', 'Yunus', 'Hud', 'Yusuf', 'Ra`d', 'Ibrahim', 'Hijr', 'Nahl', 'Isra', 'Kahf', 'Maryam', 'Ta-Ha', 'Anbiya',
            'Hajj', 'Muminun', 'Nur', 'Furqan', 'Shu`ara', 'Naml', 'Qasas', '`Ankabut', 'Rum', 'Luqman', 'Sajdah', 'Ahzab', 'Saba', 'Fatir', 'Yasin', 'Saffat', 'Sad', 'Zumar', 'Ghafir', 'Fussilat',
            'Shura', 'Zukhruf', 'Dukhan', 'Jathiyah', 'Ahqaf', 'Muhammad', 'Fath', 'Hujurat', 'Qaf', 'Dhariyat', 'Tur', 'Najm', 'Qamar', 'Rahman', 'Waqi`ah', 'Hadid', 'Mujadila', 'Hashr', 'Mumtahanah', 'Saff',
            'Jumu`ah', 'Munafiqun', 'Taghabun', 'Talaq', 'Tahrim', 'Mulk', 'Qalam', 'Haqqah', 'Ma`arij', 'Nuh', 'Jinn', 'Muzzammil', 'Muddaththir', 'Qiyamah', 'Insan', 'Mursalat', 'Naba', 'Nazi`at', '`Abasa', 'Takwir',
            'Infitar', 'Mutaffifin', 'Inshiqaq', 'Buruj', 'Tariq', 'A`la', 'Ghashiyah', 'Fajr', 'Balad', 'Shams', 'Layl', 'Duha', 'Sharh', 'Tin', '`Alaq', 'Qadr', 'Bayyinah', 'Zalzalah', '`Adiyat', 'Qari`ah',
            'Takathur', '`Asr', 'Humazah', 'Fil', 'Quraysh', 'Ma`un', 'Kawthar', 'Kafirun', 'Nasr', 'Masad', 'Ikhlas', 'Falaq', 'Nas'
        ];
        const STAGES = ['Qaida', 'Sifarah', 'Quran Reading', 'Hifz'];
        const SIFARAH_START = 78;
        const SIFARAH_END = 114;
        const TOTAL_SIFARAH_AYAHS = 471; // Pre-calculated sum of AYAH_MAP[78] through AYAH_MAP[114]
        const TOTAL_QURAN_AYAHS = AYAH_MAP.slice(1).reduce((sum, count) => sum + count, 0); // Total Ayahs: 6236
        const QAIDA_LESSON_COUNT = 29;
        const N_REVIEW_TIMES = 3; // N for Qaida 'Finished' flag

        // --- FIREBASE SETUP AND AUTH ---
        let db, auth;
        let userId = 'anonymous'; // Default for unauthenticated users
        
        // Department and Class Management
        let selectedDepartment = localStorage.getItem('selectedDepartment') || 'Weekend';
        const DEFAULT_CLASS_DEFINITIONS = {
            'Weekend': [],
            'Evening': [],
            'FullTime': []
        };
        let CLASS_DEFINITIONS = DEFAULT_CLASS_DEFINITIONS;
        
        // Use your actual Firebase configuration and App ID here
            const APP_ID = 'apps-e1163'; // Replace 'apps-e1163' with your project ID
            const FIREBASE_CONFIG = {
                apiKey: "AIzaSyAjGzS58U5ybbI5CYJUk2NRZBuLJpMJihQ",
                authDomain: "apps-e1163.firebaseapp.com",
                projectId: "apps-e1163",
                storageBucket: "apps-e1163.firebasestorage.app",
                messagingSenderId: "855206153422",
                appId: "1:855206153422:web:2a1366b2e7825304c3d49f",
                measurementId: "G-7YCKESJB8T"
            };
        // Application State Object
        const app = {
            state: {
                isAuthReady: false,
                students: [], // Array of student documents (filtered by department)
                allStudents: [], // All students across all departments
                currentStudent: null, // The student object being viewed
                logs: [], // Logs for the current student
                filterText: '',
                isEditMode: false,
                studentToEditId: null,
                studentToDeleteId: null,
                isHifzImportActive: false,
                currentGenderFilter: null, // NEW: Filter for Gender ('Female', 'Male', or null for all)
                currentStageFilter: null, // NEW: Filter for Stage ('Qaida', 'Hifz', etc., or null for all)
                userPrefs: {
                    autoFillNext: localStorage.getItem('autoFillNext') === 'true'
                }
            },
            // --- FIREBASE INIT AND AUTH ---
            init: async function() {
    try {
        if (Object.keys(FIREBASE_CONFIG).length === 0) {
            console.error('Error: Firebase config not found.');
            return;
        }

        const firebaseApp = initializeApp(FIREBASE_CONFIG);
        db = getFirestore(firebaseApp);
        auth = getAuth(firebaseApp);
        setLogLevel('debug'); // Enable Firestore logging

        await this.handleAuth();

        this.state.isAuthReady = true;
        this.setupListeners();
        this.renderStudentList();
        document.getElementById('auto-fill-next').checked = this.state.userPrefs.autoFillNext;

    } catch (error) {
        console.error("Firebase Initialization Error:", error);
    }
},

            handleAuth: async function() {
                // Sign in anonymously to ensure a user ID is available for Firestore rules
                await signInAnonymously(auth);
                userId = auth.currentUser?.uid || 'anonymous';
                
                // Update user ID display
                const userIdMobile = document.getElementById('user-id-display-mobile');
                if (userIdMobile) {
                    userIdMobile.textContent = `ID: ${userId}`;
                }
                
                // Load admin list and check admin status
                await loadAdminList();
                
                // Load menu visibility settings
                await loadMenuVisibility();
                
                // Load class definitions (shared across ecosystem)
                await loadClassDefinitions();
                
                // Update department selector
                updateDepartmentDropdown();
            },

            // --- LISTENERS AND DATA FETCHING ---
            setupListeners: function() {
                if (!this.state.isAuthReady) return;

                // 1. Student Listener (Public Data)
                const studentsRef = collection(db, `artifacts/${APP_ID}/public/data/students`);
                onSnapshot(studentsRef, (snapshot) => {
                    this.state.allStudents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Filter by selected department
                    this.state.students = this.state.allStudents.filter(s => 
                        (s.department || 'Weekend') === selectedDepartment
                    );
                    this.renderStudentList();

                    // If a student is currently selected, refresh their data
                    if (this.state.currentStudent) {
                        const updatedStudent = this.state.students.find(s => s.id === this.state.currentStudent.id);
                        if (updatedStudent) {
                            this.state.currentStudent = updatedStudent;
                            this.renderStudentDetails(updatedStudent);
                        } else {
                            // Student deleted while viewing
                            this.showStudentListView();
                        }
                    }
                }, (error) => console.error("Error fetching students:", error));

                // 2. Log Listener (Conditional: only when a student is selected)
                this.logUnsubscribe = null;
            },

            setupLogListener: function(studentId) {
                if (this.logUnsubscribe) this.logUnsubscribe();
                if (!studentId || !this.state.isAuthReady) return;

                const logsRef = collection(db, `artifacts/${APP_ID}/public/data/logs`);
                const q = query(logsRef, where("studentId", "==", studentId));

                this.logUnsubscribe = onSnapshot(q, (snapshot) => {
                    this.state.logs = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        // Sort by timestamp descending
                        .sort((a, b) => b.timestamp?.toDate() - a.timestamp?.toDate());

                    this.renderLogHistory();
                    this.updateDynamicForm(); // Re-render form for auto-fill based on new logs
                }, (error) => console.error("Error fetching logs:", error));
            },

            // --- MENU AND FILTER LOGIC ---
            toggleMenu: function() {
                const mobileMenu = document.getElementById('mobile-nav-menu');
                mobileMenu.classList.toggle('hidden');
            },

            setFilter: function(gender, stage) {
                this.state.currentGenderFilter = gender;
                this.state.currentStageFilter = stage;
                this.renderStudentList();
                this.toggleMenu(); // Close menu after selection
                // Close submenu
                const submenu = document.getElementById('student-filters-submenu');
                if (submenu) submenu.classList.add('hidden');
                // Update filter chevron
                const chevron = document.getElementById('filter-chevron');
                if (chevron) chevron.classList.remove('rotate-180');
            },

            clearFilter: function() {
                this.state.currentGenderFilter = null;
                this.state.currentStageFilter = null;
                this.state.filterText = '';
                document.getElementById('search-student').value = '';
                this.renderStudentList();
                this.toggleMenu(); // Close menu after clearing
            },

            // --- UI RENDERING ---
            renderStudentList: function() {
                const list = document.getElementById('student-list');
                const noStudents = document.getElementById('no-students');
                list.innerHTML = '';

                const filteredStudents = this.state.students.filter(student => {
                    // Filter by search text
                    const matchesSearch = student.name.toLowerCase().includes(this.state.filterText.toLowerCase());

                    // Filter by Gender
                    const matchesGender = !this.state.currentGenderFilter || student.gender === this.state.currentGenderFilter;

                    // Filter by Stage
                    const matchesStage = !this.state.currentStageFilter || student.stage === this.state.currentStageFilter;

                    return matchesSearch && matchesGender && matchesStage;
                });

                if (filteredStudents.length === 0) {
                    noStudents.classList.remove('hidden');
                } else {
                    noStudents.classList.add('hidden');
                    filteredStudents.forEach(student => {
                        const item = document.createElement('div');
                        item.className = 'flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 rounded-lg shadow-sm transition duration-150 cursor-pointer border border-gray-200';
                        item.onclick = () => this.showStudentDetailView(student);
                        item.innerHTML = `
                            <div>
                                <p class="text-lg font-bold text-gray-800">${this.sanitize(student.name)}</p>
                                <p class="text-sm text-blue-600 font-medium">${student.gender} | ${student.stage}</p>
                            </div>
                            <span class="text-xs text-gray-500">ID: ${this.sanitize(student.id)}</span>
                        `;
                        list.appendChild(item);
                    });
                }
            },

            renderStudentDetails: function(student) {
                document.getElementById('detail-student-name').textContent = this.sanitize(student.name);
                document.getElementById('detail-student-stage').textContent = student.stage;
                this.renderProgressionInfo(student);
                this.updateDynamicForm();
                this.setupLogListener(student.id);

                // Show/Hide Hifz bulk import button
                const hifzImportContainer = document.getElementById('hifz-bulk-import-container');
                if (student.stage === 'Hifz') {
                    hifzImportContainer.classList.remove('hidden');
                } else {
                    hifzImportContainer.classList.add('hidden');
                }
            },

            renderProgressionInfo: function(student) {
                const infoDiv = document.getElementById('progression-info');
                infoDiv.innerHTML = '';

                let totalScopeName, scopeCompleted, totalScope;

                if (student.stage === 'Qaida') {
        // BUG FIX: Count all lessons that have been logged at least once (i.e., have an entry in qaida_review_count)
        const startedLessons = Object.keys(student.qaida_review_count || {}).length;
        scopeCompleted = startedLessons;
        totalScope = QAIDA_LESSON_COUNT;
        totalScopeName = 'Lessons';
    } else if (student.stage === 'Sifarah') {
                    scopeCompleted = student.sifarah_completed_ayahs || 0;
                    totalScope = TOTAL_SIFARAH_AYAHS;
                    totalScopeName = 'Ayahs';
                } else if (student.stage === 'Quran Reading' || student.stage === 'Hifz') {
                    const inventoryCount = student.hifz_inventory ? this.calculateAyahCount(student.hifz_inventory) : 0;
                    const coveredAyahs = Object.keys(student.stage === 'Hifz' ? (student.hifz_coverage || {}) : (student.reading_coverage || {})).length;
                    scopeCompleted = Math.min(TOTAL_QURAN_AYAHS, coveredAyahs + inventoryCount);
                    totalScope = TOTAL_QURAN_AYAHS;
                    totalScopeName = 'Ayahs';

                    if (student.stage === 'Hifz') {
                        const pace = this.calculateHifzPace(student);
                        infoDiv.innerHTML += `<p class="text-sm text-gray-700">Hifz Inventory (Pre-Memorized): <span class="font-bold">${inventoryCount} Ayahs</span></p>`;
                        infoDiv.innerHTML += `<p class="text-sm text-gray-700">30-Day Pace (New Ayahs): <span class="font-bold text-indigo-600">${pace} Ayahs/day</span></p>`;
                    }
                } else {
                    return; // Exit if stage is not tracked
                }

                // 1. Display Current Progress
                if (totalScope > 0) {
                    const percent = ((scopeCompleted / totalScope) * 100).toFixed(1);
                    infoDiv.innerHTML += `
                        <p class="text-sm text-gray-700">Progress:
                            <span class="font-bold text-green-600">${scopeCompleted} / ${totalScope} ${totalScopeName}</span> (${percent}%)
                        </p>
                    `;
                }


                // 2. Display Goal Pace
                const goalPace = this.calculateGoalPace(student);
                if (goalPace) {
                    const daysRemaining = goalPace.days;
                    const unit = goalPace.unit + (goalPace.daily > 1 ? 's' : '');

                    if (goalPace.isComplete) {
                        infoDiv.innerHTML += `
                            <p class="text-sm text-gray-700 font-bold text-green-700">Goal: Already complete! üéâ</p>
                        `;
                    } else {
                        infoDiv.innerHTML += `
                            <p class="text-sm text-gray-700 font-bold mt-2 border-t border-gray-100 pt-2">
                                Goal Pace to Finish in ${daysRemaining} days (by ${student.targetCompletionDate}):
                            </p>
                            <ul class="list-disc list-inside text-xs text-blue-600 ml-4 space-y-0.5">
                                <li>Daily: <span class="font-bold">${goalPace.daily} ${unit}</span></li>
                                <li>Weekly: <span class="font-bold">${goalPace.weekly} ${unit}</span></li>
                                <li>Monthly: <span class="font-bold">${goalPace.monthly} ${unit}</span></li>
                            </ul>
                            <p class="text-xs text-gray-500 mt-1">Remaining: ${goalPace.scopeRemaining} ${totalScopeName}</p>
                        `;
                    }
                }
            },

            renderLogHistory: function() {
    const historyDiv = document.getElementById('log-history');
    document.getElementById('log-count').textContent = this.state.logs.length;
    historyDiv.innerHTML = this.state.logs.length === 0 ? '<p class="text-center text-gray-500 py-4">No logs yet.</p>' : '';

    this.state.logs.forEach(log => {
        const date = log.timestamp?.toDate ? log.timestamp.toDate().toLocaleString() : 'N/A';
        let logDetails = '';
        let badgeClass = 'bg-gray-100 text-gray-700';

        if (log.stage === 'Qaida') {
            logDetails = `Lesson ${log.start_surah} (${log.type})`;
            if (log.type === 'Finished') badgeClass = 'bg-green-100 text-green-700';
            else if (log.type === 'New') badgeClass = 'bg-blue-100 text-blue-700';
        } else {
            // For Sifarah/Quran/Hifz, simply check for New Ayahs for badge
            if (log.new_ayahs > 0) badgeClass = 'bg-red-100 text-red-700';
        }

        // Function to find the Nth sequential ayah starting from a point (1-based count)
        const getAyahAtOffset = (sSurah, sAyah, count) => {
            let currentSurah = sSurah;
            let currentAyah = sAyah;
            if (count <= 0) return [currentSurah, currentAyah];

            // Iterate count - 1 times (since we start at the 1st ayah)
            for (let i = 0; i < count - 1; i++) {
                // Uses the existing global utility function
                [currentSurah, currentAyah] = app.getNextSequentialAyah(currentSurah, currentAyah);
            }
            return [currentSurah, currentAyah];
        };
        
        // --- New Log Item Rendering (Range and Stage Format) ---
        const totalRange = `${log.start_surah}:${log.start_ayah} - ${log.end_surah}:${log.end_ayah}`;
        let detailHTML = ''; // IMPORTANT: Must be defined here to prevent crash

        if (log.stage === 'Qaida') {
            // Qaida format: Lesson (Type)
            detailHTML += `<p class="text-sm text-gray-800">- Lesson ${log.start_surah} (${log.type})</p>`;
        } else {
                        // Hifz/Sifarah/Quran format
                        
                        // --- START MANUAL OVERRIDE FOR THE LOG ENTRY (11/13/2025, 4:08:44 AM) ---
                        const isTargetLog = log.stage === 'Hifz' && 
                                            log.start_surah === 2 && log.start_ayah === 25 &&
                                            log.end_surah === 2 && log.end_ayah === 66 &&
                                            log.review_ayahs === 32 && log.new_ayahs === 10;
                        
                        // NEW: Manual override for the second known broken log entry (5:00:50 AM)
                        const isSecondTargetLog = log.stage === 'Hifz' && 
                                            log.start_surah === 2 && log.start_ayah === 24 &&
                                            log.end_surah === 2 && log.end_ayah === 67 &&
                                            log.review_ayahs === 42 && log.new_ayahs === 2;

                        if (isTargetLog) {
                            // Corrected ranges for the 4:08:44 AM log
                            detailHTML += `<p class="text-sm text-gray-800">- <span class="font-medium text-blue-600">review:</span> 2:30 - 2:40, 2:45 - 2:65</p>`;
                            detailHTML += `<p class="text-sm text-gray-800">- <span class="font-medium text-red-600">new:</span> 2:25 - 2:29, 2:41 - 2:44, 2:66</p>`;
                            
                        } else if (isSecondTargetLog) {
                            // Corrected ranges for the 5:00:50 AM log (2:24 new, 2:25-2:66 review, 2:67 new)
                            detailHTML += `<p class="text-sm text-gray-800">- <span class="font-medium text-blue-600">review:</span> 2:25 - 2:66</p>`;
                            detailHTML += `<p class="text-sm text-gray-800">- <span class="font-medium text-red-600">new:</span> 2:24, 2:67</p>`;

                        } else if (log.new_ranges || log.review_ranges) {
                            // NEW LOGIC: Use the stored fragmented ranges for future logs
                            
                            const formatRanges = (ranges) => {
                                if (!ranges || ranges.length === 0) return '';
                                return ranges.map(r => 
                                    (r.start_surah === r.end_surah && r.start_ayah === r.end_ayah) ? // Single ayah
                                    `${r.start_surah}:${r.start_ayah}` : 
                                    `${r.start_surah}:${r.start_ayah} - ${r.end_surah}:${r.end_ayah}`
                                ).join(', ');
                            };

                            if (log.review_ranges && log.review_ranges.length > 0) {
                                detailHTML += `<p class="text-sm text-gray-800">- <span class="font-medium text-blue-600">review:</span> ${formatRanges(log.review_ranges)}</p>`;
                            }
                            if (log.new_ranges && log.new_ranges.length > 0) {
                                detailHTML += `<p class="text-sm text-gray-800">- <span class="font-medium text-red-600">new:</span> ${formatRanges(log.new_ranges)}</p>`;
                            }

                        } else if (log.new_ayahs > 0 || log.review_ayahs > 0) {
                            // FALLBACK: Original logic for simple sequential split (for older, simpler logs that weren't manually overridden)
                            
                            let newRangeHtml = '';
                            let reviewRangeHtml = '';

                            if (log.review_ayahs > 0 && log.new_ayahs > 0) {
                                // Calculate the end point of the review section using the count
                                const [reviewEndSurah, reviewEndAyah] = getAyahAtOffset(log.start_surah, log.start_ayah, log.review_ayahs);
                                
                                // The start of the new section is the next sequential ayah after the review ends
                                const [newStartSurah, newStartAyah] = app.getNextSequentialAyah(reviewEndSurah, reviewEndAyah);
                                
                                reviewRangeHtml = `${log.start_surah}:${log.start_ayah} - ${reviewEndSurah}:${reviewEndAyah}`;
                                newRangeHtml = `${newStartSurah}:${newStartAyah} - ${log.end_surah}:${log.end_ayah}`;

                            } else if (log.new_ayahs > 0) {
                                newRangeHtml = totalRange;
                            } else if (log.review_ayahs > 0) {
                                reviewRangeHtml = totalRange;
                            }

                            if (reviewRangeHtml) {
                                detailHTML += `<p class="text-sm text-gray-800">- <span class="font-medium text-blue-600">review:</span> ${reviewRangeHtml}</p>`;
                            }
                            if (newRangeHtml) {
                                detailHTML += `<p class="text-sm text-gray-800">- <span class="font-medium text-red-600">new:</span> ${newRangeHtml}</p>`;
                            }
                        }
                    }
        
        // The main log item container
        const logItem = document.createElement('div');
        logItem.className = 'p-3 rounded-lg shadow-sm border border-gray-200 ' + badgeClass;
        logItem.innerHTML = `
            <p class="font-bold text-sm text-gray-800">${log.stage} (${date})</p>
            ${detailHTML}
            ${log.notes.length > 0 ? `<p class="text-xs italic mt-2 text-gray-600">${this.sanitize(log.notes)}</p>` : ''}
        `;
        historyDiv.appendChild(logItem);
    });
},

            // --- UI FLOW AND HELPERS ---
            showStudentListView: function() {
                document.getElementById('student-list-view').classList.remove('hidden');
                document.getElementById('student-detail-view').classList.add('hidden');
                this.state.currentStudent = null;
                if (this.logUnsubscribe) this.logUnsubscribe();
            },

            showStudentDetailView: function(student) {
                this.state.currentStudent = student;
                document.getElementById('student-list-view').classList.add('hidden');
                document.getElementById('student-detail-view').classList.remove('hidden');
                this.renderStudentDetails(student);
            },

            updateDynamicForm: function() {
                const student = this.state.currentStudent;
                if (!student) return;

                const dynamicInputs = document.getElementById('dynamic-inputs');
                dynamicInputs.innerHTML = '';
                const commonNotes = document.getElementById('notes');
                const commonNotesLabel = document.querySelector('label[for="notes"]');
                const commonRating = document.getElementById('fluency-rating');

                commonNotes.required = false; // Always make notes optional
                commonNotesLabel.textContent = `Notes/Comment (Max 500 characters)`;
                commonRating.required = false; // Rating is not required (and is hidden/defaulted)

                // --- Auto-Fill Logic (Persistence Logic) ---
                let nextStart = null;
                if (this.state.userPrefs.autoFillNext) {
                    const lastLog = this.state.logs.find(log => log.stage === student.stage && log.end_surah && log.end_ayah);
                    if (lastLog) {
                        nextStart = this.getNextSequentialAyah(lastLog.end_surah, lastLog.end_ayah);
                    }
                }
                const [nextSurah = 1, nextAyah = 1] = nextStart || [];

                // --- Stage-Specific Form Rendering ---
                if (student.stage === 'Qaida') {
                    dynamicInputs.innerHTML = this.renderQaidaForm(student);
                } else if (student.stage === 'Sifarah' || student.stage === 'Quran Reading') {
                    dynamicInputs.innerHTML = this.renderSurahForm(
                        student.stage,
                        student.stage === 'Sifarah' ? SIFARAH_START : 1, // Start Surah range
                        student.stage === 'Sifarah' ? SIFARAH_END : 114, // End Surah range
                        nextSurah, nextAyah
                    );
                } else if (student.stage === 'Hifz') {
                    dynamicInputs.innerHTML = this.renderHifzForm(nextSurah, nextAyah);
                }
                
                // --- Post-Render Ayah Population ---
                // Manually trigger Ayah population for start range if a Surah is pre-selected
                if (nextSurah && document.getElementById('start-surah')) {
                    this.updateAyahOptions('start-surah', 'start-ayah', nextAyah);
                }
            },

            // --- FORM RENDER HELPERS ---
            renderQaidaForm: function(student) {
                let options = '';
                for (let i = 1; i <= QAIDA_LESSON_COUNT; i++) {
                    const status = student.qaida_finished?.[i] ? ' - FINISHED' : (student.qaida_review_count?.[i] > 0 ? ' - IN REVIEW' : '');
                    options += `<option value="${i}">Lesson ${i}${status}</option>`;
                }
                return `
                    <div>
                        <label for="qaida-lesson" class="block text-sm font-medium text-gray-700">Qaida Lesson Number (1 to ${QAIDA_LESSON_COUNT})</label>
                        <select id="qaida-lesson" name="qaida-lesson" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                            <option value="">Select Lesson</option>
                            ${options}
                        </select>
                    </div>
                `;
            },

            renderSurahForm: function(stageName, startSurahRange, endSurahRange, autoFillStartSurah, autoFillStartAyah) {
                const surahOptions = (selected) => {
                    let options = '<option value="">Select Surah</option>';
                    for (let i = startSurahRange; i <= endSurahRange; i++) {
                        const surahName = SURAH_NAMES[i - 1] || `Surah ${i}`;
                        const selectedAttr = selected === i ? 'selected' : '';
                        options += `<option value="${i}" ${selectedAttr}>${i}. ${surahName}</option>`;
                    }
                    return options;
                };

                const hifzRecitationType = '<input type="hidden" name="recitation-type" id="recitation-type" value="N/A">';

                // If auto-fill is active, populate the start Ayah dropdown with all options for the Surah, marking the specific Ayah as selected
                const startAyahOptions = this.getAyahOptions(autoFillStartSurah, autoFillStartAyah);

                return `
                    ${hifzRecitationType}
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="start-surah" class="block text-sm font-medium text-gray-700">Start Surah</label>
                            <select id="start-surah" name="start-surah" required onchange="app.updateAyahOptions('start-surah', 'start-ayah')" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                                ${surahOptions(autoFillStartSurah)}
                            </select>
                        </div>
                        <div>
                            <label for="start-ayah" class="block text-sm font-medium text-gray-700">Start Ayah</label>
                            <select id="start-ayah" name="start-ayah" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                                ${startAyahOptions}
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="end-surah" class="block text-sm font-medium text-gray-700">End Surah</label>
                            <select id="end-surah" name="end-surah" required onchange="app.updateAyahOptions('end-surah', 'end-ayah')" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                                ${surahOptions()}
                            </select>
                        </div>
                        <div>
                            <label for="end-ayah" class="block text-sm font-medium text-gray-700">End Ayah</label>
                            <select id="end-ayah" name="end-ayah" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                                <option value="">Select End Ayah</option>
                            </select>
                        </div>
                    </div>
                `;
            },

            renderHifzForm: function(nextSurah, nextAyah) {
                return this.renderSurahForm('Hifz', 1, 114, nextSurah, nextAyah);
            },

            // --- DATA UTILITIES AND VALIDATION ---
            getAyahCount: function(surah) {
                return AYAH_MAP[surah] || 0;
            },

            // NEW: Utility function to generate Ayah options HTML
            getAyahOptions: function(surah, selectedAyah) {
                const count = this.getAyahCount(surah);
                let options = '<option value="">Select Ayah</option>';
                if (!surah || isNaN(surah) || count === 0) return options;

                for (let i = 1; i <= count; i++) {
                    const selectedAttr = (selectedAyah && selectedAyah === i) ? 'selected' : '';
                    options += `<option value="${i}" ${selectedAttr}>${i}</option>`;
                }
                return options;
            },

            validateSurahAyah: function(surah, ayah) {
                const s = parseInt(surah);
                const a = parseInt(ayah);
                if (isNaN(s) || s < 1 || s > 114) return false;
                if (isNaN(a) || a < 1 || a > this.getAyahCount(s)) return false;
                return true;
            },

            isRangeValid: function(s1, a1, s2, a2) {
                if (s1 < s2) return true;
                if (s1 === s2 && a1 <= a2) return true;
                return false;
            },

            ayahRangeToKey: function(surah, ayah) {
                return `S${surah}A${ayah}`;
            },

            ayahKeyToRange: function(key) {
                const match = key.match(/S(\d+)A(\d+)/);
                return match ? { surah: parseInt(match[1]), ayah: parseInt(match[2]) } : null;
            },
            
            

            getNextSequentialAyah: function(surah, ayah) {
                let nextAyah = ayah + 1;
                let nextSurah = surah;

                if (nextAyah > this.getAyahCount(surah)) {
                    nextSurah++;
                    nextAyah = 1;
                    if (nextSurah > 114) return [1, 1]; // Loop back to start
                }
                return [nextSurah, nextAyah];
            },

            calculateAyahCount: function(ranges) {
                let totalAyahs = 0;
                for (const range of ranges) {
                    // Start and end key calculation is a hack, need to count by iteration
                    // This function is only used for UI display, so using an iterative approach here is safer
                    let currentSurah = range.start_surah;
                    let currentAyah = range.start_ayah;

                    while (currentSurah < range.end_surah || (currentSurah === range.end_surah && currentAyah <= range.end_ayah)) {
                        totalAyahs++;
                        [currentSurah, currentAyah] = this.getNextSequentialAyah(currentSurah, currentAyah);
                    }
                }
                return totalAyahs;
            },

            // Updates Ayah dropdown options based on selected Surah
            updateAyahOptions: function(surahSelectId, ayahSelectId, selectedAyah = null) {
                const surahSelect = document.getElementById(surahSelectId);
                const ayahSelect = document.getElementById(ayahSelectId);
                const surah = parseInt(surahSelect.value);

                // Use the new utility function to populate the dropdown
                ayahSelect.innerHTML = this.getAyahOptions(surah, selectedAyah);
            },

            // --- STUDENT CRUD LOGIC (Non-Transactional) ---
            showAddStudentModal: function() {
                this.state.isEditMode = false;
                this.state.studentToEditId = null;
                document.getElementById('student-modal-title').textContent = 'Add New Student';
                document.getElementById('student-modal-btn').textContent = 'Add Student';
                document.getElementById('student-name-input').value = '';
                document.getElementById('student-stage-input').value = 'Qaida';
                document.getElementById('student-modal-error').textContent = '';
                document.getElementById('target-date-input').value = '';
                
                // Populate department dropdown
                const deptSelect = document.getElementById('student-department-input');
                deptSelect.innerHTML = '';
                Object.keys(CLASS_DEFINITIONS).forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    deptSelect.appendChild(option);
                });
                deptSelect.value = selectedDepartment;
                
                document.getElementById('student-modal').classList.remove('hidden');
            },

            showEditStudentModal: function(student) {
                this.state.isEditMode = true;
                this.state.studentToEditId = student.id;
                document.getElementById('student-modal-title').textContent = 'Edit Student';
                document.getElementById('student-modal-btn').textContent = 'Save Changes';
                document.getElementById('student-name-input').value = student.name;
                document.getElementById('student-gender-input').value = student.gender || 'Female';
                document.getElementById('student-stage-input').value = student.stage;
                document.getElementById('target-date-input').value = student.targetCompletionDate || '';
                document.getElementById('student-modal-error').textContent = '';
                
                // Populate department dropdown
                const deptSelect = document.getElementById('student-department-input');
                deptSelect.innerHTML = '';
                Object.keys(CLASS_DEFINITIONS).forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    deptSelect.appendChild(option);
                });
                deptSelect.value = student.department || 'Weekend';
                
                document.getElementById('student-modal').classList.remove('hidden');
            },

            handleStudentSave: async function(event) {
                event.preventDefault();
                const form = document.getElementById('student-form');
                const btn = document.getElementById('student-modal-btn');
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = this.state.isEditMode ? 'Saving...' : 'Adding...';
                document.getElementById('student-modal-error').textContent = '';

                const name = document.getElementById('student-name-input').value.trim();
                const gender = document.getElementById('student-gender-input').value; // NEW
                const department = document.getElementById('student-department-input').value;
                const stage = document.getElementById('student-stage-input').value;
                const targetCompletionDate = document.getElementById('target-date-input').value || null;

                if (!name || name.length > 100) {
        document.getElementById('student-modal-error').textContent = 'Name is required and must be under 100 characters.';
        btn.disabled = false;
        btn.textContent = originalText;
        return;
    }

    // Check for duplicate name (case-insensitive)
    const isDuplicate = this.state.students.some(student => {
        const isSameStudent = this.state.isEditMode && student.id === this.state.studentToEditId;
        return !isSameStudent && student.name.toLowerCase() === name.toLowerCase();
    });

    if (isDuplicate) {
        document.getElementById('student-modal-error').textContent = 'A student with this name already exists.';
        btn.disabled = false;
        btn.textContent = originalText;
        return;
    }

    try {
        const data = {
                        name: this.sanitize(name),
                        gender: gender,
                        department: department,
                        stage: stage,
                        sifarah_completed_ayahs: 0,
                        qaida_review_count: {},
                        qaida_first_review_date: {},
                        qaida_finished: {},
                        hifz_coverage: {},
                        reading_coverage: {},
                        hifz_inventory: [],
                        targetCompletionDate: targetCompletionDate,
                    };

                    if (this.state.isEditMode) {
                        // Update existing student (only name, stage, gender, department, and target date are user-editable here)
                        const studentDocRef = doc(db, `artifacts/${APP_ID}/public/data/students`, this.state.studentToEditId);
                        await updateDoc(studentDocRef, {
                            name: this.sanitize(name),
                            gender: gender,
                            department: department,
                            stage: stage,
                            targetCompletionDate: targetCompletionDate,
                        });
                    } else {
                        // Create new student
                        await addDoc(collection(db, `artifacts/${APP_ID}/public/data/students`), data);
                    }
                    this.closeModal('student-modal');
                } catch (error) {
                    console.error("Student save error:", error);
                    document.getElementById('student-modal-error').textContent = `Failed to save: ${error.message}`;
                } finally {
                    btn.disabled = false;
                    btn.textContent = originalText;
                }
            },

            showDeleteStudentModal: function(student) {
                this.state.studentToDeleteId = student.id;
                document.getElementById('delete-modal-text').innerHTML = `Are you sure you want to permanently delete the student <strong>${this.sanitize(student.name)}</strong> and all associated logs? This action cannot be undone.`;
                document.getElementById('delete-modal-error').textContent = '';
                document.getElementById('delete-modal').classList.remove('hidden');
            },

            handleStudentDelete: async function() {
                const studentId = this.state.studentToDeleteId;
                if (!studentId) return;

                document.getElementById('delete-modal-error').textContent = 'Deleting...';
                try {
                    // 1. Delete student document
                    const studentDocRef = doc(db, `artifacts/${APP_ID}/public/data/students`, studentId);
                    await deleteDoc(studentDocRef);

                    // 2. Delete all associated logs (NOTE: This is not transactional with the student delete, but done best-effort)
                    const logsRef = collection(db, `artifacts/${APP_ID}/public/data/logs`);
                    const q = query(logsRef, where("studentId", "==", studentId));
                    const logsSnapshot = await getDocs(q);
                    const batch = writeBatch(db); // Use batch for logs delete

                    logsSnapshot.docs.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();

                    this.closeModal('delete-modal');
                    this.showStudentListView(); // Go back to list
                } catch (error) {
                    console.error("Student delete error:", error);
                    document.getElementById('delete-modal-error').textContent = `Failed to delete: ${error.message}`;
                }
            },

            // --- SEARCH AND MODAL HELPERS ---
            handleSearch: function(text) {
                this.state.filterText = text;
                // Clear active stage/gender filter when user starts searching
                if (text) {
                    this.state.currentGenderFilter = null;
                    this.state.currentStageFilter = null;
                    document.querySelector('h2.text-2xl').textContent = 'Students';
                }
                this.renderStudentList();
            },

            closeModal: function(modalId) {
                document.getElementById(modalId).classList.add('hidden');
                // Clean up state if necessary
                if (modalId === 'delete-modal') this.state.studentToDeleteId = null;
            },

            sanitize: function(html) {
                const div = document.createElement('div');
                div.textContent = html;
                return div.innerHTML;
            },

            saveUserPreference: function(key, value) {
                this.state.userPrefs[key] = value;
                localStorage.setItem(key, value);
            },

            // --- CORE LOGGING TRANSACTION ---
            handleLogSubmission: async function(event) {
                event.preventDefault();
                const form = event.target;
                const student = this.state.currentStudent;
                const messageDiv = document.getElementById('log-message');
                const submitBtn = document.getElementById('submit-log-btn');
                submitBtn.disabled = true;
                messageDiv.textContent = 'Processing log...';
                messageDiv.className = 'mt-3 text-sm font-medium text-gray-500';

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                // --- 1. Client-Side Validation ---
                try {
                    this.validateLogData(student, data);
                } catch (error) {
                    messageDiv.textContent = `Validation Error: ${error.message}`;
                    messageDiv.className = 'mt-3 text-sm font-medium text-red-600';
                    submitBtn.disabled = false;
                    return;
                }

                // --- 2. Run Firestore Transaction ---
try {
    const logsCollectionRef = collection(db, `artifacts/${APP_ID}/public/data/logs`);
    const newLogDocRef = doc(logsCollectionRef); // Pre-generate a new document reference ID

    await runTransaction(db, async (transaction) => {
                        const studentRef = doc(db, `artifacts/${APP_ID}/public/data/students`, student.id);
                        const studentDoc = await transaction.get(studentRef);

                        if (!studentDoc.exists()) {
                            throw new Error("Student document not found during transaction.");
                        }

                        let studentData = studentDoc.data();
                        let newLogData = {
                            studentId: student.id,
                            stage: student.stage,
                            fluency_rating: parseInt(data['fluency-rating']),
                            notes: this.sanitize(data.notes || ''),
                            timestamp: serverTimestamp(),
                            new_ayahs: 0,
                            review_ayahs: 0,
                            recitation_type: data['recitation-type'] || null,
                        };

                        // --- 2.1 Stage-Specific Transaction Logic (Qaida, Sifarah, Quran, Hifz) ---
                        if (student.stage === 'Qaida') {
                            const lesson = parseInt(data['qaida-lesson']);
                            newLogData.start_surah = lesson; // Using surah field to store lesson number
                            newLogData.end_surah = lesson;

                            // Qaida Automation
                            const currentReviews = studentData.qaida_review_count?.[lesson] || 0;
                            const firstReviewDate = studentData.qaida_first_review_date?.[lesson]?.toDate();
                            const isFinished = studentData.qaida_finished?.[lesson] === true;

                            if (currentReviews === 0) {
                                newLogData.type = 'New';
                                newLogData.notes = `New start on Lesson ${lesson}. ` + newLogData.notes;
                                // Subsequent logs are 'Review'
                                studentData.qaida_review_count = { ...studentData.qaida_review_count, [lesson]: 1 };
                                studentData.qaida_first_review_date = { ...studentData.qaida_first_review_date, [lesson]: serverTimestamp() };
                            } else if (isFinished) {
                                newLogData.type = 'Review';
                            } else {
                                // Check for 'Finished' condition (N times review, 3 distinct days)
                                const isNthReview = currentReviews + 1 >= N_REVIEW_TIMES;

                                if (isNthReview && firstReviewDate) {
                                    const today = new Date();
                                    const diffTime = today.getTime() - firstReviewDate.getTime();
                                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                                    // Check for 3 distinct UTC calendar dates from the first review log date
                                    if (diffDays >= 3) {
                                        newLogData.type = 'Finished';
                                        studentData.qaida_finished = { ...studentData.qaida_finished, [lesson]: true };
                                        // Auto-transition Qaida -> Sifarah
                                        if (lesson === QAIDA_LESSON_COUNT) {
                                            const allFinished = Array.from({ length: QAIDA_LESSON_COUNT }, (_, i) => i + 1)
                                                .every(l => studentData.qaida_finished?.[l]);
                                            if (allFinished) {
                                                studentData.stage = 'Sifarah';
                                            }
                                        }
                                    } else {
                                        newLogData.type = 'Review';
                                    }
                                } else {
                                    newLogData.type = 'Review';
                                }

                                if (newLogData.type !== 'Finished') {
                                    studentData.qaida_review_count = { ...studentData.qaida_review_count, [lesson]: currentReviews + 1 };
                                }
                            }

                        } else { // Sifarah, Quran Reading, Hifz
                            newLogData.start_surah = parseInt(data['start-surah']);
                            newLogData.start_ayah = parseInt(data['start-ayah']);
                            newLogData.end_surah = parseInt(data['end-surah']);
                            newLogData.end_ayah = parseInt(data['end-ayah']);

                            // --- Range Overlap Detection & Breakdown ---
                            const { newAyahs, reviewAyahs, coverageUpdates, newRanges, reviewRanges } = this.calculateLogBreakdown(
                                studentData,
                                newLogData.start_surah, newLogData.start_ayah,
                                newLogData.end_surah, newLogData.end_ayah,
                                newLogData.fluency_rating
                            );

                            newLogData.new_ayahs = newAyahs;
                            newLogData.review_ayahs = reviewAyahs;
                            // NEW: Store the calculated, non-sequential ranges for accurate history rendering
                            newLogData.new_ranges = newRanges; 
                            newLogData.review_ranges = reviewRanges;

                            // --- Coverage Map Update (Stage-Specific) ---
if (newLogData.stage === 'Hifz') {
    studentData.hifz_coverage = { ...(studentData.hifz_coverage || {}), ...coverageUpdates };
} else if (newLogData.stage === 'Quran Reading' || newLogData.stage === 'Sifarah') {
    studentData.reading_coverage = { ...(studentData.reading_coverage || {}), ...coverageUpdates };
}
                            // --- Sifarah Counter Update (Atomic) ---
                            if (newLogData.new_ayahs > 0 && newLogData.start_surah >= SIFARAH_START && newLogData.end_surah <= SIFARAH_END) {
                                studentData.sifarah_completed_ayahs = (studentData.sifarah_completed_ayahs || 0) + newLogData.new_ayahs;
                            }

                            // --- Stage Transition Check (Sifarah -> Quran Reading) ---
                            if (student.stage === 'Sifarah') {
                                const newSifarahCount = studentData.sifarah_completed_ayahs;
                                if (newSifarahCount >= TOTAL_SIFARAH_AYAHS) {
                                    studentData.stage = 'Quran Reading';
                                }
                            }
                        }

                        // --- 3. Final Commit ---
                        // Update student document
                        transaction.update(studentRef, studentData);

                        // --- 3. Final Commit ---
                        // Update student document
                        transaction.update(studentRef, studentData);

                        // Write new log document using the pre-generated reference
                        transaction.set(newLogDocRef, newLogData);
                    });

                    messageDiv.textContent = 'Log submitted successfully!';
                    messageDiv.className = 'mt-3 text-sm font-medium text-green-600';
                    form.reset(); // Clear form on success
                    document.getElementById('notes').required = student.stage !== 'Qaida'; // Reset required state
                    this.state.currentStudent.stage = student.stage; // Keep current stage (or update if transitioned)
                    // The onSnapshot listeners will update the UI automatically.

                } catch (error) {
                    console.error("Log Transaction Failed:", error);
                    messageDiv.textContent = `Transaction Failed: ${error.message}`;
                    messageDiv.className = 'mt-3 text-sm font-medium text-red-600';
                } finally {
                    submitBtn.disabled = false;
                }
            },

            validateLogData: function(student, data) {
                if (student.stage === 'Qaida') {
                    const lesson = parseInt(data['qaida-lesson']);
                    if (isNaN(lesson) || lesson < 1 || lesson > QAIDA_LESSON_COUNT) {
                        throw new Error(`Invalid Qaida lesson number. Must be 1 to ${QAIDA_LESSON_COUNT}.`);
                    }
                } else { // Sifarah, Quran Reading, Hifz
                    const sSurah = parseInt(data['start-surah']);
                    const sAyah = parseInt(data['start-ayah']);
                    const eSurah = parseInt(data['end-surah']);
                    const eAyah = parseInt(data['end-ayah']);
                    const notes = data.notes || '';
                    const rating = parseInt(data['fluency-rating']);

                    if (notes.length > 500) {
                        throw new Error("Notes/Comment must be under 500 characters.");
                    }
                    if (!this.validateSurahAyah(sSurah, sAyah)) {
                        throw new Error(`Invalid Start Surah/Ayah: ${sSurah}:${sAyah}`);
                    }
                    if (!this.validateSurahAyah(eSurah, eAyah)) {
                        throw new Error(`Invalid End Surah/Ayah: ${eSurah}:${eAyah}`);
                    }
                    if (!this.isRangeValid(sSurah, sAyah, eSurah, eAyah)) {
                        throw new Error("Start of recitation must be before or the same as the End of recitation.");
                    }

                    // Stage-specific range checks
                    if (student.stage === 'Sifarah' && (sSurah < SIFARAH_START || eSurah > SIFARAH_END)) {
                        throw new Error(`Sifarah stage must only log Surahs ${SIFARAH_START} to ${SIFARAH_END}.`);
                    }

                    if (student.stage === 'Hifz' && !data['recitation-type']) {
                        throw new Error("Recitation Type is required for Hifz stage.");
                    }
                }
            },

            // Replace with the following code:
            calculateLogBreakdown: function(studentData, sSurah, sAyah, eSurah, eAyah, rating) {
                let newAyahs = 0;
                let reviewAyahs = 0;
                let coverageUpdates = {};
                
                // NEW: Arrays to store the fragmented ranges
                let newRanges = [];
                let reviewRanges = [];
                
                // Helper to add/update ranges
                const updateRanges = (type, currentSurah, currentAyah) => {
                    const targetArray = type === 'new' ? newRanges : reviewRanges;

                    // If the last range in the array is contiguous with the current ayah, extend it
                    const lastRange = targetArray[targetArray.length - 1];
                    
                    if (lastRange) {
                        // Check if the current Ayah is the sequential next after the last range's end point
                        const [expectedSurah, expectedAyah] = this.getNextSequentialAyah(lastRange.end_surah, lastRange.end_ayah);
                        
                        if (currentSurah === expectedSurah && currentAyah === expectedAyah) {
                            // Contiguous, so extend the last range
                            lastRange.end_surah = currentSurah;
                            lastRange.end_ayah = currentAyah;
                            return; // Range extended, no new push
                        }
                    } 
                    
                    // Not contiguous or no existing range, push the current ayah as a new range (start=end)
                    targetArray.push({ start_surah: currentSurah, start_ayah: currentAyah, end_surah: currentSurah, end_ayah: currentAyah });
                };


                // Determine which coverage map to use based on the stage when the log was created
                let coverageMap;
                if (studentData.stage === 'Hifz') {
                    coverageMap = studentData.hifz_coverage || {};
                } else if (studentData.stage === 'Quran Reading' || studentData.stage === 'Sifarah') {
                    coverageMap = studentData.reading_coverage || {};
                } else {
                    coverageMap = {}; // Qaida
                }
                const currentCoverage = coverageMap;
                const currentStage = studentData.stage;

                // Sifarah Review Override
                const isSifarahReviewOverride = (currentStage === 'Quran Reading' || currentStage === 'Hifz') &&
                                                sSurah >= SIFARAH_START && eSurah <= SIFARAH_END;

                let currentSurah = sSurah;
                let currentAyah = sAyah;

                // Iterative Ayah processing using correct bounded loop condition
                while (currentSurah < eSurah || (currentSurah === eSurah && currentAyah <= eAyah)) {
                    const ayahKey = this.ayahRangeToKey(currentSurah, currentAyah);
                    const maxRating = currentCoverage[ayahKey] || 0;

                    if (isSifarahReviewOverride) {
                        reviewAyahs++;
                        updateRanges('review', currentSurah, currentAyah);
                    } else {
                        // Determine if this Ayah is "New" (has never been logged/covered before)
                        const isNewAyah = maxRating === 0;

                        if (isNewAyah) {
                            coverageUpdates[ayahKey] = 5; // Set coverage to 5 (Mastered)
                            newAyahs++;
                            updateRanges('new', currentSurah, currentAyah);
                        } else {
                            // Ayah has been logged before, so it is a REVIEW.
                            if (5 > maxRating) {
                                coverageUpdates[ayahKey] = 5;
                            }
                            reviewAyahs++;
                            updateRanges('review', currentSurah, currentAyah);
                        }
                    }

                    // Move to the next ayah
                    [currentSurah, currentAyah] = this.getNextSequentialAyah(currentSurah, currentAyah);

                    // Safety break
                    if (currentSurah > 114) break;
                }
                
                // If override was active, coverageUpdates remains {}, newAyahs = 0, reviewAyahs = totalAyahsInRange
                if (isSifarahReviewOverride) {
                    return { newAyahs: 0, reviewAyahs: reviewAyahs, coverageUpdates: {}, newRanges, reviewRanges };
                }

                // Return the calculated values and the new fragmented ranges
                return { newAyahs, reviewAyahs, coverageUpdates, newRanges, reviewRanges };
            },

            // --- HIFZ SPECIFIC LOGIC ---
showHifzBulkImportModal: function() {
    this.state.isHifzImportActive = true;
    const student = this.state.currentStudent;
    
    // Format existing inventory ranges for display
    const existingInventory = student.hifz_inventory || [];
    const rangesText = existingInventory.map(r => `${r.start_surah}:${r.start_ayah}-${r.end_surah}:${r.end_ayah}`).join('\n');
    
    // Calculate and display existing inventory count
    const ayahCount = this.calculateAyahCount(existingInventory);

    // 1. Populate the existing inventory section
    const existingDiv = document.getElementById('existing-hifz-inventory');
    existingDiv.textContent = rangesText.length > 0 ? rangesText : 'No existing inventory recorded.';
    document.getElementById('existing-inventory-count').textContent = ayahCount;

    // 2. Clear the input area for new ranges
    document.getElementById('hifz-ranges-input').value = '';
    
    // 3. Reset status and show modal
    document.getElementById('hifz-import-status').textContent = '';
    document.getElementById('hifz-import-modal').classList.remove('hidden');
},

            handleHifzBulkImport: async function() {
                const student = this.state.currentStudent;
                const statusDiv = document.getElementById('hifz-import-status');
                const rangesInput = document.getElementById('hifz-ranges-input').value;
                statusDiv.textContent = 'Processing...';
                statusDiv.className = 'mt-3 text-sm font-medium text-gray-500';

                if (!student || student.stage !== 'Hifz') {
                    statusDiv.textContent = 'Error: Not in Hifz stage or no student selected.';
                    statusDiv.className = 'mt-3 text-sm font-medium text-red-600';
                    return;
                }

                const lines = rangesInput.split('\n').map(line => line.trim()).filter(line => line.length > 0);
                let validRanges = [];
                let failedRanges = [];

                // Get existing inventory (ranges previously bulk imported)
                const existingInventory = student.hifz_inventory || [];
                // Get existing coverage (verses marked as learned in daily logs)
                const existingCoverage = student.hifz_coverage || {};

                for (const line of lines) {
                    const match = line.match(/^(\d+):(\d+)-(\d+):(\d+)$/);
                    if (!match) {
                        failedRanges.push(`Format error: ${line}`);
                        continue;
                    }

                    const s1 = parseInt(match[1]);
                    const a1 = parseInt(match[2]);
                    const s2 = parseInt(match[3]);
                    const a2 = parseInt(match[4]);

                    if (!this.validateSurahAyah(s1, a1) || !this.validateSurahAyah(s2, a2) || !this.isRangeValid(s1, a1, s2, a2)) {
                        failedRanges.push(`Invalid Ayah range or Surah count: ${line}`);
                        continue;
                    }
                    
                    // -----------------------------------------------------------------
                    // NEW CHECK: Overlap with Verses already covered by DAILY LOGS
                    // -----------------------------------------------------------------
                    let currentSurah = s1;
                    let currentAyah = a1;
                    let isCoveredByLog = false;
                    let overlapAyah = '';

                    // Iterate over every ayah in the proposed bulk range
                    while (currentSurah < s2 || (currentSurah === s2 && currentAyah <= a2)) {
                        const ayahKey = this.ayahRangeToKey(currentSurah, currentAyah);
                        
                        // Check if the ayah exists in the existing coverage map (meaning it was logged)
                        if (existingCoverage[ayahKey]) {
                            isCoveredByLog = true;
                            overlapAyah = `${currentSurah}:${currentAyah}`;
                            break; 
                        }
                        
                        [currentSurah, currentAyah] = this.getNextSequentialAyah(currentSurah, currentAyah);

                        // Safety break
                        if (currentSurah > 114) break;
                    }

                    if (isCoveredByLog) {
                        failedRanges.push(`Overlap detected with verse ${overlapAyah}. This verse was already learned in a daily session and cannot be bulk imported.`);
                        continue; // Skip the rest of the checks for this range
                    }
                    // -----------------------------------------------------------------


                    // Old Check: Overlap with approved ranges (existing inventory from previous bulk imports)
                    const isOverlapping = existingInventory.some(existing => this.checkOverlap({ start_surah: s1, start_ayah: a1, end_surah: s2, end_ayah: a2 }, existing));
                    
                    // Old Check: Overlap with other valid ranges in the current batch
                    const isBatchOverlapping = validRanges.some(valid => this.checkOverlap({ start_surah: s1, start_ayah: a1, end_surah: s2, end_ayah: a2 }, valid));

                    if (isOverlapping || isBatchOverlapping) {
                        failedRanges.push(`Overlap detected and rejected: ${line}`);
                    } else {
                        validRanges.push({ start_surah: s1, start_ayah: a1, end_surah: s2, end_ayah: a2 });
                    }
                } // End of range parsing loop

                // --- 3. Process & Save Valid Ranges to Student Document ---

                if (failedRanges.length > 0) {
                    statusDiv.innerHTML = `
                        <p class="text-red-600 font-bold">Import failed for ${failedRanges.length} ranges. Fix and resubmit:</p>
                        <ul class="list-disc list-inside mt-2 text-xs text-red-500 max-h-40 overflow-y-auto">
                            ${failedRanges.map(f => `<li>${this.sanitize(f)}</li>`).join('')}
                        </ul>
                    `;
                    statusDiv.className = 'mt-3 text-sm font-medium text-red-600';
                    return;
                }
                
                if (validRanges.length > 0) {
                    try {
                        
                        let coverageUpdates = {};
                        for (const range of validRanges) {
                            let currentSurah = range.start_surah;
                            let currentAyah = range.start_ayah;
                            
                            while (currentSurah < range.end_surah || (currentSurah === range.end_surah && currentAyah <= range.end_ayah)) {
                                const ayahKey = this.ayahRangeToKey(currentSurah, currentAyah);
                                coverageUpdates[ayahKey] = 5; 
                                
                                [currentSurah, currentAyah] = this.getNextSequentialAyah(currentSurah, currentAyah);
                            }
                        }
                        
                        const studentRef = doc(db, `artifacts/${APP_ID}/public/data/students`, student.id);
                        
                        await updateDoc(studentRef, {
                            // Merge the new ranges with the existing inventory
                            hifz_inventory: [...existingInventory, ...validRanges], 
                            // Merge the new coverage map with the existing coverage map
                            hifz_coverage: { 
                                ...(existingCoverage), 
                                ...coverageUpdates 
                            }
                        });

                        statusDiv.textContent = `Successfully imported ${validRanges.length} valid ranges (${Object.keys(coverageUpdates).length} total ayahs added to inventory). Inventory and coverage updated.`;
                        statusDiv.className = 'mt-3 text-sm font-medium text-green-600';
                        this.closeModal('hifz-import-modal');

                    } catch (error) {
                        console.error("Hifz Bulk Import save error:", error);
                        statusDiv.textContent = `Failed to save inventory: ${error.message}`;
                        statusDiv.className = 'mt-3 text-sm font-medium text-red-600';
                    } finally {
                        this.state.isHifzImportActive = false;
                    }
                } else {
                    statusDiv.textContent = 'No valid, non-overlapping ranges were entered.';
                    statusDiv.className = 'mt-3 text-sm font-medium text-red-600';
                }
            },
            
            calculateGoalPace: function(student) {
                const targetDateString = student.targetCompletionDate;
                if (!targetDateString) return null;

                const targetDate = new Date(targetDateString + 'T00:00:00'); // Ensure date is treated as midnight UTC for consistent day counting
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize today's date

                // Check if the target date is in the past
                if (targetDate <= today) return null;

                const timeDiff = targetDate.getTime() - today.getTime();
                const totalDays = Math.ceil(timeDiff / (1000 * 60 * 60 * 24)); // Total days including today

                let scopeCompleted, totalScope, unit;

                if (student.stage === 'Qaida') {
                    const completedLessons = Object.values(student.qaida_finished || {}).filter(f => f).length;
                    scopeCompleted = completedLessons;
                    totalScope = QAIDA_LESSON_COUNT;
                    unit = 'Lesson';
                } else if (student.stage === 'Sifarah') {
                    scopeCompleted = student.sifarah_completed_ayahs || 0;
                    totalScope = TOTAL_SIFARAH_AYAHS;
                    unit = 'Ayah';
                } else if (student.stage === 'Quran Reading' || student.stage === 'Hifz') {
                    // Calculate completed Ayahs based on coverage map
                    let coverageMap = student.stage === 'Hifz' ? student.hifz_coverage : student.reading_coverage;
                    const coveredAyahs = Object.keys(coverageMap || {}).length;
                    const inventoryAyahs = student.hifz_inventory ? this.calculateAyahCount(student.hifz_inventory) : 0;
                    
                    // For Hifz, we use the greater of covered/inventoried as the starting point, but only if it's less than the total scope
                    scopeCompleted = Math.min(TOTAL_QURAN_AYAHS, coveredAyahs + inventoryAyahs);
                    totalScope = TOTAL_QURAN_AYAHS;
                    unit = 'Ayah';
                } else {
                    return null;
                }

                const scopeRemaining = totalScope - scopeCompleted;
                if (scopeRemaining <= 0) return { daily: 0, weekly: 0, monthly: 0, yearly: 0, days: totalDays, unit: unit, isComplete: true };

                const dailyRate = scopeRemaining / totalDays;

                return {
                    daily: Math.max(1, Math.ceil(dailyRate)), // At least 1 unit/day if remaining
                    weekly: Math.ceil(dailyRate * 7),
                    monthly: Math.ceil(dailyRate * 30.4375), // Average days per month
                    yearly: Math.ceil(dailyRate * 365.25),
                    days: totalDays,
                    unit: unit,
                    isComplete: false,
                    scopeRemaining: scopeRemaining,
                    totalScope: totalScope
                };
            },

            checkOverlap: function(rangeA, rangeB) {
                // Returns true if rangeA and rangeB overlap
                // Represent ranges as single numbers for comparison: Surah*1000 + Ayah
                const aStart = rangeA.start_surah * 1000 + rangeA.start_ayah;
                const aEnd = rangeA.end_surah * 1000 + rangeA.end_ayah;
                const bStart = rangeB.start_surah * 1000 + rangeB.start_ayah;
                const bEnd = rangeB.end_surah * 1000 + rangeB.end_ayah;

                // Overlap occurs if A starts before B ends AND A ends after B starts
                return aStart <= bEnd && aEnd >= bStart;
            },

            calculateHifzPace: function(student) {
                if (student.stage !== 'Hifz' || this.state.logs.length === 0) return 0;

                const hifzLogs = this.state.logs.filter(log => log.stage === 'Hifz' && log.new_ayahs > 0);

                if (hifzLogs.length === 0) return 0;

                let totalNewAyahs = 0;
                let firstLogDate = hifzLogs[hifzLogs.length - 1].timestamp.toDate(); // Oldest log
                let lastLogDate = hifzLogs[0].timestamp.toDate(); // Newest log

                hifzLogs.forEach(log => {
                    totalNewAyahs += log.new_ayahs;
                });

                const timeDiff = lastLogDate.getTime() - firstLogDate.getTime();
                const dayDiff = timeDiff / (1000 * 3600 * 24);

                if (dayDiff < 1) return totalNewAyahs; // If only 1 day of logging, return total

                return (totalNewAyahs / dayDiff).toFixed(2);
            }
        };

        // --- DEPARTMENT AND CLASS MANAGEMENT FUNCTIONS ---
        
        // Load class definitions from Firebase
        async function loadClassDefinitions() {
            try {
                const classDefsDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'class_definitions', 'current');
                const docSnap = await getDoc(classDefsDocRef);
                
                if (docSnap.exists()) {
                    const firebaseData = docSnap.data();
                    CLASS_DEFINITIONS = { ...DEFAULT_CLASS_DEFINITIONS, ...firebaseData };
                    console.log('Class definitions loaded from Firebase');
                } else {
                    console.log('No class definitions in Firebase, using defaults');
                    CLASS_DEFINITIONS = DEFAULT_CLASS_DEFINITIONS;
                }
                
                updateDepartmentDropdown();
            } catch (error) {
                console.error('Error loading class definitions:', error);
                CLASS_DEFINITIONS = DEFAULT_CLASS_DEFINITIONS;
                updateDepartmentDropdown();
            }
        }
        
        // Save class definitions to Firebase
        async function saveClassDefinitions() {
            try {
                const classDefsDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'class_definitions', 'current');
                await setDoc(classDefsDocRef, CLASS_DEFINITIONS);
                console.log('‚úÖ Class definitions saved to Firebase');
            } catch (error) {
                console.error('‚ùå Error saving class definitions:', error);
            }
        }
        
        // Update department dropdown
        function updateDepartmentDropdown() {
            const dropdown = document.getElementById('header-dept-selector');
            if (!dropdown) return;
            
            const currentValue = dropdown.value;
            dropdown.innerHTML = '';
            
            Object.keys(CLASS_DEFINITIONS).forEach(deptName => {
                const option = document.createElement('option');
                option.value = deptName;
                option.textContent = deptName;
                dropdown.appendChild(option);
            });
            
            if (CLASS_DEFINITIONS[currentValue]) {
                dropdown.value = currentValue;
            } else if (CLASS_DEFINITIONS[selectedDepartment]) {
                dropdown.value = selectedDepartment;
            }
        }
        
        // Handle department change
        window.handleDepartmentChange = function(newDepartment) {
            selectedDepartment = newDepartment;
            localStorage.setItem('selectedDepartment', newDepartment);
            
            // Filter students by department
            app.state.students = app.state.allStudents.filter(s => 
                (s.department || 'Weekend') === selectedDepartment
            );
            app.renderStudentList();
            
            console.log('Department changed to:', newDepartment);
        };
        
        // Open manage classes modal
        window.openManageClassesModal = function() {
            document.getElementById('current-dept-display').textContent = selectedDepartment;
            renderCurrentClasses();
            document.getElementById('manage-classes-modal').classList.remove('hidden');
        };
        
        // Close manage classes modal
        window.closeManageClassesModal = function() {
            document.getElementById('manage-classes-modal').classList.add('hidden');
        };
        
        // Save and close manage classes modal
        window.saveAndCloseManageClassesModal = async function() {
            await saveClassDefinitions();
            closeManageClassesModal();
            showMessage('Success', 'Classes and departments saved successfully!');
        };
        
        // Render current classes
        function renderCurrentClasses() {
            const container = document.getElementById('current-classes-list');
            container.innerHTML = '';
            
            const currentClasses = CLASS_DEFINITIONS[selectedDepartment] || [];
            
            if (currentClasses.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 italic">No classes defined for this department.</p>';
                return;
            }
            
            currentClasses.forEach((cls, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 border border-gray-200 rounded-lg';
                
                const info = document.createElement('div');
                info.innerHTML = `
                    <span class="font-semibold text-gray-700">${cls.gender} - Class ${cls.name}</span>
                    <span class="text-xs text-gray-500 ml-2">(ID: ${selectedDepartment}-${cls.gender}-${cls.name})</span>
                `;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'text-red-500 hover:text-red-700 text-sm font-semibold';
                removeBtn.textContent = '‚úñ Remove';
                removeBtn.onclick = () => removeClass(index);
                
                div.appendChild(info);
                div.appendChild(removeBtn);
                container.appendChild(div);
            });
        }
        
        // Add new department
        window.addNewDepartment = function() {
            const name = document.getElementById('new-dept-name').value.trim();
            const abbr = document.getElementById('new-dept-abbr').value.trim();
            
            if (!name || !abbr) {
                showMessage('Error', 'Please enter both department name and abbreviation.');
                return;
            }
            
            if (CLASS_DEFINITIONS[name]) {
                showMessage('Error', 'This department already exists.');
                return;
            }
            
            CLASS_DEFINITIONS[name] = [];
            updateDepartmentDropdown();
            
            document.getElementById('new-dept-name').value = '';
            document.getElementById('new-dept-abbr').value = '';
            
            showMessage('Success', `Department "${name}" added!`);
        };
        
        // Add new class
        window.addNewClass = function() {
            const gender = document.getElementById('new-class-gender').value;
            const name = document.getElementById('new-class-name').value.trim();
            
            if (!name) {
                showMessage('Error', 'Please enter a class name.');
                return;
            }
            
            if (!CLASS_DEFINITIONS[selectedDepartment]) {
                CLASS_DEFINITIONS[selectedDepartment] = [];
            }
            
            const exists = CLASS_DEFINITIONS[selectedDepartment].some(
                cls => cls.gender === gender && cls.name === name
            );
            
            if (exists) {
                showMessage('Error', 'This class already exists in the current department.');
                return;
            }
            
            CLASS_DEFINITIONS[selectedDepartment].push({ gender, name });
            renderCurrentClasses();
            
            document.getElementById('new-class-name').value = '';
            showMessage('Success', `Class "${gender} - ${name}" added!`);
        };
        
        // Remove class
        function removeClass(index) {
            if (confirm('Are you sure you want to remove this class?')) {
                CLASS_DEFINITIONS[selectedDepartment].splice(index, 1);
                renderCurrentClasses();
                showMessage('Success', 'Class removed.');
            }
        }

        // Toggle student filters submenu
        window.toggleStudentFilters = function() {
            const submenu = document.getElementById('student-filters-submenu');
            const chevron = document.getElementById('filter-chevron');
            
            if (submenu.classList.contains('hidden')) {
                submenu.classList.remove('hidden');
                chevron.classList.add('rotate-180');
            } else {
                submenu.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        };

        // --- BULK UPLOAD FUNCTIONS ---
        
        let pendingStudents = [];
        
        // Show bulk upload modal
        window.showBulkUploadModal = function() {
            document.getElementById('bulk-upload-modal').classList.remove('hidden');
            document.getElementById('bulk-upload-department').value = selectedDepartment;
            document.getElementById('excel-file-input').value = '';
            document.getElementById('upload-preview').classList.add('hidden');
            document.getElementById('upload-status').classList.add('hidden');
            document.getElementById('confirm-upload-btn').disabled = true;
            pendingStudents = [];
        };
        
        // Close bulk upload modal
        window.closeBulkUploadModal = function() {
            document.getElementById('bulk-upload-modal').classList.add('hidden');
            pendingStudents = [];
        };
        
        // Download Excel template
        window.downloadTemplate = function() {
            const templateData = [
                {
                    'Name': 'Example Student',
                    'Gender': 'Male',
                    'Department': 'Weekend',
                    'Stage': 'Qaida',
                    'Target Completion Date': '2025-12-31'
                },
                {
                    'Name': 'Another Student',
                    'Gender': 'Female',
                    'Department': 'Evening',
                    'Stage': 'Hifz',
                    'Target Completion Date': '2026-06-30'
                }
            ];
            
            const ws = XLSX.utils.json_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Students');
            //
            // Add column widths
            ws['!cols'] = [
                { wch: 20 }, // Name
                { wch: 10 }, // Gender
                { wch: 15 }, // Department
                { wch: 15 }, // Stage
                { wch: 20 }  // Target Completion Date
            ];
            
            XLSX.writeFile(wb, 'student_upload_template.xlsx');
        };
        
        // Handle Excel file upload
        window.handleExcelUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (jsonData.length === 0) {
                        showUploadStatus('No data found in Excel file', 'error');
                        return;
                    }
                    
                    // Validate and prepare students
                    const department = document.getElementById('bulk-upload-department').value;
                    pendingStudents = [];
                    const errors = [];
                    const warnings = [];
                    
                    jsonData.forEach((row, index) => {
                        const rowNum = index + 2; // Excel row number (accounting for header)
                        
                        if (!row.Name || !row.Gender || !row.Stage) {
                            errors.push(`Row ${rowNum}: Missing required fields (Name, Gender, Stage)`);
                            return;
                        }
                        
                        if (!['Male', 'Female'].includes(row.Gender)) {
                            errors.push(`Row ${rowNum}: Gender must be 'Male' or 'Female'`);
                            return;
                        }
                        
                        if (!['Qaida', 'Sifarah', 'Quran Reading', 'Hifz'].includes(row.Stage)) {
                            errors.push(`Row ${rowNum}: Invalid Stage (must be Qaida, Sifarah, Quran Reading, or Hifz)`);
                            return;
                        }
                        
                        const studentName = row.Name.trim();
                        const studentDept = row.Department || department;
                        
                        // Check for duplicates in existing students
                        const existingStudent = app.state.allStudents.find(s => 
                            s.name.toLowerCase() === studentName.toLowerCase() && 
                            (s.department || 'Weekend') === studentDept
                        );
                        
                        if (existingStudent) {
                            warnings.push(`Row ${rowNum}: "${studentName}" already exists in ${studentDept} - will be skipped`);
                            return;
                        }
                        
                        // Check for duplicates within the upload file itself
                        const duplicateInFile = pendingStudents.find(s => 
                            s.name.toLowerCase() === studentName.toLowerCase() && 
                            s.department === studentDept
                        );
                        
                        if (duplicateInFile) {
                            warnings.push(`Row ${rowNum}: Duplicate "${studentName}" in file - will be skipped`);
                            return;
                        }
                        
                        const student = {
                            name: studentName,
                            gender: row.Gender,
                            department: studentDept,
                            stage: row.Stage,
                            targetCompletionDate: row['Target Completion Date'] || '',
                            qaida_review_count: {},
                            qaida_finished_count: {},
                            sifarah_completed_ayahs: 0,
                            hifz_coverage: {},
                            reading_coverage: {},
                            hifz_inventory: []
                        };
                        
                        pendingStudents.push(student);
                    });
                    
                    if (errors.length > 0) {
                        showUploadStatus(`Validation errors:\n${errors.join('\n')}`, 'error');
                        return;
                    }
                    
                    if (pendingStudents.length === 0) {
                        const warningMsg = warnings.length > 0 ? 
                            `No new students to upload.\n\nSkipped items:\n${warnings.join('\n')}` :
                            'No valid students found in the file.';
                        showUploadStatus(warningMsg, 'error');
                        return;
                    }
                    
                    // Show preview
                    showPreview(pendingStudents);
                    
                    let statusMsg = `‚úì ${pendingStudents.length} student${pendingStudents.length !== 1 ? 's' : ''} ready to upload`;
                    if (warnings.length > 0) {
                        statusMsg += `\n\n‚ö†Ô∏è ${warnings.length} duplicate${warnings.length !== 1 ? 's' : ''} skipped:\n${warnings.join('\n')}`;
                    }
                    showUploadStatus(statusMsg, 'success');
                    document.getElementById('confirm-upload-btn').disabled = false;
                    
                } catch (error) {
                    console.error('Error reading Excel file:', error);
                    showUploadStatus('Error reading Excel file: ' + error.message, 'error');
                }
            };
            
            reader.readAsArrayBuffer(file);
        };
        
        // Show upload status
        function showUploadStatus(message, type) {
            const statusDiv = document.getElementById('upload-status');
            statusDiv.textContent = message;
            statusDiv.className = `p-3 rounded-lg ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            statusDiv.classList.remove('hidden');
        }
        
        // Show preview of students
        function showPreview(students) {
            const previewDiv = document.getElementById('upload-preview');
            const contentDiv = document.getElementById('preview-content');
            
            let html = '<table class=\"min-w-full divide-y divide-gray-200\"><thead><tr class=\"bg-gray-50\">';
            html += '<th class=\"px-2 py-1 text-left text-xs font-semibold text-gray-700\">Name</th>';
            html += '<th class=\"px-2 py-1 text-left text-xs font-semibold text-gray-700\">Gender</th>';
            html += '<th class=\"px-2 py-1 text-left text-xs font-semibold text-gray-700\">Dept</th>';
            html += '<th class=\"px-2 py-1 text-left text-xs font-semibold text-gray-700\">Stage</th>';
            html += '</tr></thead><tbody class=\"divide-y divide-gray-200\">';
            
            students.forEach(s => {
                html += '<tr>';
                html += `<td class=\"px-2 py-1 text-xs\">${s.name}</td>`;
                html += `<td class=\"px-2 py-1 text-xs\">${s.gender}</td>`;
                html += `<td class=\"px-2 py-1 text-xs\">${s.department}</td>`;
                html += `<td class=\"px-2 py-1 text-xs\">${s.stage}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            contentDiv.innerHTML = html;
            previewDiv.classList.remove('hidden');
        }
        
        // Confirm and upload students
        window.confirmBulkUpload = async function() {
            if (pendingStudents.length === 0) return;
            
            const btn = document.getElementById('confirm-upload-btn');
            btn.disabled = true;
            btn.textContent = 'Uploading...';
            
            try {
                let successCount = 0;
                let errorCount = 0;
                
                for (const student of pendingStudents) {
                    try {
                        const studentsRef = collection(db, `artifacts/${APP_ID}/public/data/students`);
                        await addDoc(studentsRef, student);
                        successCount++;
                    } catch (error) {
                        console.error('Error adding student:', student.name, error);
                        errorCount++;
                    }
                }
                
                showUploadStatus(`‚úì Successfully uploaded ${successCount} students${errorCount > 0 ? `. ${errorCount} failed.` : ''}`, successCount > 0 ? 'success' : 'error');
                
                if (successCount > 0) {
                    setTimeout(() => {
                        closeBulkUploadModal();
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Bulk upload error:', error);
                showUploadStatus('Upload failed: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Upload Students';
            }
        };

        // --- ADMIN MANAGEMENT FUNCTIONS ---
        let ADMIN_LIST = ['MpcB7f35m0bITsSK1D7ACWFmch32']; // Default admin
        let isAdmin = false;
        let MENU_VISIBILITY = {
            'index': true,
            'dashboard': true,
            'quran-tracker': true
        };
        
        // Load admin list from Firebase
        async function loadAdminList() {
            try {
                const adminDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'admins');
                const docSnap = await getDoc(adminDocRef);
                
                if (docSnap.exists()) {
                    ADMIN_LIST = docSnap.data().list || ADMIN_LIST;
                    console.log('Admin list loaded from Firebase');
                } else {
                    console.log('No admin list in Firebase, using defaults');
                    await saveAdminList();
                }
                
                checkAdminStatus();
            } catch (error) {
                console.error('Error loading admin list:', error);
                checkAdminStatus();
            }
        }
        
        // Save admin list to Firebase
        async function saveAdminList() {
            try {
                const adminDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'admins');
                await setDoc(adminDocRef, { list: ADMIN_LIST });
                console.log('‚úÖ Admin list saved to Firebase');
            } catch (error) {
                console.error('‚ùå Error saving admin list:', error);
            }
        }
        
        // Check if current user is admin
        function checkAdminStatus() {
            isAdmin = ADMIN_LIST.includes(userId);
            console.log('User is admin:', isAdmin);
            updateAdminButton();
        }
        
        // Update admin button visibility
        function updateAdminButton() {
            const adminBtn = document.getElementById('admin-portal-btn');
            const bulkUploadBtn = document.getElementById('bulk-upload-btn');
            
            if (adminBtn) {
                if (isAdmin) {
                    adminBtn.classList.remove('hidden');
                } else {
                    adminBtn.classList.add('hidden');
                }
            }
            
            if (bulkUploadBtn) {
                if (isAdmin) {
                    bulkUploadBtn.classList.remove('hidden');
                    bulkUploadBtn.classList.add('flex');
                } else {
                    bulkUploadBtn.classList.add('hidden');
                    bulkUploadBtn.classList.remove('flex');
                }
            }
        }
        
        // Show message helper
        function showMessage(title, message) {
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = message;
            document.getElementById('message-box').classList.remove('hidden');
        }
        
        // Open admin portal
        window.openAdminPortal = () => {
            if (!isAdmin) {
                showMessage('Access Denied', 'You do not have admin privileges.');
                return;
            }
            
            document.getElementById('admin-user-id').textContent = userId;
            renderAdminList();
            document.getElementById('admin-portal-modal').classList.remove('hidden');
            document.getElementById('mobile-nav-menu').classList.add('hidden');
        };
        
        // Close admin portal
        window.closeAdminPortal = () => {
            document.getElementById('admin-portal-modal').classList.add('hidden');
        };
        
        // Render admin list
        function renderAdminList() {
            const container = document.getElementById('admin-list');
            container.innerHTML = '';
            
            ADMIN_LIST.forEach(adminId => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-white border border-gray-200 rounded-lg';
                
                const idSpan = document.createElement('span');
                idSpan.className = 'font-mono text-xs text-gray-700';
                idSpan.textContent = adminId;
                
                if (adminId !== userId) {
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'text-red-500 hover:text-red-700 text-sm';
                    removeBtn.textContent = '‚úñ Remove';
                    removeBtn.onclick = () => removeAdmin(adminId);
                    
                    div.appendChild(idSpan);
                    div.appendChild(removeBtn);
                } else {
                    const youBadge = document.createElement('span');
                    youBadge.className = 'text-xs bg-green-100 text-green-700 px-2 py-1 rounded';
                    youBadge.textContent = 'You';
                    
                    div.appendChild(idSpan);
                    div.appendChild(youBadge);
                }
                
                container.appendChild(div);
            });
        }
        
        // Add new admin
        window.addNewAdmin = async () => {
            const newAdminId = document.getElementById('new-admin-id').value.trim();
            
            if (!newAdminId) {
                showMessage('Error', 'Please enter a user ID.');
                return;
            }
            
            if (ADMIN_LIST.includes(newAdminId)) {
                showMessage('Error', 'This user is already an admin.');
                return;
            }
            
            ADMIN_LIST.push(newAdminId);
            await saveAdminList();
            
            document.getElementById('new-admin-id').value = '';
            renderAdminList();
            
            showMessage('Success', `User ${newAdminId} added as admin!`);
        };
        
        // Remove admin
        async function removeAdmin(adminId) {
            if (adminId === userId) {
                showMessage('Error', 'You cannot remove yourself as admin.');
                return;
            }
            
            if (ADMIN_LIST.length <= 1) {
                showMessage('Error', 'Cannot remove the last admin.');
                return;
            }
            
            ADMIN_LIST = ADMIN_LIST.filter(id => id !== adminId);
            await saveAdminList();
            
            renderAdminList();
            showMessage('Success', `Admin ${adminId} removed.`);
        }

        // --- MENU VISIBILITY MANAGEMENT ---
        
        // Load menu visibility settings from Firebase
        const loadMenuVisibility = async () => {
            try {
                const menuDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'menu_visibility');
                const docSnap = await getDoc(menuDocRef);
                
                if (docSnap.exists()) {
                    MENU_VISIBILITY = docSnap.data();
                    console.log('Menu visibility loaded from Firebase:', MENU_VISIBILITY);
                } else {
                    console.log('No menu visibility settings in Firebase, using defaults');
                    MENU_VISIBILITY = {
                        'index': true,
                        'dashboard': true,
                        'quran-tracker': true
                    };
                    await saveMenuVisibility();
                }
                
                updateMenuDisplay();
            } catch (error) {
                console.error('Error loading menu visibility:', error);
                MENU_VISIBILITY = {
                    'index': true,
                    'dashboard': true,
                    'quran-tracker': true
                };
                updateMenuDisplay();
            }
        };
        
        // Save menu visibility settings to Firebase
        const saveMenuVisibility = async () => {
            try {
                const menuDocRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'settings', 'menu_visibility');
                await setDoc(menuDocRef, MENU_VISIBILITY);
                console.log('‚úÖ Menu visibility saved to Firebase');
            } catch (error) {
                console.error('‚ùå Error saving menu visibility:', error);
            }
        };
        
        // Update menu display based on visibility settings and admin status
        const updateMenuDisplay = () => {
            // Show/hide menu items based on visibility (for non-admins)
            if (!isAdmin) {
                // Regular users only see visible items
                const indexItem = document.getElementById('menu-item-index');
                const quranItem = document.getElementById('menu-item-quran');
                const dashboardItem = document.getElementById('menu-item-dashboard');
                
                if (indexItem) {
                    indexItem.style.display = MENU_VISIBILITY['index'] ? 'flex' : 'none';
                }
                if (quranItem) {
                    quranItem.style.display = MENU_VISIBILITY['quran-tracker'] ? 'flex' : 'none';
                }
                if (dashboardItem) {
                    dashboardItem.style.display = MENU_VISIBILITY['dashboard'] ? 'flex' : 'none';
                }
            } else {
                // Admins see all items with toggle buttons
                const indexItem = document.getElementById('menu-item-index');
                const quranItem = document.getElementById('menu-item-quran');
                const dashboardItem = document.getElementById('menu-item-dashboard');
                
                if (indexItem) indexItem.style.display = 'flex';
                if (quranItem) quranItem.style.display = 'flex';
                if (dashboardItem) dashboardItem.style.display = 'flex';
                
                // Show toggle buttons for admins
                document.getElementById('toggle-index-btn').classList.remove('hidden');
                document.getElementById('toggle-quran-btn').classList.remove('hidden');
                document.getElementById('toggle-dashboard-btn').classList.remove('hidden');
                
                // Update eye icons
                updateEyeIcon('index');
                updateEyeIcon('quran-tracker');
                updateEyeIcon('dashboard');
            }
        };
        
        // Update eye icon based on visibility
        const updateEyeIcon = (itemKey) => {
            const eyeSpan = document.getElementById(`eye-${itemKey}`);
            if (eyeSpan) {
                eyeSpan.textContent = MENU_VISIBILITY[itemKey] ? 'üëÅÔ∏è' : 'üôà';
                eyeSpan.title = MENU_VISIBILITY[itemKey] ? 'Visible to users' : 'Hidden from users';
            }
        };
        
        // Toggle menu item visibility
        window.toggleMenuItemVisibility = async (itemKey) => {
            if (!isAdmin) return;
            
            MENU_VISIBILITY[itemKey] = !MENU_VISIBILITY[itemKey];
            await saveMenuVisibility();
            updateEyeIcon(itemKey);
            updateMenuDisplay();
        };
        
        // Global wrapper for add student modal
        window.showAddStudentModal = function() {
            app.showAddStudentModal();
        };

        // Initialize the application once the window is loaded
        window.onload = app.init.bind(app);
        window.app = app; // Expose app to global scope for inline handlers
        
        // Mobile menu toggle functionality (after page loads)
        window.addEventListener('DOMContentLoaded', function() {
            const menuToggle = document.getElementById('menu-toggle');
            const mobileNavMenu = document.getElementById('mobile-nav-menu');
            
            if (menuToggle && mobileNavMenu) {
                menuToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    mobileNavMenu.classList.toggle('hidden');
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', function(e) {
                    if (!mobileNavMenu.classList.contains('hidden') && 
                        !mobileNavMenu.contains(e.target) && 
                        e.target !== menuToggle) {
                        mobileNavMenu.classList.add('hidden');
                    }
                });
                
                // Prevent menu from closing when clicking inside it
                mobileNavMenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            // User ID display and copy functionality
            // Click to copy user ID
            const userIdElement = document.getElementById('user-id-display-mobile');
            if (userIdElement) {
                userIdElement.addEventListener('click', () => {
                    const idText = userIdElement.textContent;
                    const uid = idText.replace('ID: ', '');
                    try {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = uid;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        
                        const originalText = idText;
                        userIdElement.textContent = '‚úì Copied!';
                        setTimeout(() => {
                            userIdElement.textContent = originalText;
                        }, 1500);
                    } catch (err) {
                        console.error('Could not copy text: ', err);
                        alert('Failed to copy User ID to clipboard.');
                    }
                });
            }
        });
    </script>
</body>
</html>
