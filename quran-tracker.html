<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hifz Session & Goal Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a cleaner mobile-first UI */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .session-card {
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.1);
        }
        .session-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spin 1s ease-in-out infinite;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }
        @-webkit-keyframes spin {
            to { -webkit-transform: rotate(360deg); }
        }

        /* Styles for the Side Panel (Class Selector) */
        #classSelectorModal {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        #classSelectorModal.open {
            transform: translateX(0);
        }
        #overlay {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        #overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Global Overlay for Side Panel -->
    <div id="overlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-20" onclick="closeClassSelector()"></div>

    <!-- Class Selector Side Panel (Hamburger Menu) -->
    <div id="classSelectorModal" class="fixed top-0 left-0 h-full w-64 bg-white shadow-2xl z-30 flex flex-col">
        <div class="p-4 border-b bg-indigo-600 text-white flex justify-between items-center">
            <h2 class="text-lg font-bold">Hifz Classes</h2>
            <button onclick="closeClassSelector()" class="text-white hover:text-indigo-200 p-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <!-- Class List -->
        <div id="classesList" class="flex-grow overflow-y-auto p-4 space-y-2">
            <!-- Class buttons will be rendered here -->
        </div>

        <!-- Add Class Section -->
        <div class="p-4 border-t bg-gray-50">
            <h3 class="text-sm font-semibold mb-2 text-gray-700">Add New Class</h3>
            <input type="text" id="newClassNameInput" placeholder="Class Name (e.g., Group A)" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-2">
            <button onclick="handleAddClass()" class="w-full p-2 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 transition duration-150 shadow-md">
                Create Class
            </button>
        </div>
    </div>


    <!-- Header -->
    <header class="bg-indigo-600 text-white p-3 shadow-lg sticky top-0 z-10">
        <div class="flex justify-between items-center">
            <!-- Hamburger Menu Button -->
            <button id="hamburgerBtn" onclick="openClassSelector()" class="p-1 mr-3 rounded hover:bg-indigo-700 transition duration-150">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
            
            <div class="flex-grow">
                <h1 class="text-sm text-indigo-200">Current Class:</h1>
                <p id="currentClassDisplay" class="text-lg font-bold truncate"></p>
            </div>
            
            <button id="addStudentBtn" class="bg-indigo-400 hover:bg-indigo-500 text-sm text-white font-medium py-1 px-3 rounded-full transition duration-150 shadow-md">
                + Student
            </button>
        </div>
        <p id="userIdDisplay" class="text-xs mt-1 text-indigo-200 truncate"></p>
    </header>

    <!-- Main Content Area -->
    <main class="p-3 max-w-4xl mx-auto">
        <div id="loadingIndicator" class="flex justify-center items-center py-10">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
        </div>
        
        <!-- Instruction for no class selected -->
        <div id="noClassSelected" class="hidden text-center p-6 bg-white rounded-xl shadow-lg mt-6">
            <p class="text-sm font-semibold text-indigo-600">Select a Class</p>
            <p class="text-xs text-gray-500 mt-2">Open the menu (top left) to create or select a class to view students.</p>
        </div>


        <!-- Student List -->
        <div id="studentList" class="space-y-3">
            <!-- Student cards will be rendered here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center p-6 bg-white rounded-xl shadow-lg mt-6">
            <p class="text-sm text-gray-500">No students added to this class yet.</p>
            <p class="text-xs text-gray-400 mt-2">Tap '+ Student' to begin tracking Hifz sessions.</p>
        </div>
    </main>

    <!-- Global Message/Modal Area -->
    <div id="globalModalOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-40 transition-opacity duration-300 items-center justify-center">
        
        <!-- Add Student Modal -->
        <div id="addStudentModal" class="bg-white p-4 rounded-xl shadow-2xl w-11/12 max-w-lg scale-95 opacity-0 transition-all duration-300">
            <h2 class="text-xl font-semibold mb-3 text-gray-800">Add New Student to <span id="addStudentClassTarget" class="text-indigo-600"></span></h2>
            
            <input type="text" id="studentNameInput" placeholder="Enter student's name" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-3">
            
            <h3 class="text-base font-bold text-gray-700 mb-2 mt-3">Current Hifz Status (Memorized Ranges)</h3>
            <p class="text-xs text-gray-500 mb-3">Add all separate Surah:Ayah ranges the student has fully memorized.</p>

            <!-- Dynamic Ranges Container -->
            <div id="initialRangesContainer" class="space-y-3 max-h-48 overflow-y-auto pr-2">
                <!-- Range inputs will be dynamically injected here -->
            </div>

            <button id="addRangeBtn" onclick="addInitialRangeInput()" class="w-full p-2 mt-3 text-xs bg-gray-100 text-indigo-600 border border-dashed border-indigo-300 rounded-lg hover:bg-gray-200 transition duration-150">
                + Add Another Memorized Range
            </button>

            <h3 class="text-base font-bold text-gray-700 mb-2 mt-3 border-t pt-3">Goal Setting</h3>
            <label class="block text-xs font-medium text-gray-700 mb-1">Target Completion Date (Whole Quran)</label>
            <input type="date" id="goalDateInput" class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-3">

            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="closeModal('addStudentModal')" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Cancel</button>
                <button onclick="handleAddStudent()" class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">Add Student & Set Goal</button>
            </div>
        </div>

        <!-- Session Tracking Modal (progressModal) -->
        <div id="progressModal" class="bg-white p-4 rounded-xl shadow-2xl w-11/12 max-w-3xl h-5/6 overflow-y-auto scale-95 opacity-0 transition-all duration-300">
            <h2 id="modalStudentName" class="text-xl font-semibold mb-2 text-gray-800 border-b pb-2"></h2>
            
            <!-- Goal Display and Pace -->
            <div id="goalPaceDisplay" class="bg-green-50 p-3 rounded-xl mb-4 shadow-inner border-l-4 border-green-400">
                <!-- Pace calculations will be inserted here -->
            </div>

            <p class="text-xs text-gray-500 mb-3">Log daily Hifz and Review sessions.</p>

            <!-- Add Session Form -->
            <div id="addSessionForm" class="bg-indigo-50 p-3 rounded-xl mb-4 shadow-inner">
                <h3 class="text-base font-bold text-indigo-700 mb-2">Log New Session</h3>
                
                <p class="text-xs text-indigo-500 mb-3">
                    Log the total portion covered. System automatically detects **New Hifz** vs. **Review**.
                </p>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Start Surah</label>
                        <select id="surahStart" onchange="renderAyahOptions('session', 'start')" class="w-full p-1.5 text-sm border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Start Ayah</label>
                        <select id="ayahStart" class="w-full p-1.5 text-sm border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">End Surah</label>
                        <select id="surahEnd" onchange="renderAyahOptions('session', 'end')" class="w-full p-1.5 text-sm border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">End Ayah</label>
                        <select id="ayahEnd" class="w-full p-1.5 text-sm border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>
                </div>

                <label class="block text-xs font-medium text-gray-700 mt-3 mb-1">Notes / Performance</label>
                <textarea id="sessionNotes" placeholder="e.g., Excellent, minor Tarteel errors." class="w-full p-2 text-sm border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 resize-none h-12"></textarea>

                <button onclick="handleAddSession()" class="w-full mt-3 px-3 py-1.5 text-sm bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                    Save Session
                </button>
            </div>

            <!-- Session History Log -->
            <h3 class="text-base font-bold text-gray-700 border-t pt-3 mt-4 mb-3">Session History</h3>
            <div id="sessionHistory" class="space-y-3">
                <!-- Session history entries will be rendered here -->
            </div>
            
            <!-- Gemini Progress Summary -->
            <h3 class="text-base font-bold mb-3 mt-4 text-gray-700 border-t pt-3">Gemini Progress Summary</h3>
            <button onclick="handleGenerateSummary()" id="generateSummaryBtn" class="w-full mb-3 px-3 py-1.5 text-sm bg-green-500 text-white rounded-lg hover:bg-green-600 transition duration-150 flex items-center justify-center">
                <svg id="summaryIcon" class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <div id="summarySpinner" class="hidden loader ease-linear rounded-full border-2 border-t-2 border-white h-4 w-4 mr-2"></div>
                Generate AI Report
            </button>
            <div id="summaryOutput" class="p-3 bg-gray-50 rounded-lg text-xs text-gray-700 border border-gray-200 min-h-[50px]">
                Report will appear here...
            </div>

            <div class="flex justify-end space-x-2 mt-4">
                <button onclick="closeModal('progressModal')" class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">Done</button>
            </div>
        </div>

        <!-- Message/Error Modal -->
        <div id="messageModal" class="bg-white p-4 rounded-xl shadow-2xl w-11/12 max-w-sm scale-95 opacity-0 transition-all duration-300">
            <h2 id="messageTitle" class="text-base font-semibold mb-3 text-gray-800"></h2>
            <p id="messageContent" class="text-sm text-gray-600 mb-4"></p>
            <div class="flex justify-end">
                <button onclick="closeModal('messageModal')" class="px-3 py-1.5 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Close</button>
            </div>
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, where, updateDoc, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase access
let app, db, auth;
let userId = null;

// NEW: Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAjGzS58U5ybbI5CYJUk2NRZBuLJpMJihQ",
  authDomain: "apps-e1163.firebaseapp.com",
  projectId: "apps-e1163",
  storageBucket: "apps-e1163.firebasestorage.app",
  messagingSenderId: "855206153422",
  appId: "1:855206153422:web:2a1366b2e7825304c3d49f",
  measurementId: "G-7YCKESJB8T"
};

// Cleaned up environment variables
const appId = 'standalone'; 
const initialAuthToken = null;

        // Global state for Classes
        let classesData = [];
        let currentClassId = null;
        let currentClassName = "Select Class";

        // Global counter for dynamic initial ranges
        let rangeIndex = 0;

        // Constants
        const API_KEY = ""; // Leave as-is for Canvas environment
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
        
        // Firestore Paths (Classes are separate from Students)
const CLASSES_PATH = 'hifz_classes'; // Change 'hifz_classes' if you used a different collection name
const STUDENTS_PATH = 'hifz_students'; // Change 'hifz_students' if you used a different collection name
        
        // This constant is a standard count for the whole Quran for goal-setting calculations.
        const TOTAL_QURAN_AYAH_COUNT = 6236; 

        // Surah Data (Extended for full tracking, though only a subset is detailed here)
        const SURAH_DATA = [
    { id: 1, name: "Al-Fatihah", ayahs: 7 },
    { id: 2, name: "Al-Baqarah", ayahs: 286 },
    { id: 3, name: "Al-Imran", ayahs: 200 },
    { id: 4, name: "An-Nisa", ayahs: 176 },
    { id: 5, name: "Al-Ma'idah", ayahs: 120 },
    { id: 6, name: "Al-An'am", ayahs: 165 },
    { id: 7, name: "Al-A'raf", ayahs: 206 },
    { id: 8, name: "Al-Anfal", ayahs: 75 },
    { id: 9, name: "At-Tawbah", ayahs: 129 },
    { id: 10, name: "Yunus", ayahs: 109 },
    { id: 11, name: "Hud", ayahs: 123 },
    { id: 12, name: "Yusuf", ayahs: 111 },
    { id: 13, name: "Ar-Ra'd", ayahs: 43 },
    { id: 14, name: "Ibrahim", ayahs: 52 },
    { id: 15, name: "Al-Hijr", ayahs: 99 },
    { id: 16, name: "An-Nahl", ayahs: 128 },
    { id: 17, name: "Al-Isra", ayahs: 111 },
    { id: 18, name: "Al-Kahf", ayahs: 110 },
    { id: 19, name: "Maryam", ayahs: 98 },
    { id: 20, name: "Ta-Ha", ayahs: 135 },
    { id: 21, name: "Al-Anbiya", ayahs: 112 },
    { id: 22, name: "Al-Hajj", ayahs: 78 },
    { id: 23, name: "Al-Mu'minun", ayahs: 118 },
    { id: 24, name: "An-Nur", ayahs: 64 },
    { id: 25, name: "Al-Furqan", ayahs: 77 },
    { id: 26, name: "Ash-Shu'ara", ayahs: 227 },
    { id: 27, name: "An-Naml", ayahs: 93 },
    { id: 28, name: "Al-Qasas", ayahs: 88 },
    { id: 29, name: "Al-Ankabut", ayahs: 69 },
    { id: 30, name: "Ar-Rum", ayahs: 60 },
    { id: 31, name: "Luqman", ayahs: 34 },
    { id: 32, name: "As-Sajdah", ayahs: 30 },
    { id: 33, name: "Al-Ahzab", ayahs: 73 },
    { id: 34, name: "Saba", ayahs: 54 },
    { id: 35, name: "Fatir", ayahs: 45 },
    { id: 36, name: "Ya-Sin", ayahs: 83 },
    { id: 37, name: "As-Saffat", ayahs: 182 },
    { id: 38, name: "Sad", ayahs: 88 },
    { id: 39, name: "Az-Zumar", ayahs: 75 },
    { id: 40, name: "Ghafir", ayahs: 85 },
    { id: 41, name: "Fussilat", ayahs: 54 },
    { id: 42, name: "Ash-Shura", ayahs: 53 },
    { id: 43, name: "Az-Zukhruf", ayahs: 89 },
    { id: 44, name: "Ad-Dukhan", ayahs: 59 },
    { id: 45, name: "Al-Jathiyah", ayahs: 37 },
    { id: 46, name: "Al-Ahqaf", ayahs: 35 },
    { id: 47, name: "Muhammad", ayahs: 38 },
    { id: 48, name: "Al-Fath", ayahs: 29 },
    { id: 49, name: "Al-Hujurat", ayahs: 18 },
    { id: 50, name: "Qaf", ayahs: 45 },
    { id: 51, name: "Adh-Dhariyat", ayahs: 60 },
    { id: 52, name: "At-Tur", ayahs: 49 },
    { id: 53, name: "An-Najm", ayahs: 62 },
    { id: 54, name: "Al-Qamar", ayahs: 55 },
    { id: 55, name: "Ar-Rahman", ayahs: 78 },
    { id: 56, name: "Al-Waqi'ah", ayahs: 96 },
    { id: 57, name: "Al-Hadid", ayahs: 29 },
    { id: 58, name: "Al-Mujadila", ayahs: 22 },
    { id: 59, name: "Al-Hashr", ayahs: 24 },
    { id: 60, name: "Al-Mumtahanah", ayahs: 13 },
    { id: 61, name: "As-Saff", ayahs: 14 },
    { id: 62, name: "Al-Jumu'ah", ayahs: 11 },
    { id: 63, name: "Al-Munafiqun", ayahs: 11 },
    { id: 64, name: "At-Taghabun", ayahs: 18 },
    { id: 65, name: "At-Talaq", ayahs: 12 },
    { id: 66, name: "At-Tahrim", ayahs: 12 },
    { id: 67, name: "Al-Mulk", ayahs: 30 },
    { id: 68, name: "Al-Qalam", ayahs: 52 },
    { id: 69, name: "Al-Haqqah", ayahs: 52 },
    { id: 70, name: "Al-Ma'arij", ayahs: 44 },
    { id: 71, name: "Nuh", ayahs: 28 },
    { id: 72, name: "Al-Jinn", ayahs: 28 },
    { id: 73, name: "Al-Muzzammil", ayahs: 20 },
    { id: 74, name: "Al-Muddaththir", ayahs: 56 },
    { id: 75, name: "Al-Qiyamah", ayahs: 40 },
    { id: 76, name: "Al-Insan", ayahs: 31 },
    { id: 77, name: "Al-Mursalat", ayahs: 50 },
    { id: 78, name: "An-Naba", ayahs: 40 },
    { id: 79, name: "An-Nazi'at", ayahs: 46 },
    { id: 80, name: "'Abasa", ayahs: 42 },
    { id: 81, name: "At-Takwir", ayahs: 29 },
    { id: 82, name: "Al-Infitar", ayahs: 19 },
    { id: 83, name: "Al-Mutaffifin", ayahs: 36 },
    { id: 84, name: "Al-Inshiqaq", ayahs: 25 },
    { id: 85, name: "Al-Buruj", ayahs: 22 },
    { id: 86, name: "At-Tariq", ayahs: 17 },
    { id: 87, name: "Al-A'la", ayahs: 19 },
    { id: 88, name: "Al-Ghashiyah", ayahs: 26 },
    { id: 89, name: "Al-Fajr", ayahs: 30 },
    { id: 90, name: "Al-Balad", ayahs: 20 },
    { id: 91, name: "Ash-Shams", ayahs: 15 },
    { id: 92, name: "Al-Layl", ayahs: 21 },
    { id: 93, name: "Ad-Duha", ayahs: 11 },
    { id: 94, name: "Ash-Sharh", ayahs: 8 },
    { id: 95, name: "At-Tin", ayahs: 8 },
    { id: 96, name: "Al-'Alaq", ayahs: 19 },
    { id: 97, name: "Al-Qadr", ayahs: 5 },
    { id: 98, name: "Al-Bayyinah", ayahs: 8 },
    { id: 99, name: "Az-Zalzalah", ayahs: 8 },
    { id: 100, name: "Al-'Adiyat", ayahs: 11 },
    { id: 101, name: "Al-Qari'ah", ayahs: 11 },
    { id: 102, name: "At-Takathur", ayahs: 8 },
    { id: 103, name: "Al-'Asr", ayahs: 3 },
    { id: 104, name: "Al-Humazah", ayahs: 9 },
    { id: 105, name: "Al-Fil", ayahs: 5 },
    { id: 106, name: "Quraysh", ayahs: 4 },
    { id: 107, name: "Al-Ma'un", ayahs: 7 },
    { id: 108, name: "Al-Kawthar", ayahs: 3 },
    { id: 109, name: "Al-Kafirun", ayahs: 6 },
    { id: 110, name: "An-Nasr", ayahs: 3 },
    { id: 111, name: "Al-Masad", ayahs: 5 },
    { id: 112, name: "Al-Ikhlas", ayahs: 4 },
    { id: 113, name: "Al-Falaq", ayahs: 5 },
    { id: 114, name: "An-Nas", ayahs: 6 }
];

        let studentsData = [];
        let currentStudent = null;
        let cumulativeAyahMap = null; // Cache for cumulative Ayah calculation

        // --- Core Range Logic Helpers ---

        /**
         * Calculates a unique cumulative Ayah index for a given Surah:Ayah point.
         */
        function getCumulativeAyah(surahId, ayahNumber) {
            if (!cumulativeAyahMap) {
                // Pre-calculate map for efficiency
                cumulativeAyahMap = {};
                let cumulative = 0;
                for (const surah of SURAH_DATA) {
                    cumulativeAyahMap[surah.id] = { start: cumulative + 1, end: cumulative + surah.ayahs };
                    cumulative += surah.ayahs;
                }
            }

            const mapEntry = cumulativeAyahMap[surahId];
            if (mapEntry) {
                // Cumulative position = (Start of Surah) + (Ayah Number - 1)
                return mapEntry.start + ayahNumber - 1;
            }
            return 0; 
        }
        
        /**
         * Converts a cumulative Ayah range back into Surah:Ayah coordinates.
         */
        function cumulativeToSurahAyah(startCumulative, endCumulative) {
            if (startCumulative > endCumulative) return { valid: false };

            if (!cumulativeAyahMap) { getCumulativeAyah(1, 1); }

            let startSurahId = 0, startAyah = 0;
            let endSurahId = 0, endAyah = 0;

            for (const surah of SURAH_DATA) {
                const entry = cumulativeAyahMap[surah.id];
                if (entry) {
                    // Check for start point
                    if (startCumulative >= entry.start && startCumulative <= entry.end) {
                        startSurahId = surah.id;
                        startAyah = startCumulative - entry.start + 1;
                    }
                    // Check for end point
                    if (endCumulative >= entry.start && endCumulative <= entry.end) {
                        endSurahId = surah.id;
                        endAyah = endCumulative - entry.start + 1;
                    }

                    if (startSurahId > 0 && endSurahId > 0 && startSurahId <= surah.id) break; 
                }
            }

            if (!startSurahId || !endSurahId) return { valid: false };

            return {
                valid: true,
                range: {
                    surah_start_id: startSurahId,
                    ayah_start: startAyah,
                    surah_end_id: endSurahId,
                    ayah_end: endAyah
                }
            };
        }

        /**
         * Merges overlapping or contiguous ranges.
         */
        function mergeRanges(ranges) {
            if (ranges.length === 0) return [];
            
            const sortedRanges = [...ranges].sort((a, b) => a.start - b.start);
            const merged = [];
            let current = { ...sortedRanges[0] };

            for (let i = 1; i < sortedRanges.length; i++) {
                const next = sortedRanges[i];
                
                if (next.start <= current.end + 1) {
                    current.end = Math.max(current.end, next.end);
                } else {
                    merged.push(current);
                    current = { ...next };
                }
            }
            merged.push(current);
            return merged;
        }

        /**
         * Analyzes the given range against the student's existing Hifz history.
         */
        function calculateSessionBreakdown(startId, startAyah, endId, endAyah) {
            const initialSegment = {
                type: 'New Hifz',
                surah_start_id: startId,
                ayah_start: startAyah,
                surah_end_id: endId,
                ayah_end: endAyah
            };
            if (!currentStudent || !currentStudent.sessions) return [initialSegment];

            const targetStart = getCumulativeAyah(startId, startAyah);
            const targetEnd = getCumulativeAyah(endId, endAyah);

            let hifzHistory = [];

            (currentStudent.initialHifzRanges || []).forEach(initial => {
                hifzHistory.push({
                    start: getCumulativeAyah(initial.surah_start_id, initial.ayah_start),
                    end: getCumulativeAyah(initial.surah_end_id, initial.ayah_end)
                });
            });

            hifzHistory = hifzHistory.concat(currentStudent.sessions
                .flatMap(s => {
                    if (s.breakdown) {
                        return s.breakdown
                            .filter(b => b.type === 'New Hifz')
                            .map(b => ({
                                start: getCumulativeAyah(b.surah_start_id, b.ayah_start),
                                end: getCumulativeAyah(b.surah_end_id, b.ayah_end)
                            }));
                    }
                    if (s.type === 'New Hifz' && s.surah_start_id) {
                         return [{
                             start: getCumulativeAyah(s.surah_start_id, s.ayah_start),
                             end: getCumulativeAyah(s.surah_end_id, s.ayah_end)
                         }];
                    }
                    return [];
                }));

            const mergedHifzRanges = mergeRanges(hifzHistory);

            let currentCursor = targetStart;
            const breakdown = [];

            for (const hifzRange of mergedHifzRanges) {
                if (currentCursor > targetEnd) break;

                const reviewStart = Math.max(currentCursor, hifzRange.start);
                const reviewEnd = Math.min(targetEnd, hifzRange.end);

                // 1. Log "New Hifz" segment (the gap before this Review section)
                if (currentCursor < reviewStart) {
                    const segment = cumulativeToSurahAyah(currentCursor, reviewStart - 1);
                    if (segment.valid) {
                         breakdown.push({ type: 'New Hifz', ...segment.range });
                    }
                }

                // 2. Log "Review" segment (the overlap with history)
                if (reviewStart <= reviewEnd) {
                     const segment = cumulativeToSurahAyah(reviewStart, reviewEnd);
                     if (segment.valid) {
                         breakdown.push({ type: 'Review', ...segment.range });
                     }
                    currentCursor = reviewEnd + 1;
                }
            }

            // 3. Log the final "New Hifz" segment 
            if (currentCursor <= targetEnd) {
                 const segment = cumulativeToSurahAyah(currentCursor, targetEnd);
                 if (segment.valid) {
                    breakdown.push({ type: 'New Hifz', ...segment.range });
                 }
            }
            
            if (breakdown.length === 0) {
                return [initialSegment];
            }

            return breakdown;
        }

        // --- Goal Calculation Logic ---

        function calculateHifzPace(student) {
            if (!student || !student.goalDate || !student.initialHifzRanges || student.initialHifzRanges.length === 0) {
                return null;
            }
            
            let hifzAyahs = 0;
            let lastAyahMemorized = 0;

            let allHifzRanges = [];

            (student.initialHifzRanges || []).forEach(initial => {
                 allHifzRanges.push({
                    start: getCumulativeAyah(initial.surah_start_id, initial.ayah_start),
                    end: getCumulativeAyah(initial.surah_end_id, initial.ayah_end)
                });
            });

            (student.sessions || []).forEach(s => {
                if (s.breakdown) {
                    s.breakdown.filter(b => b.type === 'New Hifz').forEach(b => {
                        allHifzRanges.push({
                            start: getCumulativeAyah(b.surah_start_id, b.ayah_start),
                            end: getCumulativeAyah(b.surah_end_id, b.ayah_end)
                        });
                    });
                } else if (s.type === 'New Hifz' && s.surah_start_id) {
                     allHifzRanges.push({
                         start: getCumulativeAyah(s.surah_start_id, s.ayah_start),
                         end: getCumulativeAyah(s.surah_end_id, s.ayah_end)
                     });
                }
            });

            const mergedHifz = mergeRanges(allHifzRanges);
            hifzAyahs = mergedHifz.reduce((sum, range) => sum + (range.end - range.start + 1), 0);
            
            lastAyahMemorized = mergedHifz.reduce((max, range) => Math.max(max, range.end), 0);
            
            if (lastAyahMemorized === 0) {
                lastAyahMemorized = getCumulativeAyah(1, 1);
            }

            const remainingAyahs = TOTAL_QURAN_AYAH_COUNT - hifzAyahs;
            
            const goalDate = new Date(student.goalDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            
            const timeDifferenceMs = goalDate.getTime() - today.getTime();
            
            if (timeDifferenceMs < 0 || remainingAyahs <= 0) {
                return {
                    totalAyahs: TOTAL_QURAN_AYAH_COUNT,
                    memorizedAyahs: hifzAyahs,
                    remainingAyahs: Math.max(0, remainingAyahs),
                    daysRemaining: 0,
                    pace: { daily: 0, weekly: 0, monthly: 0 },
                    lastAyah: cumulativeToSurahAyah(lastAyahMemorized, lastAyahMemorized).range || { surah_start_id: 1, ayah_start: 1 }
                };
            }

            const daysRemaining = Math.ceil(timeDifferenceMs / (1000 * 60 * 60 * 24));

            const dailyPace = remainingAyahs / daysRemaining;
            const weeklyPace = dailyPace * 7;
            const monthlyPace = dailyPace * (365.25 / 12); 

            return {
                totalAyahs: TOTAL_QURAN_AYAH_COUNT,
                memorizedAyahs: hifzAyahs,
                remainingAyahs: remainingAyahs,
                daysRemaining: daysRemaining,
                pace: { 
                    daily: Math.max(0, dailyPace), 
                    weekly: Math.max(0, weeklyPace), 
                    monthly: Math.max(0, monthlyPace) 
                },
                lastAyah: cumulativeToSurahAyah(lastAyahMemorized, lastAyahMemorized).range || { surah_start_id: 1, ayah_start: 1 }
            };
        }
        
        // --- Utility Functions ---

        function showMessage(title, content) {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageContent').textContent = content;
            openModal('messageModal');
        }

        window.openModal = function(modalId) {
            document.getElementById('globalModalOverlay').classList.remove('hidden', 'opacity-0');
            document.getElementById('globalModalOverlay').classList.add('flex', 'opacity-100');
            
            const modalElement = document.getElementById(modalId);
            modalElement.classList.remove('scale-95', 'opacity-0');
            modalElement.classList.add('scale-100', 'opacity-100');

            if (modalId === 'addStudentModal') {
                document.getElementById('addStudentClassTarget').textContent = currentClassName;
                const container = document.getElementById('initialRangesContainer');
                container.innerHTML = '';
                rangeIndex = 0;
                addInitialRangeInput(); 
            }
        }

        window.closeModal = function(modalId) {
            const modalElement = document.getElementById(modalId);
            modalElement.classList.remove('scale-100', 'opacity-100');
            modalElement.classList.add('scale-95', 'opacity-0');
            
            setTimeout(() => {
                document.getElementById('globalModalOverlay').classList.remove('flex', 'opacity-100');
                document.getElementById('globalModalOverlay').classList.add('hidden', 'opacity-0');
            }, 300);
        }

        // --- Class Selector Functions ---

        window.openClassSelector = function() {
            document.getElementById('classSelectorModal').classList.add('open');
            document.getElementById('overlay').classList.add('active');
        }

        window.closeClassSelector = function() {
            document.getElementById('classSelectorModal').classList.remove('open');
            document.getElementById('overlay').classList.remove('active');
        }

        window.switchClass = function(classId) {
            if (classId === currentClassId) {
                closeClassSelector();
                return;
            }
            const selectedClass = classesData.find(c => c.id === classId);
            if (selectedClass) {
                currentClassId = classId;
                currentClassName = selectedClass.name;
                document.getElementById('currentClassDisplay').textContent = currentClassName;
                closeClassSelector();
                // Rerun the student listener with the new class filter
                setupStudentListener(); 
                renderClassesList(); // Update highlight
            }
        }

        window.handleAddClass = async function() {
            const name = document.getElementById('newClassNameInput').value.trim();
            if (!name) {
                showMessage("Input Required", "Please enter a name for the new class.");
                return;
            }
            
            try {
                const newClass = {
                    name: name,
                    created_by: userId,
                    created_at: new Date().toISOString()
                };

                await addDoc(collection(db, CLASSES_PATH), newClass);
                document.getElementById('newClassNameInput').value = '';
                // The onSnapshot listener will handle updating classesData and UI
            } catch (error) {
                console.error("Error adding class:", error);
                showMessage("Database Error", "Could not add class. Check console for details.");
            }
        }

        function renderClassesList() {
            const listElement = document.getElementById('classesList');
            listElement.innerHTML = '';

            if (classesData.length === 0) {
                listElement.innerHTML = '<p class="text-xs text-gray-500 text-center mt-4">No classes found. Create one above!</p>';
                return;
            }

            classesData.forEach(cls => {
                const isCurrent = cls.id === currentClassId;
                const button = document.createElement('button');
                button.className = `w-full text-left p-3 rounded-lg text-sm transition duration-150 shadow-sm ${
                    isCurrent ? 'bg-indigo-600 text-white font-semibold' : 'bg-gray-100 text-gray-800 hover:bg-indigo-100'
                }`;
                button.textContent = cls.name;
                button.setAttribute('onclick', `switchClass('${cls.id}')`);
                listElement.appendChild(button);
            });
        }


        // --- Firebase Initialization and Authentication ---

        async function initFirebase() {
            try {
                setLogLevel('error');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        userId = crypto.randomUUID();
                    }
                    document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;
                    setupRealtimeListeners();
                });

            } catch (error) {
                console.error("Firebase Initialization/Authentication Error:", error);
                showMessage("Setup Error", "Failed to initialize Firebase. Check console for details.");
            }
        }

        // --- Data Listening and Rendering ---
        
        // This function sets up the main class listener
        function setupRealtimeListeners() {
            const classQuery = query(collection(db, CLASSES_PATH));

            onSnapshot(classQuery, (snapshot) => {
                classesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // 1. Check if the current class is still valid
                const currentClassExists = classesData.some(cls => cls.id === currentClassId);
                
                // 2. If no class is selected or the current one was deleted, select the first one found
                if (!currentClassId || !currentClassExists) {
                    if (classesData.length > 0) {
                        currentClassId = classesData[0].id;
                        currentClassName = classesData[0].name;
                        document.getElementById('noClassSelected').classList.add('hidden');
                        document.getElementById('currentClassDisplay').textContent = currentClassName;
                        setupStudentListener(); // Start listening to students for the new class
                    } else {
                        // No classes available - stop listening to students
                        currentClassId = null;
                        currentClassName = "No Classes";
                        document.getElementById('currentClassDisplay').textContent = currentClassName;
                        document.getElementById('noClassSelected').classList.remove('hidden');
                        renderStudentList([]); // Clear the student list
                    }
                } else {
                    // Update the current name in case the name field changed
                    currentClassName = classesData.find(cls => cls.id === currentClassId)?.name || "Class Deleted";
                    document.getElementById('currentClassDisplay').textContent = currentClassName;
                    // Re-run student listener just in case it wasn't running (e.g., initial load)
                    if (currentClassId) setupStudentListener(); 
                }
                
                renderClassesList(); // Always render the class list for the side panel
                document.getElementById('loadingIndicator').classList.add('hidden');
            }, (error) => {
                console.error("Firestore Class Snapshot Error:", error);
            });
        }
        
        // This function sets up the student listener, filtered by the active class
        let studentUnsubscribe = null; // Used to manage the subscription

        function setupStudentListener() {
            if (studentUnsubscribe) {
                studentUnsubscribe(); // Unsubscribe from the old class's students
            }

            if (!currentClassId) {
                studentsData = [];
                renderStudentList();
                return;
            }

            const studentQuery = query(collection(db, STUDENTS_PATH), where('classId', '==', currentClassId));

            studentUnsubscribe = onSnapshot(studentQuery, (snapshot) => {
                const newStudents = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (!data.sessions) data.sessions = [];
                    if (!data.initialHifzRanges) data.initialHifzRanges = [];
                    newStudents.push({ id: doc.id, ...data });
                });
                // Sort students alphabetically by name
                studentsData = newStudents.sort((a, b) => a.name.localeCompare(b.name));
                renderStudentList();
            }, (error) => {
                console.error("Firestore Student Snapshot Error:", error);
                showMessage("Data Error", "Failed to load student data for the current class.");
            });
        }


        function renderStudentList() {
            const listElement = document.getElementById('studentList');
            listElement.innerHTML = ''; 

            if (!currentClassId) {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('noClassSelected').classList.remove('hidden');
                return;
            } else {
                 document.getElementById('noClassSelected').classList.add('hidden');
            }

            if (studentsData.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            studentsData.forEach(student => {
                const sessionCount = student.sessions ? student.sessions.length : 0;
                const lastSessionDate = sessionCount > 0 
                    ? new Date(student.sessions[0].timestamp).toLocaleDateString() 
                    : 'N/A';
                
                const card = document.createElement('div');
                card.className = "bg-white p-3 rounded-xl shadow-lg border border-gray-200 cursor-pointer hover:bg-gray-50 transition duration-150 flex justify-between items-center session-card";
                card.setAttribute('onclick', `window.showProgressModal('${student.id}')`);
                card.innerHTML = `
                    <div>
                        <h2 class="text-base font-semibold text-gray-800">${student.name}</h2>
                        <p class="text-xs text-gray-500">Total Sessions: ${sessionCount}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-400">Last Session:</p>
                        <p class="text-sm text-indigo-600 font-medium">${lastSessionDate}</p>
                    </div>
                `;
                listElement.appendChild(card);
            });
        }

        // --- Student Management (Dynamic Ranges) ---
        
        window.addInitialRangeInput = function() {
            const container = document.getElementById('initialRangesContainer');
            const index = rangeIndex++;
            const rangeId = `range_${index}`;

            const newRangeHtml = `
                <div id="${rangeId}" class="p-3 border border-indigo-200 rounded-lg bg-indigo-50 relative">
                    <h4 class="text-sm font-semibold text-indigo-800 mb-2">Range #${index + 1}</h4>
                    <button onclick="removeInitialRangeInput('${rangeId}')" class="absolute top-2 right-2 text-red-500 hover:text-red-700 text-base leading-none">
                        &times;
                    </button>
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <!-- Start Point -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">Start Surah</label>
                            <select id="initialSurahStart_${index}" onchange="renderAyahOptions('initial', 'start', ${index})" class="w-full p-1.5 text-xs border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">Start Ayah</label>
                            <select id="initialAyahStart_${index}" class="w-full p-1.5 text-xs border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <!-- End Point -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">End Surah</label>
                            <select id="initialSurahEnd_${index}" onchange="renderAyahOptions('initial', 'end', ${index})" class="w-full p-1.5 text-xs border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">End Ayah</label>
                            <select id="initialAyahEnd_${index}" class="w-full p-1.5 text-xs border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newRangeHtml);
            
            renderSurahOptions('initial', 'start', index);
            renderSurahOptions('initial', 'end', index);
            
            if (index === 0) {
                 document.getElementById(`initialSurahStart_${index}`).value = 1; 
                 document.getElementById(`initialSurahEnd_${index}`).value = 1;
                 renderAyahOptions('initial', 'start', index); 
                 renderAyahOptions('initial', 'end', index); 
                 document.getElementById(`initialAyahStart_${index}`).value = 1;
                 document.getElementById(`initialAyahEnd_${index}`).value = 7;
            }
        }

        window.removeInitialRangeInput = function(rangeId) {
            document.getElementById(rangeId).remove();
        }

        window.handleAddStudent = async function() {
            if (!currentClassId) {
                 showMessage("Action Blocked", "Please select or create a class first using the hamburger menu.");
                 return;
            }

            const name = document.getElementById('studentNameInput').value.trim();
            const goalDate = document.getElementById('goalDateInput').value;
            
            if (!name || !goalDate) {
                showMessage("Input Required", "Please fill in the student's name and goal date.");
                return;
            }
            
            const initialRanges = [];
            const rangeContainers = document.querySelectorAll('#initialRangesContainer > div');
            
            for (const container of rangeContainers) {
                const index = container.id.split('_')[1];
                
                const startId = parseInt(document.getElementById(`initialSurahStart_${index}`).value);
                const startAyah = parseInt(document.getElementById(`initialAyahStart_${index}`).value);
                const endId = parseInt(document.getElementById(`initialSurahEnd_${index}`).value);
                const endAyah = parseInt(document.getElementById(`initialAyahEnd_${index}`).value);

                if (isNaN(startId) || isNaN(startAyah) || isNaN(endId) || isNaN(endAyah)) continue; 

                const startCumulative = getCumulativeAyah(startId, startAyah);
                const endCumulative = getCumulativeAyah(endId, endAyah);

                if (startCumulative > endCumulative) {
                    showMessage("Input Error", `Range #${initialRanges.length + 1} is invalid. Start point must be before or equal to the End point.`);
                    return;
                }

                initialRanges.push({
                    surah_start_id: startId,
                    ayah_start: startAyah,
                    surah_end_id: endId,
                    ayah_end: endAyah
                });
            }
            
            if (initialRanges.length === 0) {
                showMessage("Input Required", "Please add at least one initial Hifz range.");
                return;
            }

            try {
                const newStudent = {
                    classId: currentClassId, // NEW: Link to the active class
                    name: name,
                    sessions: [], 
                    goalDate: goalDate,
                    initialHifzRanges: initialRanges, 
                    created_by: userId,
                    created_at: new Date().toISOString()
                };

                await addDoc(collection(db, STUDENTS_PATH), newStudent);

                // Clear inputs
                document.getElementById('studentNameInput').value = '';
                document.getElementById('goalDateInput').value = '';
                closeModal('addStudentModal');
            } catch (error) {
                console.error("Error adding student:", error);
                showMessage("Database Error", "Could not add student. Check console for details.");
            }
        }

        document.getElementById('addStudentBtn').addEventListener('click', () => {
             if (!currentClassId) {
                showMessage("Action Blocked", "Please select or create a class first using the hamburger menu.");
                return;
             }
            openModal('addStudentModal');
        });

        // --- Session Tracking Modal ---

        window.showProgressModal = function(studentId) {
            currentStudent = studentsData.find(s => s.id === studentId);
            if (!currentStudent) {
                showMessage("Error", "Student data not found.");
                return;
            }

            document.getElementById('modalStudentName').textContent = currentStudent.name;
            
            renderSurahOptions('session', 'start');
            renderSurahOptions('session', 'end');

            renderGoalPace(currentStudent);
            renderSessionHistory(currentStudent.sessions);
            openModal('progressModal');
            document.getElementById('summaryOutput').textContent = "Report will appear here...";
        }
        
        function renderGoalPace(student) {
            const displayElement = document.getElementById('goalPaceDisplay');
            const paceData = calculateHifzPace(student);
            const getSurahName = (id) => SURAH_DATA.find(s => s.id === id)?.name || `Surah ${id}`;

            if (!paceData || !student.initialHifzRanges || student.initialHifzRanges.length === 0) {
                displayElement.innerHTML = '<p class="text-xs text-red-600">Goal data incomplete. Please enter initial memorized ranges and a target date.</p>';
                return;
            }
            
            const lastAyah = paceData.lastAyah;
            const formattedLastAyah = `${getSurahName(lastAyah.surah_start_id)} Ayah ${lastAyah.ayah_start}`;
            const goalDate = new Date(student.goalDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            const paceHtml = `
                <h3 class="text-base font-bold text-green-700 mb-1">Hifz Goal & Pace</h3>
                <p class="text-xs text-gray-700"><strong>Target Completion Date:</strong> <span class="font-medium text-green-600">${goalDate}</span></p>
                <p class="text-xs text-gray-700"><strong>Current Progress:</strong> Memorized ${paceData.memorizedAyahs} of ${paceData.totalAyahs} Ayahs.</p>
                <p class="text-xs text-gray-700 mb-2"><strong>Last Memorized Ayah:</strong> ${formattedLastAyah}</p>
                
                <p class="text-sm font-semibold text-gray-800">Required Pace:</p>
                <div class="grid grid-cols-3 gap-2 text-center mt-2">
                    <div class="p-2 bg-white rounded-lg shadow-sm border border-green-200">
                        <span class="block text-lg font-bold text-green-800">${Math.ceil(paceData.pace.daily)}</span>
                        <span class="block text-xs text-gray-500">Ayahs / Day</span>
                    </div>
                    <div class="p-2 bg-white rounded-lg shadow-sm border border-green-200">
                        <span class="block text-lg font-bold text-green-800">${Math.ceil(paceData.pace.weekly)}</span>
                        <span class="block text-xs text-gray-500">Ayahs / Week</span>
                    </div>
                    <div class="p-2 bg-white rounded-lg shadow-sm border border-green-200">
                        <span class="block text-lg font-bold text-green-800">${Math.ceil(paceData.pace.monthly)}</span>
                        <span class="block text-xs text-gray-500">Ayahs / Month</span>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Total remaining Ayahs: ${paceData.remainingAyahs}. Days left: ${paceData.daysRemaining}.</p>
            `;
            displayElement.innerHTML = paceHtml;
        }


        // --- Surah/Ayah Dropdown Rendering (Refactored to handle dynamic inputs) ---

        function renderSurahOptions(scope, point, index = null) {
            let selectId;
            const pointTitle = point.charAt(0).toUpperCase() + point.slice(1);

            if (scope === 'initial') { 
                selectId = `initialSurah${pointTitle}_${index}`;
            } else { 
                selectId = `surah${pointTitle}`;
            }

            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            selectElement.innerHTML = '';

            SURAH_DATA.forEach(surah => {
                const option = document.createElement('option');
                option.value = surah.id;
                option.textContent = `${surah.id}. ${surah.name}`;
                selectElement.appendChild(option);
            });
            
            renderAyahOptions(scope, point, index);
        }

        window.renderAyahOptions = function(scope, point, index = null) {
            const pointTitle = point.charAt(0).toUpperCase() + point.slice(1);
            let surahSelectId, ayahSelectId;
            
            if (scope === 'initial') {
                surahSelectId = `initialSurah${pointTitle}_${index}`;
                ayahSelectId = `initialAyah${pointTitle}_${index}`;
            } else { 
                surahSelectId = `surah${pointTitle}`;
                ayahSelectId = `ayah${pointTitle}`;
            }

            const surahSelect = document.getElementById(surahSelectId);
            const ayahSelect = document.getElementById(ayahSelectId);
            
            if (!surahSelect || !ayahSelect) return;

            ayahSelect.innerHTML = '';
            
            const selectedSurahId = parseInt(surahSelect.value);
            const surah = SURAH_DATA.find(s => s.id === selectedSurahId);

            if (surah) {
                for (let i = 1; i <= surah.ayahs; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = `Ayah ${i}`;
                    ayahSelect.appendChild(option);
                }
            } else {
                const option = document.createElement('option');
                option.textContent = 'Select Surah first';
                ayahSelect.appendChild(option);
            }
        }

        // --- Session Management ---

        window.handleAddSession = async function() {
            if (!currentStudent || !db) return;

            const surahStartId = parseInt(document.getElementById('surahStart').value);
            const ayahStart = parseInt(document.getElementById('ayahStart').value);
            const surahEndId = parseInt(document.getElementById('surahEnd').value);
            const ayahEnd = parseInt(document.getElementById('ayahEnd').value);
            const notes = document.getElementById('sessionNotes').value.trim();

            if (!surahStartId || !ayahStart || !surahEndId || !ayahEnd) {
                showMessage("Validation Error", "Please ensure all Surah and Ayah fields are selected.");
                return;
            }
            
            const breakdown = calculateSessionBreakdown(surahStartId, ayahStart, surahEndId, ayahEnd);
            
            let overallType;
            const hasNewHifz = breakdown.some(b => b.type === 'New Hifz');
            const hasReview = breakdown.some(b => b.type === 'Review');

            if (hasNewHifz && hasReview) {
                overallType = 'Combined';
            } else if (hasNewHifz) {
                overallType = 'New Hifz';
            } else {
                overallType = 'Review';
            }


            try {
                const newSession = {
                    timestamp: new Date().toISOString(),
                    type: overallType, 
                    surah_start_id: surahStartId,
                    surah_end_id: surahEndId,
                    ayah_start: ayahStart,
                    ayah_end: ayahEnd,
                    notes: notes || 'No notes recorded.',
                    breakdown: breakdown 
                };

                const studentRef = doc(db, STUDENTS_PATH, currentStudent.id);
                
                const updatedSessions = [newSession, ...currentStudent.sessions];
                
                currentStudent.sessions = updatedSessions;

                await updateDoc(studentRef, {
                    sessions: updatedSessions
                });

                document.getElementById('sessionNotes').value = '';
                renderGoalPace(currentStudent); 
                renderSessionHistory(updatedSessions);

            } catch (error) {
                console.error("Error adding session:", error);
                showMessage("Database Error", "Could not save session. Check console for details.");
            }
        }

        function renderSessionHistory(sessions) {
            const historyElement = document.getElementById('sessionHistory');
            historyElement.innerHTML = '';

            if (!sessions || sessions.length === 0) {
                historyElement.innerHTML = '<p class="text-gray-500 text-center py-3 text-sm">No sessions logged yet.</p>';
                return;
            }
            
            const sortedSessions = [...sessions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const getSurahName = (id) => SURAH_DATA.find(s => s.id === id)?.name || `Surah ${id}`;

            sortedSessions.forEach(session => {
                const startSurah = getSurahName(session.surah_start_id);
                const endSurah = getSurahName(session.surah_end_id);
                const date = new Date(session.timestamp).toLocaleString();

                let typeColor;
                if (session.type === 'Combined') {
                    typeColor = 'bg-yellow-100 text-yellow-700 border-yellow-400';
                } else if (session.type === 'New Hifz') {
                    typeColor = 'bg-indigo-100 text-indigo-700 border-indigo-400';
                } else {
                    typeColor = 'bg-green-100 text-green-700 border-green-400';
                }
                
                const entry = document.createElement('div');
                entry.className = `bg-white p-3 rounded-lg shadow-sm border-l-4 ${typeColor} session-card`;
                
                let breakdownHtml = '';
                if (session.breakdown && session.breakdown.length > 0) {
                    breakdownHtml += '<ul class="mt-1 text-xs space-y-0.5 pl-3">';
                    session.breakdown.forEach(segment => {
                        const segStart = getSurahName(segment.surah_start_id);
                        const segEnd = getSurahName(segment.surah_end_id);
                        const segColor = segment.type === 'New Hifz' ? 'text-indigo-600 font-medium' : 'text-green-600 font-medium';
                        
                        let rangeText;
                        if (segment.surah_start_id === segment.surah_end_id && segment.ayah_start === segment.ayah_end) {
                            rangeText = `${segStart} (${segment.ayah_start})`;
                        } else if (segment.surah_start_id === segment.surah_end_id) {
                             rangeText = `${segStart} (${segment.ayah_start} - ${segment.ayah_end})`;
                        } else {
                            rangeText = `${segStart} (${segment.ayah_start}) to ${segEnd} (${segment.ayah_end})`;
                        }

                        breakdownHtml += `
                            <li class="flex items-start">
                                <span class="text-xs mr-1 mt-0.5"></span>
                                <span class="${segColor}">${segment.type}:</span>
                                <span class="ml-1 text-gray-700">${rangeText}</span>
                            </li>
                        `;
                    });
                    breakdownHtml += '</ul>';
                }

                entry.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold text-sm text-gray-800">${startSurah} (${session.ayah_start}) - ${endSurah} (${session.ayah_end})</span>
                        <span class="text-xs font-medium px-2 py-0.5 rounded-full ${typeColor}">${session.type}</span>
                    </div>
                    <p class="text-xs text-gray-500 mb-1">${date}</p>
                    ${breakdownHtml}
                    <p class="text-xs text-gray-600 italic mt-1">${session.notes}</p>
                `;
                historyElement.appendChild(entry);
            });
        }
        
        // --- Gemini API Integration for Summary (Unchanged) ---

        window.handleGenerateSummary = async function() {
            if (!currentStudent) return;
            
            const btn = document.getElementById('generateSummaryBtn');
            const icon = document.getElementById('summaryIcon');
            const spinner = document.getElementById('summarySpinner');
            const output = document.getElementById('summaryOutput');

            output.textContent = "Analyzing session history...";
            btn.disabled = true;
            icon.classList.add('hidden');
            spinner.classList.remove('hidden');
            
            const getSurahName = (id) => SURAH_DATA.find(s => s.id === id)?.name || `Surah ${id}`;
            const paceData = calculateHifzPace(currentStudent);
            
            const recentSessions = (currentStudent.sessions || [])
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 10)
                .map(s => {
                    const breakdownSummary = (s.breakdown || [])
                        .map(b => `${b.type} (${getSurahName(b.surah_start_id)}:${b.ayah_start} - ${getSurahName(b.surah_end_id)}:${b.ayah_end})`)
                        .join('; ');
                    
                    const notes = s.notes || 'No notes recorded.';

                    return `Overall Type: ${s.type}. Breakdown: ${breakdownSummary}. Total Range: ${getSurahName(s.surah_start_id)} to ${getSurahName(s.surah_end_id)}. Notes: ${notes}`;
                }).join(' | ');

            const systemPrompt = "You are a specialized Hifz (Quran memorization) tutor. Analyze the provided student's recent session history log, paying close attention to the breakdown of New Hifz vs. Review segments within each session. Also, use the Goal data to inform your advice. Generate a concise, single-paragraph report that identifies trends (e.g., focus on review vs. new hifz, rate of new memorization), highlights the area of current focus, and provides an encouraging and actionable recommendation for the student's next 3 days of study based on the required pace.";

            const goalInfo = paceData ? 
                `Current Pace Goal: Total memorized Ayahs: ${paceData.memorizedAyahs}. Required Daily Pace: ${Math.ceil(paceData.pace.daily)} Ayahs/Day.` : 
                `Goal data is not fully set.`;

            const userQuery = `Student: ${currentStudent.name}. ${goalInfo}. Recent Session History (Last 10 entries): ${recentSessions}. Please generate the personalized progress report and next steps recommendation based on this detailed log and the required daily pace.`;
            
            try {
                const maxRetries = 3;
                let attempt = 0;
                let resultText = "Failed to generate report after multiple retries.";

                while (attempt < maxRetries) {
                    try {
                        const payload = {
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            tools: [{ "google_search": {} }],
                        };

                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                             throw new Error(`API returned status ${response.status}`);
                        }

                        const result = await response.json();
                        const candidate = result.candidates?.[0];

                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            resultText = candidate.content.parts[0].text;
                            break; 
                        } else {
                            throw new Error("API response structure missing text content.");
                        }

                    } catch (error) {
                        attempt++;
                        if (attempt < maxRetries) {
                            const delay = Math.pow(2, attempt) * 1000; 
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw error; 
                        }
                    }
                }
                
                output.textContent = resultText;

            } catch (error) {
                console.error("Gemini API Error:", error);
                output.textContent = "Sorry, I couldn't generate the progress report right now. Please try again later. (Error: " + error.message + ")";
            } finally {
                btn.disabled = false;
                icon.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }


        // --- Main Execution ---
        window.onload = initFirebase;
    </script>
</body>
</html>
