<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>class-tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        /* Enforce full viewport height and prevent main page scrolling */
        html, body { 
            height: 100%;
            min-height: 100vh;
            overflow: hidden; /* Prevent page-level scroll */
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f7f9; 
            transition: background-color 0.3s;
            display: flex;
            flex-direction: column;
        }

        /* Utility classes for inputs and containers */
        
        /* Ultra-small font size utility (text-[10px] equivalent) */
        .text-2xs {
            font-size: 0.65rem; /* ~10.4px (Used for high-density labels) */
        }

        /* Custom spinner animation */
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
          animation: spin 3s linear infinite;
        }
        
    </style>
</head>
<body class="flex flex-col h-full">

<div class="border-b border-gray-200 mb-8 py-4 bg-white/70 backdrop-blur-sm sticky top-0 z-10 no-print">
    <div class="flex flex-wrap justify-center space-x-4 max-w-4xl mx-auto">
        
        <a href="qaidatracker.html" class="flex-shrink-0 inline-block px-5 py-2 text-sm text-center bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-200 ease-in-out font-semibold shadow-md min-w-[120px]">
            About Us
        </a>

        <a href="hifztracker.html" class="flex-shrink-0 inline-block px-5 py-2 text-sm text-center bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition duration-200 ease-in-out font-semibold shadow-md min-w-[120px]">
            Contact
        </a>
        
    </div>
</div>


    <!-- Header Section -->
    <header class="flex-shrink-0 bg-white shadow-lg p-3 border-b border-gray-200">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-xl font-extrabold text-indigo-700 mb-2 sm:mb-0">
                <span class="mr-1">ðŸ“š</span> Class Tracker
            </h1>
            
            <!-- Date Display and User ID -->
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-3">
                <!-- Date Input Field -->
                <input type="date" id="date-selector" onchange="handleDateChange(this.value)"
                       class="px-2 py-1 border border-indigo-300 rounded-lg text-sm font-semibold text-gray-700 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                
                <!-- User ID -->
                <div id="user-id-display" class="text-2xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full truncate max-w-[100px] sm:max-w-xs cursor-pointer" 
                     title="User ID. Click to Copy">
                     ID: ...
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-content-area" class="flex-grow overflow-hidden relative max-w-7xl mx-auto w-full min-h-0 p-2 flex flex-col">
        
        <!-- Loading/Initial Message Overlay (Absolute position to cover the entire main area) -->
        <div id="initial-message" class="absolute inset-0 z-10 flex flex-col items-center justify-center p-8 bg-f4f7f9/90 backdrop-blur-sm">
            <div class="flex flex-col items-center justify-center p-8 bg-white rounded-xl shadow-2xl max-w-sm mx-auto">
                <svg id="loading-spinner" class="animate-spin-slow h-8 w-8 text-indigo-500 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="initial-message-text" class="text-sm text-gray-600 font-semibold text-center">Connecting to database and authenticating user...</p>
                <p id="error-details" class="text-xs text-red-500 mt-2 hidden text-center font-mono"></p>
            </div>
        </div>
        
        <!-- Overall Scores View (The main, persistent grid view) -->
        <div id="scores-view" class="flex-grow overflow-y-auto space-y-3 pb-2 min-h-0">
            <!-- Class sections will be rendered here -->
        </div>

        <!-- MODAL for Daily Report Entry (New) -->
        <div id="report-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-40 flex items-center justify-center p-4" onclick="closeModal()">
            <div class="bg-white p-4 rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div id="details-panel-content">
                    <p class="text-center text-gray-500 italic py-10">Select a class to load the report entry form.</p>
                </div>
                <div id="modal-footer" class="mt-4 flex justify-center">
                    <!-- Content will be dynamically inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Message Box for Confirmation/Errors (Replaces alert()) -->
        <div id="message-box" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
                <h3 id="message-title" class="text-xl font-bold mb-3 text-indigo-700"></h3>
                <p id="message-text" class="text-gray-700 mb-4"></p>
                <button onclick="document.getElementById('message-box').classList.add('hidden')" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    Got It
                </button>
            </div>
        </div>
    </main>

    <!-- Firebase SDK Imports -->
    <script type="module">
        // Use a consistent major version for all Firebase SDK components to prevent console warnings.
        // We use static strings in the imports to avoid the SyntaxError: Unexpected template string.
        const FIREBASE_VERSION = "10.10.0"; 

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            onSnapshot, 
            collection, 
            serverTimestamp,
            runTransaction,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION (CRITICAL: Using user-provided config as base) ---
        
        const USER_PROVIDED_FIREBASE_CONFIG = {
            // API key from the user's latest console output
            apiKey: "AIzaSyAjGzS58U5ybbI5CYJUk2NRZBuLJpMJihQ", 
            authDomain: "apps-e1163.firebaseapp.com",
            projectId: "apps-e1163",
            storageBucket: "apps-e1163.firebasestorage.app",
            messagingSenderId: "855206153422",
            appId: "1:855206153422:web:2a1366b2e7825304c3d49f",
            measurementId: "G-7YCKESJB8T" 
        };
        
        // Prioritize Canvas injected config if it exists, otherwise use the user's config
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : USER_PROVIDED_FIREBASE_CONFIG;
            
        // Use injected app ID or fallback to the project ID if all else fails
        const appId = typeof __app_id !== 'undefined' 
            ? __app_id 
            : firebaseConfig.projectId; 
            
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' 
            ? __initial_auth_token 
            : null; 
        // --- END FIREBASE CONFIGURATION ---

        setLogLevel('Debug');

        // --- GLOBAL STATE & FIREBASE INIT ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentReports = {}; // Daily report entries for the SELECTED DAY
        let currentAccumulatedScores = {}; // Accumulated scores (all classes)
        let selectedClassId = null; 
        let isSaving = false;
        
        const getTodayDateId = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const todayDateId = getTodayDateId();
        let selectedDateId = todayDateId;

        // Class definitions (used for fixed order and ID mapping)
        const CLASS_DEFINITIONS = [
            { id: 'Girls-1A', name: '1-A' },
            { id: 'Girls-1B', name: '1-B' },
            { id: 'Girls-1C', name: '1-C' },
            { id: 'Girls-2', name: '2' },
            { id: 'Girls-3', name: '3' },
            { id: 'Girls-4', name: '4' },
            { id: 'Boys-1A', name: '1-A' },
            { id: 'Boys-1B', name: '1-B' },
            { id: 'Boys-1C', name: '1-C' },
            { id: 'Boys-2', name: '2' },
            { id: 'Boys-3', name: '3' },
            { id: 'Boys-4', name: '4' },
        ];
        
        // --- UTILITY FUNCTIONS ---

        /**
         * Custom function to display a message to the user (replaces alert()).
         */
        window.showMessage = (title, text) => {
            const box = document.getElementById('message-box');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = text;
            box.classList.remove('hidden');
        };

        /**
         * Closes the modal.
         */
        window.closeModal = () => {
            document.getElementById('report-modal').classList.add('hidden');
            selectedClassId = null;
        }

        /**
         * Converts YYYY-MM-DD date ID to a display format.
         */
        const getDisplayDate = (dateId) => {
            const parts = dateId.split('-');
            // Note: Months in Date() constructor are 0-indexed, so -1 is correct.
            const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])); 
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const suffix = dateId === todayDateId ? ' (Today)' : '';
            return date.toLocaleDateString(undefined, options) + suffix;
        };
        
        /**
         * Handles the change event from the date selector input.
         */
        window.handleDateChange = (newDateId) => {
            if (newDateId === selectedDateId) return;
            selectedDateId = newDateId;
            // Show loading message when date changes
            const initialMessage = document.getElementById('initial-message');
            initialMessage.classList.remove('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('initial-message-text').textContent = `Fetching reports for ${getDisplayDate(selectedDateId)}...`;
            
            // Re-setup listeners which will trigger a new renderClassList call
            setupFirestoreListeners();
        };

        /**
         * Calculates the Daily Class Score (DCS) out of 100 based on number of students.
         */
        const calculateDailyScore = (report) => {
            // CRITICAL DEFENSE: Use 0 if a key is missing from the report object
            const totalStudents = report.totalStudents || 0;
            const presentToday = report.presentToday || 0;
            const progressReportBrought = report.progressReportBrought || 0;
            const progressReportSigned = report.progressReportSigned || 0;

            if (totalStudents <= 0) return 0; 
            
            // Attendance (50%) + Report Brought (25%) + Report Signed (25%)
            const attendanceScore = 50 * (Math.min(presentToday, totalStudents) / totalStudents);
            const broughtScore = 25 * (Math.min(progressReportBrought, totalStudents) / totalStudents);
            const signedScore = 25 * (Math.min(progressReportSigned, totalStudents) / totalStudents);
            
            return Math.round((attendanceScore + broughtScore + signedScore) * 100) / 100;
        };
        
        /**
         * Determines the color coding for the card border based on the CUMULATIVE average score.
         */
        const getPerformanceBorder = (cumulativeAvg, hasData) => {
            if (!hasData || cumulativeAvg === null) return 'border-gray-300';
            if (cumulativeAvg >= 80) return 'border-green-500';
            if (cumulativeAvg >= 50) return 'border-yellow-500';
            return 'border-red-500';
        };

        /**
         * Determines the performance label and associated Tailwind classes based on the CUMULATIVE average score.
         */
        const getPerformanceStatus = (cumulativeAvg, hasData) => {
            if (!hasData || cumulativeAvg === null) {
                return { text: 'No Data', bg: 'bg-gray-100', text_color: 'text-gray-500', bar_color: 'bg-gray-400', score_color: 'text-gray-500' };
            }
            // CRITICAL CHECK: If the average is somehow over 100 (due to the bug), display an error status
            if (cumulativeAvg > 100.01) {
                 return { text: 'DATA ERROR', bg: 'bg-red-200', text_color: 'text-red-800', bar_color: 'bg-red-700', score_color: 'text-red-800' };
            }
            if (cumulativeAvg >= 80) {
                return { text: 'Excellent', bg: 'bg-green-100', text_color: 'text-green-700', bar_color: 'bg-green-500', score_color: 'text-green-700' };
            }
            if (cumulativeAvg >= 50) {
                return { text: 'Good', bg: 'bg-yellow-100', text_color: 'text-yellow-700', bar_color: 'bg-yellow-500', score_color: 'text-yellow-700' };
            }
            return { text: 'Poor', bg: 'bg-red-100', text_color: 'text-red-700', bar_color: 'bg-red-500', score_color: 'text-red-700' };
        };


        // --- FIREBASE AND AUTHENTICATION ---
        
        const handleAppReady = () => {
            document.getElementById('date-selector').value = todayDateId;
            
            const initialMessage = document.getElementById('initial-message');
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('initial-message-text').textContent = "Authentication Complete! Fetching data...";
            
            setupFirestoreListeners();

            // Set a small delay before hiding the loading overlay, ensuring data fetch is initiated
            setTimeout(() => {
                // CRITICAL: Render the initial empty/placeholder UI immediately
                renderClassList();
                initialMessage.classList.add('hidden'); // This is the only place we hide the overlay
            }, 500);
        };


        const initializeFirebase = () => {
            const initialMessageDiv = document.getElementById('initial-message');
            const messageText = document.getElementById('initial-message-text');
            const spinner = document.getElementById('loading-spinner');
            const errorDetails = document.getElementById('error-details');

            messageText.textContent = "Connecting to database and authenticating user...";
            initialMessageDiv.classList.remove('hidden');
            spinner.classList.remove('hidden');
            errorDetails.classList.add('hidden');

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated as:", userId);
                        document.getElementById('user-id-display').textContent = `ID: ${userId}`;
                        isAuthReady = true;
                        handleAppReady();
                        
                    } else {
                        // Attempt to sign in if not already authenticated
                        try {
                            // On public hosts, initialAuthToken will be null, so we fall back to anonymous sign-in.
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            // onAuthStateChanged should fire again with the user
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            spinner.classList.add('hidden');
                            messageText.textContent = "Authentication Failed. Access Denied.";
                            errorDetails.textContent = `Error: ${error.message}`;
                            errorDetails.classList.remove('hidden');
                            showMessage('Authentication Error', `Could not sign in to the database. ${error.message}`);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                spinner.classList.add('hidden');
                messageText.textContent = 'Error: Failed to initialize Firebase.';
                errorDetails.textContent = `Check config and console. Error: ${error.message}`;
                errorDetails.classList.remove('hidden');
                showMessage('Initialization Error', 'The app could not connect to the database. See console for details.');
            }
        };

        // --- FIRESTORE LISTENERS ---

        const setupFirestoreListeners = () => {
            if (!isAuthReady) return;

            // 1. Listener for the SELECTED DATE's Daily Reports (Changes with date selector)
            const dailyReportDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily_attendance_reports', selectedDateId);
            
            // Unsubscribe existing listener if present
            if (window.dailyReportUnsubscribe) {
                window.dailyReportUnsubscribe();
            }

            window.dailyReportUnsubscribe = onSnapshot(dailyReportDocRef, (docSnapshot) => {
                // IMPORTANT: The document should only contain class entries. 
                // We trust the security rules to ensure only valid data is present.
                currentReports = docSnapshot.exists() ? docSnapshot.data() : {};
                console.log(`Daily Reports updated for ${selectedDateId}:`, currentReports);
                renderClassList(); // Re-render when daily report data updates
                
                // Hide the loading overlay immediately after data is received
                document.getElementById('initial-message').classList.add('hidden'); 
                
                if (selectedClassId && document.getElementById('report-modal').classList.contains('hidden') === false) {
                    renderModalContent(selectedClassId);
                }
            }, (error) => {
                console.error(`Error fetching daily report for ${selectedDateId}:`, error);
                // Note: We don't hide the whole UI on data fetch errors, just log and continue.
                document.getElementById('initial-message').classList.add('hidden'); 
            });


            // 2. Listener for Accumulated Scores (Always uses the latest data for overall ranking)
            if (!window.accumulatedScoresUnsubscribe) {
                const scoresCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'accumulated_class_scores');
                
                window.accumulatedScoresUnsubscribe = onSnapshot(scoresCollectionRef, (querySnapshot) => {
                    const scores = {};
                    querySnapshot.forEach(doc => {
                        scores[doc.id] = doc.data();
                    });
                    currentAccumulatedScores = scores;
                    console.log("Accumulated Scores updated:", currentAccumulatedScores);
                    renderClassList(); // Re-render when accumulated score data updates
                }, (error) => {
                    console.error("Error fetching accumulated scores:", error);
                    // Note: We don't hide the whole UI on data fetch errors, just log and continue.
                });
            }
        };

        // --- RENDERING FUNCTIONS (UI/UX) ---

        /**
         * Renders the overall class list with Daily and Accumulated Scores using the high-density grid.
         */
        const renderClassList = () => {
            const container = document.getElementById('scores-view');
            
            // We clear the scores container to redraw the class list.
            container.innerHTML = '';
            
            const allClasses = CLASS_DEFINITIONS.map(classDef => {
                const report = currentReports[classDef.id] || {}; 
                const rawAccumulated = currentAccumulatedScores[classDef.id] || {};
                
                // FIX: Defensively ensure all numeric fields are present, defaulting to 0.
                const accumulated = {
                    totalScore: rawAccumulated.totalScore || 0,
                    daysCount: rawAccumulated.daysCount || 0,
                    lastScoreContribution: rawAccumulated.lastScoreContribution || 0,
                    lastReportDate: rawAccumulated.lastReportDate || ''
                };
                
                // 1. DAILY SCORE (Dynamic, changes with selectedDateId)
                const dailyReportHasData = report.totalStudents !== undefined && report.totalStudents !== 0 && Object.keys(report).length > 1;

                const dailyScore = dailyReportHasData 
                    ? calculateDailyScore(report) 
                    : null; 

                const dailyScoreText = dailyReportHasData ? `${dailyScore.toFixed(2)}` : 'N/A';
                
                // 2. CUMULATIVE AVERAGE
                // Since totalScore and daysCount are now guaranteed to be numbers (0 or from DB), this is safe.
                const isCumulativeData = accumulated.daysCount > 0;
                const averageScore = isCumulativeData 
                    ? (accumulated.totalScore / accumulated.daysCount)
                    : 0;

                const cumulativeAvgText = averageScore.toFixed(2); // CRITICAL: This is now called on a guaranteed number (0 or calculated float)

                // Add a detailed title for inspection (Includes new field)
                const cumulativeTitle = isCumulativeData 
                    ? `Cumulative Breakdown:\nTotal Points: ${accumulated.totalScore.toFixed(2)}\nTotal Days: ${accumulated.daysCount}\nLast Score Added: ${accumulated.lastScoreContribution.toFixed(2)}\nLast Report Date: ${accumulated.lastReportDate || 'Unknown'}`
                    : `No previous reports recorded.`;

                // --- CRITICAL CHECK: Use CUMULATIVE AVERAGE for Card Look ---
                const borderColorClass = getPerformanceBorder(averageScore, isCumulativeData);
                const performance = getPerformanceStatus(averageScore, isCumulativeData);
                // -----------------------------------------------------------
                
                return {
                    ...classDef,
                    dailyScoreText,
                    averageScore: cumulativeAvgText, // Used for the big text display
                    borderColorClass, // Used for the fixed border
                    performance, // Used for the fixed status pill
                    cumulativeTitle // New tooltip text
                };
            });

            const girlsClasses = allClasses.filter(c => c.id.startsWith('Girls'));
            const boysClasses = allClasses.filter(c => c.id.startsWith('Boys'));
            
            const selectedDateDisplay = getDisplayDate(selectedDateId);
            
            const createSection = (title, classes) => {
                const section = document.createElement('div');
                section.className = 'mb-3';
                section.innerHTML = `
                    <h2 class="text-base font-extrabold text-gray-800 mb-2 border-b-2 border-indigo-200 pb-0.5 flex justify-between items-center">
                        <span>${title}</span>
                        <span class="text-2xs font-semibold text-gray-500 italic">Reports for ${selectedDateDisplay}</span>
                    </h2>
                    <!-- LAYOUT CONSTRAINT: md:grid-cols-6 ensures 6-in-a-row on desktop/tablet -->
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                        ${classes.map(c => {
                            // Calculate width for the progress bar based on daily score
                            const dailyScoreValue = c.dailyScoreText === 'N/A' ? 0 : parseFloat(c.dailyScoreText);
                            const dailyScoreWidth = dailyScoreValue > 0 ? Math.min(dailyScoreValue, 100).toFixed(0) : '0';
                            
                            // The daily score needs its own temporary color for the progress bar
                            const dailyProgressBarColor = dailyScoreValue >= 80 ? 'bg-indigo-500' : dailyScoreValue >= 50 ? 'bg-orange-500' : 'bg-red-500';

                            return `
                                <!-- MANDATED CARD STRUCTURE AND HOVER EFFECT -->
                                <div class="p-2 bg-white rounded-xl shadow-md transition transform duration-300 ease-in-out hover:scale-[1.03] hover:shadow-xl h-full cursor-pointer
                                             border-l-4 ${c.borderColorClass}" 
                                     onclick="selectClass('${c.id}')"
                                     title="${c.cumulativeTitle.replace(/"/g, '&quot;')}"> <!-- Added Tooltip Here -->
                                    
                                    <div class="flex justify-between items-start mb-1">
                                        <!-- Class Name -->
                                        <span class="font-extrabold text-sm text-gray-900 leading-tight">${c.name}</span>
                                        <!-- Performance Label (FIXED based on CUMULATIVE SCORE) -->
                                        <span class="text-2xs font-semibold px-1 py-0.5 rounded-full ${c.performance.bg} ${c.performance.text_color} whitespace-nowrap">
                                            ${c.performance.text}
                                        </span>
                                    </div>
                                    
                                    <!-- Accumulated Average Score (FIXED TEXT) -->
                                    <p class="text-2xs text-gray-500 leading-none">Avg (Cumul.):</p>
                                    <p class="font-extrabold text-lg text-indigo-700 leading-snug">${c.averageScore}%</p>
                                    
                                    <!-- Daily Score (Progress Bar - DYNAMIC) -->
                                    <p class="text-2xs text-gray-500 leading-none mt-2">Daily Score (${c.dailyScoreText}%):</p>
                                    <!-- h-1 is used for the thin progress bar -->
                                    <div class="h-1 bg-gray-200 rounded-full">
                                        <div class="h-1 ${dailyProgressBarColor} rounded-full transition-all duration-300" style="width: ${dailyScoreWidth}%;"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                container.appendChild(section);
            };

            createSection('Girls Section', girlsClasses);
            createSection('Boys Section', boysClasses);

            if (allClasses.length === 0) {
                 container.innerHTML = `<p class="text-center text-gray-500 italic py-10">No class data found. Check definitions or initialization.</p>`;
            } else if (allClasses.every(c => c.performance.text === 'No Data')) {
                 container.insertAdjacentHTML('afterbegin', `<p class="text-center text-sm font-semibold text-gray-600 bg-yellow-50 p-2 rounded-lg mb-4">Database is empty. Click any class card to enter today's first report!</p>`);
            }
        };
        
        /**
         * Updates only the Daily Class Score (DCS) text and color in the open modal.
         */
        const updateModalScoreDisplay = (classId) => {
            const report = currentReports[classId];
            if (!report) return;

            const dailyScore = calculateDailyScore(report);
            const scoreElement = document.getElementById('daily-class-score');
            
            if (scoreElement) {
                scoreElement.textContent = `DCS: ${dailyScore.toFixed(2)} / 100`;
                const colorClass = dailyScore >= 80 ? 'text-green-600' : dailyScore >= 50 ? 'text-yellow-600' : 'text-red-600';
                scoreElement.className = `text-lg font-bold ${colorClass}`;
            }
        }


        /**
         * Renders the detail entry panel structure for the selected class into the modal content area.
         */
        const renderModalContent = (classId) => {
            const classDef = CLASS_DEFINITIONS.find(c => c.id === classId);
            if (!classDef) return;

            const isEditable = selectedDateId === todayDateId;
            const disabledAttr = isEditable ? '' : 'disabled';
            const statusColor = isEditable ? 'text-indigo-700' : 'text-gray-500';

            if (!currentReports[classId]) {
                currentReports[classId] = { totalStudents: 0, presentToday: 0, progressReportBrought: 0, progressReportSigned: 0 };
            }

            selectedClassId = classId;
            const report = currentReports[classId];

            // CRITICAL DEFENSE: Use 0 if the field is missing from the report object
            const totalStudents = report.totalStudents || 0;
            const presentToday = report.presentToday || 0;
            const reportBrought = report.progressReportBrought || 0;
            const reportSigned = report.progressReportSigned || 0;

            document.getElementById('details-panel-content').innerHTML = `
                <div class="p-4 space-y-4 shadow-none border-none">
                    <div class="flex justify-between items-center border-b pb-2 mb-3">
                        <h2 class="text-2xl font-extrabold ${statusColor}">Class ${classDef.name}</h2>
                        <div id="daily-class-score" class="text-lg font-bold text-gray-400">
                            Loading...
                        </div>
                    </div>
                    
                    <p class="text-sm font-medium text-center ${isEditable ? 'text-green-600' : 'text-red-600'} bg-${isEditable ? 'green-50' : 'red-50'} py-1 rounded-lg border border-${isEditable ? 'green-200' : 'red-200'}">
                        ${isEditable ? 'EDIT MODE: Data entry for today.' : `VIEW MODE: Showing data for ${getDisplayDate(selectedDateId)}`}
                    </p>

                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="totalStudents" class="block text-xs font-medium text-gray-700 mb-1">Total Students in Class</label>
                                <input type="number" id="totalStudents" value="${totalStudents}" oninput="updateReportEntry('${classId}', 'totalStudents', this.value)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 font-mono text-lg ${disabledAttr ? 'bg-gray-100' : ''}" placeholder="0" min="0" ${disabledAttr}>
                            </div>
                            <div>
                                <label for="presentToday" class="block text-xs font-medium text-gray-700 mb-1">Students Present Today</label>
                                <input type="number" id="presentToday" value="${presentToday}" oninput="updateReportEntry('${classId}', 'presentToday', this.value)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 font-mono text-lg ${disabledAttr ? 'bg-gray-100' : ''}" placeholder="0" min="0" ${disabledAttr}>
                            </div>
                        </div>

                        <div class="space-y-3 pt-2 border-t border-dashed">
                            <div>
                                <label for="reportBrought" class="block text-xs font-medium text-gray-700 mb-1">Students Who Brought Progress Report</label>
                                <input type="number" id="reportBrought" value="${reportBrought}" oninput="updateReportEntry('${classId}', 'progressReportBrought', this.value)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 font-mono text-lg ${disabledAttr ? 'bg-gray-100' : ''}" placeholder="0" min="0" ${disabledAttr}>
                            </div>
                            <div>
                                <label for="reportSigned" class="block text-xs font-medium text-gray-700 mb-1">Students with Signed Progress Report</label>
                                <input type="number" id="reportSigned" value="${reportSigned}" oninput="updateReportEntry('${classId}', 'progressReportSigned', this.value)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 font-mono text-lg ${disabledAttr ? 'bg-gray-100' : ''}" placeholder="0" min="0" ${disabledAttr}>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            updateModalScoreDisplay(classId);

            const modalFooter = document.getElementById('modal-footer');
            if (isEditable) {
                modalFooter.innerHTML = `
                    <button id="modal-save-button" onclick="saveClassReport()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:opacity-50 flex items-center justify-center" disabled>
                        <span id="modal-save-button-text">Save and Close Report</span>
                        <svg id="modal-save-spinner" class="animate-spin-slow h-5 w-5 text-white ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </button>
                `;
            } else {
                 modalFooter.innerHTML = `
                    <button onclick="closeModal()" class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold shadow-md hover:bg-gray-700 transition duration-150 ease-in-out">
                        Close View
                    </button>
                `;
            }
        };

        /**
         * Selects a class for detail entry and shows the modal.
         */
        window.selectClass = (classId) => {
            selectedClassId = classId;
            renderModalContent(classId);
            document.getElementById('report-modal').classList.remove('hidden');
        };

        // --- DATA INPUT & PROCESSING ---

        /**
         * Updates the local state object for the selected class report and performs data integrity checks.
         */
        window.updateReportEntry = (classId, key, value) => {
            if (selectedDateId !== todayDateId) return;

            let numValue = parseInt(value, 10);
            if (isNaN(numValue) || numValue < 0) numValue = 0;
            
            if (!currentReports[classId]) {
                currentReports[classId] = { totalStudents: 0, presentToday: 0, progressReportBrought: 0, progressReportSigned: 0 };
            }

            currentReports[classId][key] = numValue;

            const totalStudents = currentReports[classId].totalStudents || 0;
            const dependentKeys = ['presentToday', 'progressReportBrought', 'progressReportSigned'];
            
            // Logic to ensure dependent counts do not exceed totalStudents
            if (key === 'totalStudents') {
                dependentKeys.forEach(depKey => {
                    const depValue = currentReports[classId][depKey] || 0;
                    if (depValue > totalStudents) {
                        currentReports[classId][depKey] = totalStudents;
                        
                        let inputId = null;
                        if (depKey === 'presentToday') inputId = 'presentToday';
                        else if (depKey === 'progressReportBrought') inputId = 'reportBrought';
                        else if (depKey === 'progressReportSigned') inputId = 'reportSigned';
                        
                        // Must update the input element value to reflect the correction
                        const inputElement = document.getElementById(inputId);
                        if (inputElement) inputElement.value = totalStudents;
                    }
                });
            } else if (dependentKeys.includes(key) && numValue > totalStudents) {
                currentReports[classId][key] = totalStudents; 
                
                // Must update the input element value to reflect the correction
                let inputId = null;
                if (key === 'presentToday') inputId = 'presentToday';
                else if (key === 'progressReportBrought') inputId = 'reportBrought';
                else if (key === 'progressReportSigned') inputId = 'reportSigned';

                const inputElement = document.getElementById(inputId);
                if (inputElement) inputElement.value = totalStudents;
            }
            
            updateModalScoreDisplay(classId);
            document.getElementById('modal-save-button').disabled = false;
        };

        /**
         * Executes the save operation for a single class.
         */
        window.saveClassReport = async () => {
            if (selectedDateId !== todayDateId) {
                showMessage('Access Denied', 'You can only save or modify reports for the current date.');
                return;
            }
            const classId = selectedClassId;
            if (isSaving || !isAuthReady || !classId) return;

            isSaving = true;
            const saveButton = document.getElementById('modal-save-button');
            const buttonText = document.getElementById('modal-save-button-text');
            const spinner = document.getElementById('modal-save-spinner');

            saveButton.disabled = true;
            buttonText.textContent = 'Saving...';
            spinner.classList.remove('hidden');

            const report = currentReports[classId];
            if (!report || report.totalStudents <= 0) {
                showMessage('Save Failed', `Cannot save report for ${classId}. Please enter the total number of students.`);
                isSaving = false;
                saveButton.disabled = false;
                buttonText.textContent = 'Save and Close Report';
                spinner.classList.add('hidden');
                return;
            }

            try {
                // 1. Write the daily report entry
                const dailyReportDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily_attendance_reports', todayDateId);
                const updatePayload = { [classId]: { ...report, lastUpdated: serverTimestamp() } };
                await setDoc(dailyReportDocRef, updatePayload, { merge: true });

                // 2. Update Accumulated Score using a Transaction
                const newDailyScore = calculateDailyScore(report);
                const accumulatedDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'accumulated_class_scores', classId);
                let cumulativeUpdateSuccessful = false;
                let message = '';

                await runTransaction(db, async (transaction) => {
                    const accumulatedDoc = await transaction.get(accumulatedDocRef);
                    
                    // CRITICAL DEFENSE: Get data with defaults
                    const data = accumulatedDoc.exists() ? accumulatedDoc.data() : {};
                    let totalScore = data.totalScore || 0;
                    let daysCount = data.daysCount || 0;
                    let lastReportDate = data.lastReportDate || '';
                    let lastScoreContribution = data.lastScoreContribution || 0;
                    let updateRequired = false;

                    // *** CRITICAL PATCH FOR LEGACY DATA ***
                    if (accumulatedDoc.exists() && lastReportDate === todayDateId && lastScoreContribution === 0 && totalScore > 0) {
                        console.warn(`[LEGACY DATA FIX] Re-aligning lastScoreContribution from totalScore (${totalScore}) for same-day correction on ${classId}.`);
                        lastScoreContribution = totalScore;
                    }
                    // *** END LEGACY PATCH ***
                    
                    if (lastReportDate !== todayDateId) {
                        // CASE A: NEW DAY - Add new score and increment day count
                        totalScore += newDailyScore;
                        daysCount += 1;
                        lastReportDate = todayDateId;
                        message = `Report for ${classId} saved successfully, and cumulative score added for a new day.`;
                        updateRequired = true;
                    } else if (newDailyScore !== lastScoreContribution) {
                        // CASE B: SAME DAY, SCORE CHANGED - Correct the score contribution
                        
                        // Subtract the old contribution (which is now correctly aligned, even for legacy docs)
                        totalScore -= lastScoreContribution; 
                        
                        // Add the new score
                        totalScore += newDailyScore;        
                        
                        // Day count remains the same
                        daysCount = daysCount;              
                        
                        message = `Report for ${classId} saved successfully. Cumulative score corrected from ${lastScoreContribution.toFixed(2)}% to ${newDailyScore.toFixed(2)}% for today.`;
                        updateRequired = true;
                    } else {
                        // CASE C: SAME DAY, NO CHANGE
                        message = `Report for ${classId} saved successfully. Cumulative score was already counted for today with the same value.`;
                    }
                    
                    if (updateRequired) {
                        lastScoreContribution = newDailyScore; // Update the contribution to the new score
                        cumulativeUpdateSuccessful = true;

                        // Ensure we don't save an average if daysCount somehow ended up 0
                        const averageScore = daysCount > 0 ? totalScore / daysCount : 0;

                        transaction.set(accumulatedDocRef, {
                            classId: classId,
                            totalScore: totalScore,
                            daysCount: daysCount,
                            averageScore: averageScore,
                            lastReportDate: lastReportDate,
                            lastScoreContribution: lastScoreContribution, 
                            lastUpdated: serverTimestamp()
                        }, { merge: true });
                    }
                });
                
                showMessage('Success!', message);
                renderClassList();
                closeModal();

            } catch (error) {
                console.error(`Error saving report for ${classId}:`, error);
                showMessage('Error', `Failed to save report for ${classId}: ${error.message}`);
                
            } finally {
                isSaving = false;
                saveButton.disabled = false;
                buttonText.textContent = 'Save and Close Report';
                spinner.classList.add('hidden');
            }
        };

        // --- INITIALIZATION ---
        
        window.onload = () => {
            initializeFirebase();
        };
        
        // Copy user ID utility
        document.getElementById('user-id-display').addEventListener('click', () => {
            const idText = document.getElementById('user-id-display').textContent;
            const id = idText.replace('ID: ', '');
            try {
                const tempInput = document.createElement('textarea');
                tempInput.value = id;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showMessage('Copied!', `User ID: ${id} has been copied to your clipboard.`);
            } catch (err) {
                console.error('Could not copy text: ', err);
                showMessage('Error', 'Failed to copy User ID to clipboard.');
            }
        });

    </script>
</body>
</html>
