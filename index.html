<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>class-tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        /* Enforce full viewport height and prevent main page scrolling */
        html, body { 
            height: 100%;
            min-height: 100vh;
            overflow: hidden; /* Prevent page-level scroll */
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f7f9; 
            transition: background-color 0.3s;
            display: flex;
            flex-direction: column;
        }

        /* Utility classes for inputs and containers */
        
        /* Ultra-small font size utility (text-[10px] equivalent) */
        .text-2xs {
            font-size: 0.65rem; /* ~10.4px (Used for high-density labels) */
        }

        /* Custom spinner animation */
        @keyframes spin {
          to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
          animation: spin 3s linear infinite;
        }
        
    </style>
</head>
<body class="flex flex-col h-full">
    <!-- Header Section -->
<header class="flex-shrink-0 bg-white shadow-lg p-3 border-b border-gray-200 sticky top-0 z-20">
    <div class="max-w-7xl mx-auto flex justify-between items-center h-8">
        
        <button id="menu-toggle" aria-label="Toggle navigation menu" 
        class="p-2 -ml-2 text-indigo-700 hover:text-indigo-900 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded flex-shrink-0">
            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
            </svg>
        </button>
        
        <h1 class="text-xs font-extrabold text-indigo-700 flex-grow text-center sm:text-left">
            üìö Attendance Tracker
        </h1>

        <nav class="hidden sm:hidden items-center space-x-3 mx-4">
    <a href="quran-tracker.html" class="inline-block ...">Quran Tracker</a>
    <a href="contact.html" class="inline-block ...">Contact</a>
    <a href="dashboard.html" class="inline-block ...">Dashboard</a>
</nav>
        
        <div class="flex items-center space-x-2 flex-shrink-0">
            <input type="date" id="date-selector" onchange="handleDateChange(this.value)"
                   class="px-2 py-1 border border-indigo-300 rounded-lg text-xs font-semibold text-gray-700 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150 w-28">
        </div>
    <div id="user-id-display" class="hidden text-2xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full truncate max-w-[100px] cursor-pointer" 
     title="User ID. Click to Copy">
     ID: ...
</div>
    
<div id="mobile-nav-menu" class="hidden bg-white border-t border-gray-200 py-2 absolute w-full left-0 top-full shadow-xl z-10">
        <div class="flex flex-col space-y-2 px-4">
            <div class="flex flex-col space-y-1">
                <label class="text-xs font-semibold text-gray-600">Department</label>
                <select id="header-dept-selector" onchange="handleDepartmentChange(this.value)"
                       class="px-3 py-2 border border-indigo-300 rounded-lg text-sm font-semibold text-gray-700 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm transition duration-150">
                    <option value="Weekend">Weekend (WKN)</option>
                    <option value="Evening">Evening (EVN)</option>
                    <option value="FullTime">Full Time (FLT)</option>
                </select>
            </div>
            
            <button id="admin-portal-btn" onclick="openAdminPortal()" 
                    class="hidden px-3 py-2 text-sm text-center bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold shadow-md">
                üîí Admin Portal
            </button>
            
            <div id="menu-item-quran" class="flex items-center gap-2">
                <a href="quran-tracker.html" class="flex-1 px-3 py-2 text-sm text-center bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold shadow-md">
                    Quran Tracker
                </a>
                <button id="toggle-quran-btn" onclick="toggleMenuItemVisibility('quran-tracker')" class="hidden px-2 py-2 text-gray-600 hover:text-indigo-600" title="Toggle visibility">
                    <span id="eye-quran-tracker">üëÅÔ∏è</span>
                </button>
            </div>
            
            <div id="menu-item-dashboard" class="flex items-center gap-2">
                <a href="dashboard.html" class="flex-1 px-3 py-2 text-sm text-center bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-semibold shadow-md">
                    üìä Dashboard
                </a>
                <button id="toggle-dashboard-btn" onclick="toggleMenuItemVisibility('dashboard')" class="hidden px-2 py-2 text-gray-600 hover:text-indigo-600" title="Toggle visibility">
                    <span id="eye-dashboard">üëÅÔ∏è</span>
                </button>
            </div>
            <div id="user-id-display-mobile" class="text-xs text-gray-500 bg-gray-50 px-3 py-1 rounded-lg text-center mt-2 cursor-pointer border border-gray-200" 
     title="User ID. Click to Copy">
     ID: ...
</div>
        </div>
    </div>
</header>
    <!-- Main Content Area -->
    <main id="main-content-area" class="flex-grow overflow-hidden relative max-w-7xl mx-auto w-full min-h-0 p-2 flex flex-col">
        
        <!-- Loading/Initial Message Overlay (Absolute position to cover the entire main area) -->
        <div id="initial-message" class="absolute inset-0 z-10 flex flex-col items-center justify-center p-8 bg-f4f7f9/90 backdrop-blur-sm">
            <div class="flex flex-col items-center justify-center p-8 bg-white rounded-xl shadow-2xl max-w-sm mx-auto">
                <svg id="loading-spinner" class="animate-spin-slow h-8 w-8 text-indigo-500 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p id="initial-message-text" class="text-sm text-gray-600 font-semibold text-center">Connecting to database and authenticating user...</p>
                <p id="error-details" class="text-xs text-red-500 mt-2 hidden text-center font-mono"></p>
            </div>
        </div>
        
        <!-- Overall Scores View (The main, persistent grid view) -->
        <div id="scores-view" class="flex-grow overflow-y-auto space-y-3 pb-2 min-h-0">
            <!-- Class sections will be rendered here -->
        </div>

        <!-- MODAL for Daily Report Entry (New) -->
        <div id="report-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-40 flex items-center justify-center p-4" onclick="closeModal()">
            <div class="bg-white p-4 rounded-xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div id="details-panel-content">
                    <p class="text-center text-gray-500 italic py-10">Select a class to load the report entry form.</p>
                </div>
                <div id="modal-footer" class="mt-4 flex justify-center">
                    </div>
            </div>
        </div>
       
    
    <div class="h-2"></div>
</div>
        </div>
        
        <!-- Message Box for Confirmation/Errors (Replaces alert()) -->
        <div id="message-box" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 z-50 flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
                <h3 id="message-title" class="text-xl font-bold mb-3 text-indigo-700"></h3>
                <p id="message-text" class="text-gray-700 mb-4"></p>
                <button onclick="document.getElementById('message-box').classList.add('hidden')" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
                    Got It
                </button>
            </div>
        </div>
        <div id="name-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-40 flex items-center justify-center p-4" onclick="event.stopPropagation()">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
                <h3 class="text-xl font-bold mb-3 text-indigo-700">Action Required: Enter Your Name</h3>
                <p class="text-sm text-gray-700 mb-4">Please enter your name for accountability logs. This ensures your entries are logged correctly.</p>
                
                <label for="name-input" class="block text-sm font-medium text-gray-700 mb-1">Your Name (e.g., Jane Smith)</label>
                <input type="text" id="name-input" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 mb-4" 
                       placeholder="Enter your name" required>

                <button id="save-name-btn" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition disabled:opacity-50">
                    Save Name and Continue
                </button>
            </div>
        </div>

        <!-- Manage Classes Modal -->
        <div id="manage-classes-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-40 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-indigo-700">Manage Classes & Departments</h3>
                    <button onclick="closeManageClassesModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <!-- Add New Department -->
                <div class="mb-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
                    <h4 class="text-lg font-bold text-gray-700 mb-3">Add New Department</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Department Name</label>
                            <input type="text" id="new-dept-name" placeholder="e.g., Summer" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Abbreviation</label>
                            <input type="text" id="new-dept-abbr" placeholder="e.g., SMR" maxlength="3"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                        </div>
                        <div class="flex items-end">
                            <button onclick="addNewDepartment()" class="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 transition">
                                ‚ûï Add Department
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-800"><strong>Current Department:</strong> <span id="current-dept-display" class="font-semibold"></span></p>
                </div>

                <!-- Current Classes List -->
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-gray-700 mb-3">Current Classes</h4>
                    <div id="current-classes-list" class="space-y-2"></div>
                </div>

                <!-- Add New Class -->
                <div class="border-t pt-4">
                    <h4 class="text-lg font-bold text-gray-700 mb-3">Add New Class</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                            <select id="new-class-gender" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="Girls">Girls</option>
                                <option value="Boys">Boys</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Class Name</label>
                            <input type="text" id="new-class-name" placeholder="e.g., 5" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div class="flex items-end">
                            <button onclick="addNewClass()" class="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition">
                                ‚ûï Add Class
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t flex justify-between">
                    <button onclick="saveAndCloseManageClassesModal()" class="px-6 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                        üíæ Save & Close
                    </button>
                    <button onclick="closeManageClassesModal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition">
                        Close
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Admin Portal Modal -->
        <div id="admin-portal-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 z-40 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-red-700">üîí Admin Portal</h3>
                    <button onclick="closeAdminPortal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <!-- Admin Status -->
                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p class="text-sm text-red-800"><strong>Admin User:</strong> <span id="admin-user-id" class="font-mono"></span></p>
                </div>
                
                <!-- Manage Admins Section -->
                <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h4 class="text-lg font-bold text-gray-700 mb-3">Manage Admins</h4>
                    
                    <!-- Current Admins List -->
                    <div class="mb-4">
                        <h5 class="text-sm font-semibold text-gray-600 mb-2">Current Admins</h5>
                        <div id="admin-list" class="space-y-2 max-h-40 overflow-y-auto"></div>
                    </div>
                    
                    <!-- Add New Admin -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div class="md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                            <input type="text" id="new-admin-id" placeholder="Enter user ID to make admin" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div class="flex items-end">
                            <button onclick="addNewAdmin()" class="w-full bg-red-600 text-white py-2 rounded-lg font-semibold hover:bg-red-700 transition">
                                ‚ûï Add Admin
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Manage Classes & Departments Section -->
                <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
                    <h4 class="text-lg font-bold text-gray-700 mb-3">Manage Classes & Departments</h4>
                    <button onclick="openManageClassesModal()" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
                        ‚öôÔ∏è Open Class Management
                    </button>
                </div>
                
                <div class="mt-4 pt-4 border-t flex justify-end">
                    <button onclick="closeAdminPortal()" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase SDK Imports -->
    <script type="module">
        // Use a consistent major version for all Firebase SDK components to prevent console warnings.
        // We use static strings in the imports to avoid the SyntaxError: Unexpected template string.
        const FIREBASE_VERSION = "10.10.0"; 

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            updateDoc,
            onSnapshot, 
            collection, 
            serverTimestamp,
            runTransaction,
            setLogLevel,
            getDoc,
            addDoc,
            writeBatch,
            query, // <-- New
            where, // <-- New
            orderBy // <-- New
        } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
        // --- FIREBASE CONFIGURATION (CRITICAL: Using user-provided config as base) ---
        
        const USER_PROVIDED_FIREBASE_CONFIG = {
            // API key from the user's latest console output
            apiKey: "AIzaSyAjGzS58U5ybbI5CYJUk2NRZBuLJpMJihQ", 
            authDomain: "apps-e1163.firebaseapp.com",
            projectId: "apps-e1163",
            storageBucket: "apps-e1163.firebasestorage.app",
            messagingSenderId: "855206153422",
            appId: "1:855206153422:web:2a1366b2e7825304c3d49f",
            measurementId: "G-7YCKESJB8T" 
        };
        
        // Prioritize Canvas injected config if it exists, otherwise use the user's config
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : USER_PROVIDED_FIREBASE_CONFIG;
            
        // Use injected app ID or fallback to the project ID if all else fails
        const appId = typeof __app_id !== 'undefined' 
            ? __app_id 
            : firebaseConfig.projectId; 
            
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' 
            ? __initial_auth_token 
            : null; 
        // --- END FIREBASE CONFIGURATION ---

        setLogLevel('Debug');

        // --- GLOBAL STATE & FIREBASE INIT ---
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentReports = {}; // Daily report entries for the SELECTED DAY
        let currentAccumulatedScores = {}; // Accumulated scores (all classes)
        let selectedClassId = null; 
        
        // Department selection - restore from localStorage or default to Weekend
        let selectedDepartment = localStorage.getItem('selectedDepartment') || 'Weekend'; 
        let isSaving = false;
        let currentUserName = null; // New global variable to hold the user's name
        
        // Admin management
        let ADMIN_LIST = ['MpcB7f35m0bITsSK1D7ACWFmch32']; // Default admin
        let isAdmin = false;
        let MENU_VISIBILITY = {
            'quran-tracker': true,
            'dashboard': true
        };
        
        const getTodayDateId = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };
        const todayDateId = getTodayDateId();
        let selectedDateId = todayDateId;

        // Load class definitions from localStorage or use defaults
        const DEFAULT_CLASS_DEFINITIONS = {
            'Weekend': [
                { id: 'Weekend-Girls-1A', name: '1-A', gender: 'Girls' },
                { id: 'Weekend-Girls-1B', name: '1-B', gender: 'Girls' },
                { id: 'Weekend-Girls-1C', name: '1-C', gender: 'Girls' },
                { id: 'Weekend-Girls-2', name: '2', gender: 'Girls' },
                { id: 'Weekend-Girls-3', name: '3', gender: 'Girls' },
                { id: 'Weekend-Girls-4', name: '4', gender: 'Girls' },
                { id: 'Weekend-Boys-1A', name: '1-A', gender: 'Boys' },
                { id: 'Weekend-Boys-1B', name: '1-B', gender: 'Boys' },
                { id: 'Weekend-Boys-1C', name: '1-C', gender: 'Boys' },
                { id: 'Weekend-Boys-2', name: '2', gender: 'Boys' },
                { id: 'Weekend-Boys-3', name: '3', gender: 'Boys' },
                { id: 'Weekend-Boys-4', name: '4', gender: 'Boys' },
            ],
            'Evening': [
                { id: 'Evening-Girls-1A', name: '1-A', gender: 'Girls' },
                { id: 'Evening-Girls-1B', name: '1-B', gender: 'Girls' },
                { id: 'Evening-Girls-2', name: '2', gender: 'Girls' },
                { id: 'Evening-Girls-3', name: '3', gender: 'Girls' },
                { id: 'Evening-Boys-1A', name: '1-A', gender: 'Boys' },
                { id: 'Evening-Boys-1B', name: '1-B', gender: 'Boys' },
                { id: 'Evening-Boys-2', name: '2', gender: 'Boys' },
                { id: 'Evening-Boys-3', name: '3', gender: 'Boys' },
            ],
            'FullTime': [
                { id: 'FullTime-Girls-1', name: '1', gender: 'Girls' },
                { id: 'FullTime-Girls-2', name: '2', gender: 'Girls' },
                { id: 'FullTime-Girls-3', name: '3', gender: 'Girls' },
                { id: 'FullTime-Boys-1', name: '1', gender: 'Boys' },
                { id: 'FullTime-Boys-2', name: '2', gender: 'Boys' },
                { id: 'FullTime-Boys-3', name: '3', gender: 'Boys' },
            ]
        };

        // Load from localStorage or use defaults (will be replaced by Firebase data after auth)
        let CLASS_DEFINITIONS = DEFAULT_CLASS_DEFINITIONS;
        
        // Save class definitions to Firebase
        const saveClassDefinitions = async () => {
            try {
                console.log('Saving class definitions to Firebase...', CLASS_DEFINITIONS);
                const classDefsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'class_definitions', 'current');
                await setDoc(classDefsDocRef, CLASS_DEFINITIONS, { merge: true });
                console.log('‚úÖ Class definitions saved to Firebase successfully');
            } catch (error) {
                console.error('‚ùå Error saving class definitions:', error);
                showMessage('Error', 'Failed to save class definitions. Check console.');
            }
        };
        
        // Load class definitions from Firebase
        const loadClassDefinitions = async () => {
            try {
                const classDefsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'class_definitions', 'current');
                const docSnap = await getDoc(classDefsDocRef);
                
                if (docSnap.exists()) {
                    const firebaseData = docSnap.data();
                    // Use Firebase data and merge with defaults
                    CLASS_DEFINITIONS = { ...DEFAULT_CLASS_DEFINITIONS, ...firebaseData };
                    console.log('Class definitions loaded from Firebase');
                    updateDepartmentDropdown();
                } else {
                    console.log('No class definitions in Firebase, using defaults');
                    CLASS_DEFINITIONS = DEFAULT_CLASS_DEFINITIONS;
                    updateDepartmentDropdown();
                }
            } catch (error) {
                console.error('Error loading class definitions:', error);
                CLASS_DEFINITIONS = DEFAULT_CLASS_DEFINITIONS;
                updateDepartmentDropdown();
            }
        };
        
        // Set up real-time listener for class definitions
        const setupClassDefinitionsListener = () => {
            try {
                console.log('üîä Setting up real-time listener for class definitions...');
                const classDefsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'class_definitions', 'current');
                
                onSnapshot(classDefsDocRef, (docSnap) => {
                    console.log('üì° Class definitions snapshot received');
                    if (docSnap.exists()) {
                        const firebaseData = docSnap.data();
                        console.log('üì¶ Firebase data:', firebaseData);
                        // Use Firebase data and merge with defaults
                        CLASS_DEFINITIONS = { ...DEFAULT_CLASS_DEFINITIONS, ...firebaseData };
                        console.log('‚úÖ Class definitions updated from Firebase real-time listener');
                        
                        // Update department dropdown
                        updateDepartmentDropdown();
                        
                        // Re-render the class list in the attendance section
                        renderClassList();
                        
                        // If the manage classes modal is open, update it too
                        const manageClassesModal = document.getElementById('manage-classes-modal');
                        if (manageClassesModal && !manageClassesModal.classList.contains('hidden')) {
                            renderCurrentClassesList();
                        }
                    } else {
                        console.log('‚ö†Ô∏è No class definitions document exists yet');
                    }
                }, (error) => {
                    console.error('‚ùå Error in class definitions listener:', error);
                });
                console.log('‚úÖ Real-time listener setup complete');
            } catch (error) {
                console.error('‚ùå Error setting up class definitions listener:', error);
            }
        };
        
        // Helper to update department dropdown with all available departments
        const updateDepartmentDropdown = () => {
            const dropdown = document.getElementById('header-dept-selector');
            const currentValue = dropdown.value;
            
            // Clear existing options
            dropdown.innerHTML = '';
            
            // Add all departments from CLASS_DEFINITIONS
            Object.keys(CLASS_DEFINITIONS).forEach(deptName => {
                const option = document.createElement('option');
                option.value = deptName;
                
                // Use known abbreviations or create one from first 3 letters
                let abbr = deptName.substring(0, 3).toUpperCase();
                if (deptName === 'Weekend') abbr = 'WKN';
                if (deptName === 'Evening') abbr = 'EVN';
                if (deptName === 'FullTime') abbr = 'FLT';
                
                option.textContent = `${deptName} (${abbr})`;
                dropdown.appendChild(option);
            });
            
            // Restore previous selection if it still exists
            if (CLASS_DEFINITIONS[currentValue]) {
                dropdown.value = currentValue;
            } else if (CLASS_DEFINITIONS[selectedDepartment]) {
                dropdown.value = selectedDepartment;
            }
        };
        
        // Helper to get current class definitions
        const getCurrentClassDefinitions = () => CLASS_DEFINITIONS[selectedDepartment];
        
        // Helper to normalize old class IDs to new format (for backward compatibility)
        const normalizeClassId = (classId) => {
            // If already has department prefix, return as-is
            if (classId.startsWith('Weekend-') || classId.startsWith('Evening-') || classId.startsWith('FullTime-')) {
                return classId;
            }
            // Otherwise, assume it's Weekend data (legacy format)
            return `Weekend-${classId}`;
        };
        
        // --- ADMIN MANAGEMENT FUNCTIONS ---
        
        // Load admin list from Firebase
        const loadAdminList = async () => {
            try {
                const adminDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'admins', 'list');
                const docSnap = await getDoc(adminDocRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    ADMIN_LIST = data.admins || ['MpcB7f35m0bITsSK1D7ACWFmch32'];
                    console.log('Admin list loaded from Firebase:', ADMIN_LIST);
                } else {
                    console.log('No admin list in Firebase, using default');
                    ADMIN_LIST = ['MpcB7f35m0bITsSK1D7ACWFmch32'];
                    await saveAdminList(); // Save default to Firebase
                }
                
                checkAdminStatus();
            } catch (error) {
                console.error('Error loading admin list:', error);
                ADMIN_LIST = ['MpcB7f35m0bITsSK1D7ACWFmch32'];
                checkAdminStatus();
            }
        };
        
        // Save admin list to Firebase
        const saveAdminList = async () => {
            try {
                const adminDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'admins', 'list');
                await setDoc(adminDocRef, { admins: ADMIN_LIST });
                console.log('‚úÖ Admin list saved to Firebase');
            } catch (error) {
                console.error('‚ùå Error saving admin list:', error);
                showMessage('Error', 'Failed to save admin list.');
            }
        };
        
        // Check if current user is admin
        const checkAdminStatus = () => {
            isAdmin = ADMIN_LIST.includes(userId);
            console.log('Admin status for', userId, ':', isAdmin);
            
            // Show/hide admin portal button
            const adminBtn = document.getElementById('admin-portal-btn');
            if (isAdmin) {
                adminBtn.classList.remove('hidden');
            } else {
                adminBtn.classList.add('hidden');
            }
        };
        
        // Open admin portal
        window.openAdminPortal = () => {
            if (!isAdmin) {
                showMessage('Access Denied', 'You do not have admin privileges.');
                return;
            }
            
            document.getElementById('admin-user-id').textContent = userId;
            renderAdminList();
            document.getElementById('admin-portal-modal').classList.remove('hidden');
            document.getElementById('mobile-nav-menu').classList.add('hidden');
        };
        
        // Close admin portal
        window.closeAdminPortal = () => {
            document.getElementById('admin-portal-modal').classList.add('hidden');
        };
        
        // Render admin list
        const renderAdminList = () => {
            const container = document.getElementById('admin-list');
            container.innerHTML = '';
            
            ADMIN_LIST.forEach(adminId => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-white border border-gray-200 rounded-lg';
                
                const idSpan = document.createElement('span');
                idSpan.className = 'font-mono text-xs text-gray-700';
                idSpan.textContent = adminId;
                
                // Only allow removing other admins, not yourself
                if (adminId !== userId) {
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'text-red-500 hover:text-red-700 text-sm';
                    removeBtn.textContent = '‚úñ Remove';
                    removeBtn.onclick = () => removeAdmin(adminId);
                    
                    div.appendChild(idSpan);
                    div.appendChild(removeBtn);
                } else {
                    const youBadge = document.createElement('span');
                    youBadge.className = 'text-xs bg-green-100 text-green-700 px-2 py-1 rounded';
                    youBadge.textContent = 'You';
                    
                    div.appendChild(idSpan);
                    div.appendChild(youBadge);
                }
                
                container.appendChild(div);
            });
        };
        
        // Add new admin
        window.addNewAdmin = async () => {
            const newAdminId = document.getElementById('new-admin-id').value.trim();
            
            if (!newAdminId) {
                showMessage('Error', 'Please enter a user ID.');
                return;
            }
            
            if (ADMIN_LIST.includes(newAdminId)) {
                showMessage('Error', 'This user is already an admin.');
                return;
            }
            
            ADMIN_LIST.push(newAdminId);
            await saveAdminList();
            
            document.getElementById('new-admin-id').value = '';
            renderAdminList();
            
            showMessage('Success', `User ${newAdminId} added as admin!`);
        };
        
        // Remove admin
        const removeAdmin = async (adminId) => {
            if (adminId === userId) {
                showMessage('Error', 'You cannot remove yourself as admin.');
                return;
            }
            
            if (ADMIN_LIST.length <= 1) {
                showMessage('Error', 'Cannot remove the last admin.');
                return;
            }
            
            ADMIN_LIST = ADMIN_LIST.filter(id => id !== adminId);
            await saveAdminList();
            
            renderAdminList();
            showMessage('Success', `Admin ${adminId} removed.`);
        };
        
        // --- MENU VISIBILITY MANAGEMENT ---
        
        // Load menu visibility settings from Firebase
        const loadMenuVisibility = async () => {
            try {
                const menuDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'menu_visibility');
                const docSnap = await getDoc(menuDocRef);
                
                if (docSnap.exists()) {
                    MENU_VISIBILITY = docSnap.data();
                    console.log('Menu visibility loaded from Firebase:', MENU_VISIBILITY);
                } else {
                    console.log('No menu visibility settings in Firebase, using defaults');
                    MENU_VISIBILITY = {
                        'quran-tracker': true,
                        'dashboard': true
                    };
                    await saveMenuVisibility();
                }
                
                updateMenuDisplay();
            } catch (error) {
                console.error('Error loading menu visibility:', error);
                MENU_VISIBILITY = {
                    'quran-tracker': true,
                    'dashboard': true
                };
                updateMenuDisplay();
            }
        };
        
        // Save menu visibility settings to Firebase
        const saveMenuVisibility = async () => {
            try {
                const menuDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'menu_visibility');
                await setDoc(menuDocRef, MENU_VISIBILITY);
                console.log('‚úÖ Menu visibility saved to Firebase');
            } catch (error) {
                console.error('‚ùå Error saving menu visibility:', error);
            }
        };
        
        // Update menu display based on visibility settings and admin status
        const updateMenuDisplay = () => {
            // Show/hide menu items based on visibility (for non-admins)
            if (!isAdmin) {
                // Regular users only see visible items
                const quranItem = document.getElementById('menu-item-quran');
                const dashboardItem = document.getElementById('menu-item-dashboard');
                
                if (quranItem) {
                    quranItem.style.display = MENU_VISIBILITY['quran-tracker'] ? 'flex' : 'none';
                }
                if (dashboardItem) {
                    dashboardItem.style.display = MENU_VISIBILITY['dashboard'] ? 'flex' : 'none';
                }
            } else {
                // Admins see all items with toggle buttons
                const quranItem = document.getElementById('menu-item-quran');
                const dashboardItem = document.getElementById('menu-item-dashboard');
                
                if (quranItem) quranItem.style.display = 'flex';
                if (dashboardItem) dashboardItem.style.display = 'flex';
                
                // Show toggle buttons for admins
                document.getElementById('toggle-quran-btn').classList.remove('hidden');
                document.getElementById('toggle-dashboard-btn').classList.remove('hidden');
                
                // Update eye icons
                updateEyeIcon('quran-tracker');
                updateEyeIcon('dashboard');
            }
        };
        
        // Update eye icon based on visibility
        const updateEyeIcon = (itemKey) => {
            const eyeSpan = document.getElementById(`eye-${itemKey}`);
            if (eyeSpan) {
                eyeSpan.textContent = MENU_VISIBILITY[itemKey] ? 'üëÅÔ∏è' : 'üôà';
                eyeSpan.title = MENU_VISIBILITY[itemKey] ? 'Visible to users' : 'Hidden from users';
            }
        };
        
        // Toggle menu item visibility
        window.toggleMenuItemVisibility = async (itemKey) => {
            if (!isAdmin) {
                showMessage('Access Denied', 'Only admins can change menu visibility.');
                return;
            }
            
            MENU_VISIBILITY[itemKey] = !MENU_VISIBILITY[itemKey];
            await saveMenuVisibility();
            updateEyeIcon(itemKey);
            updateMenuDisplay();
            
            const status = MENU_VISIBILITY[itemKey] ? 'visible' : 'hidden';
            showMessage('Success', `Menu item is now ${status} to users.`);
        };
        
        // --- UTILITY FUNCTIONS ---
        
        /**
         * Shows a custom modal to prompt the user for their name, returning a Promise 
         * that resolves with the name or rejects if cancelled/empty.
         */
        const promptForUserName = () => {
            return new Promise((resolve, reject) => {
                const nameModal = document.getElementById('name-modal');
                const nameInput = document.getElementById('name-input');
                const saveButton = document.getElementById('save-name-btn');
                
                // Clear any previous input and show the modal
                nameInput.value = '';
                saveButton.disabled = true;
                nameModal.classList.remove('hidden');

                const validateAndSave = () => {
                    const name = nameInput.value.trim();
                    if (name) {
                        nameModal.classList.add('hidden');
                        cleanupListeners();
                        resolve(name);
                    } else {
                        // Optionally provide visual feedback for empty input
                        nameInput.focus();
                        showMessage('Input Needed', 'Please enter a valid name to proceed.');
                    }
                };
                
                const handleKeydown = (e) => {
                    // Enable save button on input change
                    saveButton.disabled = nameInput.value.trim().length === 0;
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        if (!saveButton.disabled) {
                            validateAndSave();
                        }
                    }
                };

                const cleanupListeners = () => {
                    saveButton.removeEventListener('click', validateAndSave);
                    nameInput.removeEventListener('input', handleKeydown);
                    nameInput.removeEventListener('keydown', handleKeydown);
                };

                // Add listeners
                saveButton.addEventListener('click', validateAndSave);
                nameInput.addEventListener('input', handleKeydown);
                nameInput.addEventListener('keydown', handleKeydown);
                
                // Set focus to the input field
                nameInput.focus();
            });
        };

        /**
         * Custom function to display a message to the user (replaces alert()).
         */
        window.showMessage = (title, text) => {
            const box = document.getElementById('message-box');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = text;
            box.classList.remove('hidden');
        };
        

        /**
         * Closes the modal.
         */
        window.closeModal = () => {
            document.getElementById('report-modal').classList.add('hidden');
            selectedClassId = null;
        }
        /**
 * Prompts the user for their name if it hasn't been set, then fetches it from Firestore.
 * If not in Firestore, prompts the user and saves it to Firestore (and local state).
 * Sets the global currentUserName.
 */
const ensureUserName = async () => {
    // If we already have a name in memory, return.
    if (currentUserName) return; 

    // 1. Try reading from Firestore
    const userDocRef = doc(db, 'users', userId);
    try {
        const userDoc = await getDoc(userDocRef);
        if (userDoc.exists() && userDoc.data().userName) {
            currentUserName = userDoc.data().userName;
            console.log("User name fetched from Firestore:", currentUserName);
            return;
        }
    } catch (error) {
        console.error("Error fetching user name from Firestore:", error);
        // Continue to prompt if fetch fails
    }

    // 2. If no name found, actively prompt the user using the custom modal
    try {
        const name = await promptForUserName();
        if (name) {
            currentUserName = name;
            
            // 3. Save the newly entered name to Firestore
            await setDoc(userDocRef, { 
                userName: name,
                lastLogin: serverTimestamp()
            }, { merge: true });
            console.log(`User name "${name}" saved to Firestore.`);
        }
    } catch (error) {
        // User cancelled or an error occurred. currentUserName remains null.
        console.log("Name entry cancelled or failed:", error.message);
    }
};

        /**
         * Formats a Firebase timestamp for display.
         */
        const formatTimestamp = (timestamp) => {
            if (!timestamp) return 'N/A';
            // Firebase timestamps can be an object with 'seconds' and 'nanoseconds'
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleString();
        };

        /**
 * Fetches and renders the log history for a specific class from the NEW audit_trail subcollection.
 */
const fetchAndRenderLogHistory = (classId) => {
    // NEW PATH: Listen to the audit_trail subcollection under the date document
    const auditTrailColRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_attendance_reports', selectedDateId, 'audit_trail');
    const logHistoryContainer = document.getElementById('log-history-container');
    if (!logHistoryContainer) return;

    // Build a query to fetch ALL logs for the day, sorted by time.
    // This avoids the composite index requirement by removing the 'where' filter.
    const logsQuery = query(
        auditTrailColRef,
        orderBy('timestamp', 'desc')
    );

    // Simple unsubscribe if we switch classes
    if (window.logHistoryUnsubscribe) {
        window.logHistoryUnsubscribe();
    }

    // Set up a real-time listener for the logs
    window.logHistoryUnsubscribe = onSnapshot(logsQuery, (querySnapshot) => {
        let logHtml = '';
        const allLogs = [];
        
        // 1. Fetch ALL logs for the date
        querySnapshot.forEach(doc => allLogs.push(doc.data()));

        // 2. Filter logs client-side to only show the selected class
        const logs = allLogs.filter(log => log.classId === classId);

        if (logs.length === 0) {
            logHtml = '<p class="text-sm text-gray-500 italic text-center py-4">No log history found for this class.</p>';
        } else {
            // Logs are already sorted by time (via the simplified query) and now filtered by class
            logHtml = logs.map(log => `
                        <div class="border-b border-gray-100 py-2 last:border-b-0">
                            <p class="text-xs font-semibold text-gray-800">${log.userName || 'Unknown User'}</p>
                            <p class="text-2xs text-gray-500">${formatTimestamp(log.timestamp)}</p>
                            <p class="text-xs text-gray-600">Action: ${log.action || 'Report Saved/Updated'}</p>
                        </div>
                    `).join('');
        }
        
        logHistoryContainer.innerHTML = `
                    <h3 class="text-lg font-bold text-gray-700 border-b pb-1 mb-2">Accountability Log</h3>
                    ${logHtml}
                `;
    }, (error) => {
        console.error("Error fetching log history:", error);
        logHistoryContainer.innerHTML = '<p class="text-sm text-red-500 italic text-center py-4">Error loading log history.</p>';
    });
};

        /**
         * Converts YYYY-MM-DD date ID to a display format.
         */
        const getDisplayDate = (dateId) => {
            const parts = dateId.split('-');
            // Note: Months in Date() constructor are 0-indexed, so -1 is correct.
            const date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])); 
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const suffix = dateId === todayDateId ? ' (Today)' : '';
            return date.toLocaleDateString(undefined, options) + suffix;
        };
        
        /**
         * Handles the change event from the date selector input.
         */
        window.handleDateChange = (newDateId) => {
            if (newDateId === selectedDateId) return;
            selectedDateId = newDateId;
            // Show loading message when date changes
            const initialMessage = document.getElementById('initial-message');
            initialMessage.classList.remove('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('initial-message-text').textContent = `Fetching reports for ${getDisplayDate(selectedDateId)}...`;
            
            // Re-setup listeners which will trigger a new renderClassList call
            setupFirestoreListeners();
        };

        /**
         * Handles department change from the department picker
         */
        window.handleDepartmentChange = (newDepartment) => {
            if (newDepartment === selectedDepartment) return;
            selectedDepartment = newDepartment;
            
            // Update dropdown
            document.getElementById('header-dept-selector').value = newDepartment;
            
            // Close hamburger menu
            document.getElementById('mobile-nav-menu').classList.add('hidden');
            
            // Save to localStorage
            localStorage.setItem('selectedDepartment', newDepartment);
            
            // Clear current data
            currentReports = {};
            currentAccumulatedScores = {};
            
            // Show loading message
            const initialMessage = document.getElementById('initial-message');
            initialMessage.classList.remove('hidden');
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('initial-message-text').textContent = `Loading ${newDepartment} classes...`;
            
            // Re-setup listeners with new department
            setupFirestoreListeners();
        };

        /**
         * Opens the manage classes modal
         */
        window.openManageClassesModal = () => {
            document.getElementById('current-dept-display').textContent = selectedDepartment;
            renderCurrentClassesList();
            document.getElementById('manage-classes-modal').classList.remove('hidden');
        };

        /**
         * Closes the manage classes modal
         */
        window.closeManageClassesModal = () => {
            document.getElementById('manage-classes-modal').classList.add('hidden');
        };

        /**
         * Saves changes and closes the manage classes modal
         */
        window.saveAndCloseManageClassesModal = async () => {
            try {
                await saveClassDefinitions();
                showMessage('Success', 'All changes have been saved!');
                document.getElementById('manage-classes-modal').classList.add('hidden');
            } catch (error) {
                console.error('Error saving:', error);
                showMessage('Error', 'Failed to save changes. Please try again.');
            }
        };

        /**
         * Renders the list of current classes in the modal
         */
        const renderCurrentClassesList = () => {
            const container = document.getElementById('current-classes-list');
            const classes = getCurrentClassDefinitions();
            
            if (classes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">No classes in this department yet.</p>';
                return;
            }

            container.innerHTML = classes.map((cls, index) => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div>
                        <span class="font-semibold text-gray-700">${cls.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(${cls.gender})</span>
                    </div>
                </div>
            `).join('');
        };

        /**
         * Adds a new class to the current department
         */
        window.addNewDepartment = async () => {
            const name = document.getElementById('new-dept-name').value.trim();
            const abbr = document.getElementById('new-dept-abbr').value.trim().toUpperCase();

            console.log('‚ûï Adding new department:', { name, abbr });

            if (!name || !abbr) {
                showMessage('Error', 'Please enter both department name and abbreviation.');
                return;
            }

            // Check if department already exists
            if (CLASS_DEFINITIONS[name]) {
                showMessage('Error', 'A department with this name already exists.');
                return;
            }

            // Add the new department with empty class array
            CLASS_DEFINITIONS[name] = [];
            console.log('üìù Added new department to CLASS_DEFINITIONS:', name);

            // Save to Firebase
            console.log('üíæ Calling saveClassDefinitions...');
            await saveClassDefinitions();
            console.log('‚úÖ Save complete');

            // Add to dropdown
            const dropdown = document.getElementById('header-dept-selector');
            const option = document.createElement('option');
            option.value = name;
            option.textContent = `${name} (${abbr})`;
            dropdown.appendChild(option);

            // Clear inputs
            document.getElementById('new-dept-name').value = '';
            document.getElementById('new-dept-abbr').value = '';

            showMessage('Success', `Department "${name}" (${abbr}) added successfully!`);
        };

        window.addNewClass = async () => {
            const gender = document.getElementById('new-class-gender').value;
            const name = document.getElementById('new-class-name').value.trim();

            console.log('‚ûï Adding new class:', { gender, name, department: selectedDepartment });

            if (!name) {
                showMessage('Error', 'Please enter a class name.');
                return;
            }

            // Generate class ID
            const classId = `${selectedDepartment}-${gender}-${name}`;
            console.log('üÜî Generated class ID:', classId);

            // Check if class already exists
            if (getCurrentClassDefinitions().some(c => c.id === classId)) {
                showMessage('Error', 'A class with this name and gender already exists.');
                return;
            }

            // Add the new class
            CLASS_DEFINITIONS[selectedDepartment].push({
                id: classId,
                name: name,
                gender: gender
            });
            console.log('üìù Added to local CLASS_DEFINITIONS:', CLASS_DEFINITIONS[selectedDepartment]);

            // Save to Firebase
            console.log('üíæ Calling saveClassDefinitions...');
            await saveClassDefinitions();
            console.log('‚úÖ Save complete');

            // Clear input
            document.getElementById('new-class-name').value = '';

            // Refresh the list
            renderCurrentClassesList();
            renderClassList();

            showMessage('Success', `Class "${name}" (${gender}) added successfully!`);
        };

        /**
         * Calculates the Daily Class Score (DCS) out of 100 based on number of students.
         */
        /**
         * Calculates the Daily Class Score (DCS) out of 100 based on number of students.
         */
        /**
         * Calculates the Daily Class Score (DCS) out of 100 based on number of students.
         */
        const calculateDailyScore = (report) => {
            // CRITICAL DEFENSE: Use 0 if a key is missing from the report object
            const totalStudents = report.totalStudents || 0;
            const presentToday = report.presentToday || 0;
            const tardyToday = report.tardyToday || 0;
            const progressReportBrought = report.progressReportBrought || 0;
            const progressReportSigned = report.progressReportSigned || 0;

            if (totalStudents <= 0) return 0; 
            
            // Attendance (50%) [Present=1, Tardy=0.5] + Report Brought (25%) + Report Signed (25%)
            // We clamp (Present + Tardy) to Total just in case data is temporarily inconsistent
            const attendanceVal = Math.min(presentToday + (tardyToday * 0.5), totalStudents);
            
            const attendanceScore = 50 * (attendanceVal / totalStudents);
            const broughtScore = 25 * (Math.min(progressReportBrought, totalStudents) / totalStudents);
            const signedScore = 25 * (Math.min(progressReportSigned, totalStudents) / totalStudents);
            
            return Math.round((attendanceScore + broughtScore + signedScore) * 100) / 100;
        };
        
        /**
         * Determines the color coding for the card border based on the CUMULATIVE average score.
         */
        const getPerformanceBorder = (cumulativeAvg, hasData) => {
            if (!hasData || cumulativeAvg === null) return 'border-gray-300';
            if (cumulativeAvg >= 80) return 'border-green-500';
            if (cumulativeAvg >= 50) return 'border-yellow-500';
            return 'border-red-500';
        };

        /**
         * Determines the performance label and associated Tailwind classes based on the CUMULATIVE average score.
         */
        const getPerformanceStatus = (cumulativeAvg, hasData) => {
            if (!hasData || cumulativeAvg === null) {
                return { text: 'No Data', bg: 'bg-gray-100', text_color: 'text-gray-500', bar_color: 'bg-gray-400', score_color: 'text-gray-500' };
            }
            // CRITICAL CHECK: If the average is somehow over 100 (due to the bug), display an error status
            if (cumulativeAvg > 100.01) {
                 return { text: 'DATA ERROR', bg: 'bg-red-200', text_color: 'text-red-800', bar_color: 'bg-red-700', score_color: 'text-red-800' };
            }
            if (cumulativeAvg >= 80) {
                return { text: 'Excellent', bg: 'bg-green-100', text_color: 'text-green-700', bar_color: 'bg-green-500', score_color: 'text-green-700' };
            }
            if (cumulativeAvg >= 50) {
                return { text: 'Good', bg: 'bg-yellow-100', text_color: 'text-yellow-700', bar_color: 'bg-yellow-500', score_color: 'text-yellow-700' };
            }
            return { text: 'Poor', bg: 'bg-red-100', text_color: 'text-red-700', bar_color: 'bg-red-500', score_color: 'text-red-700' };
        };

        /**
         * Helper function to hide the modal. It must be a global function for the HTML onclick to work.
         */
        window.closeModal = () => {
            document.getElementById('report-modal').classList.add('hidden');
            selectedClassId = null; 
        };

        /**
         * Generates the HTML form for data entry inside the modal.
         * @param {object} classDef - The class definition object.
         * @param {object} report - The current daily report data for this class/day.
         * @returns {string} The full HTML string for the form.
         */
        /**
         * Generates the HTML form for data entry inside the modal.
         */
        const renderReportForm = (classDef, report) => {
            const isReportEntered = report.totalStudents !== undefined && report.totalStudents !== 0;

            // Default values
            const defaultTotal = report.totalStudents || '';
            const defaultPresentOnTime = report.presentToday || '';
            const defaultTardy = report.tardyToday || '';
            const defaultBrought = report.progressReportBrought || '';
            const defaultSigned = report.progressReportSigned || '';

            // Calculate Present Total and Absent for display if data exists
            let defaultPresentTotal = '';
            let defaultAbsent = '';
            if (defaultPresentOnTime !== '' || defaultTardy !== '') {
                const onTime = parseInt(defaultPresentOnTime) || 0;
                const tardy = parseInt(defaultTardy) || 0;
                defaultPresentTotal = onTime + tardy;
            }
            if (defaultTotal !== '' && defaultPresentTotal !== '') {
                defaultAbsent = parseInt(defaultTotal) - parseInt(defaultPresentTotal);
            }

            const sectionType = classDef.id.startsWith('Girls') ? 'Girls' : 'Boys';
            const cardBgColor = sectionType === 'Girls' ? 'bg-pink-50' : 'bg-blue-50';

            // --- Form Inputs ---
            const createInput = (id, label, placeholder, value, isReadOnly = false) => `
                <div class="flex flex-col space-y-1">
                    <label for="${id}" class="text-sm font-medium text-gray-700">${label}</label>
                    <input type="number" id="${id}" placeholder="${placeholder}" value="${value}" 
                           min="0" ${isReadOnly ? 'readonly disabled class="w-full px-3 py-2 border border-gray-200 bg-gray-100 text-gray-500 rounded-lg shadow-sm"' : 'required class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"'} >
                </div>
            `;

            // --- Main HTML Structure ---
            return `
                <h2 class="text-2xl font-extrabold text-gray-900 mb-2">${classDef.name} Report Entry</h2>
                <p class="text-sm text-gray-500 mb-4 border-b pb-2">Reports for: <span class="font-semibold text-indigo-600">${getDisplayDate(selectedDateId)}</span></p>

                <div class="grid grid-cols-2 gap-4 p-4 ${cardBgColor} rounded-xl">
                    ${createInput('input-totalStudents', 'Total Students', 'e.g., 30', defaultTotal)}
                    ${createInput('input-absentToday', 'Absent (Auto)', 'Calc', defaultAbsent, true)}
                    
                    ${createInput('input-presentOnTime', 'Present On-Time', 'e.g., 25', defaultPresentOnTime)}
                    ${createInput('input-tardyToday', 'Present Tardy', 'e.g., 3', defaultTardy)}
                    
                    ${createInput('input-presentTotal', 'Present Total (Auto)', 'Calc', defaultPresentTotal, true)}
                    <div></div>
                    
                    ${createInput('input-progressReportBrought', 'Reports Brought', 'e.g., 25', defaultBrought)}
                    ${createInput('input-progressReportSigned', 'Reports Signed', 'e.g., 22', defaultSigned)}
                </div>
                
                <p class="text-xs text-indigo-600 mt-3 text-center font-semibold">‚ú® Present Total = On-Time + Tardy | Absent = Total - Present Total</p>
                
                <div class="mt-4 p-3 bg-gray-100 rounded-lg shadow-inner flex justify-between items-center text-sm text-gray-700 font-medium">
                    <span class="text-2xs sm:text-sm">Score calculation is automatic upon saving.</span>
                    ${isReportEntered ? '<span class="text-red-600 font-bold">REPORT ALREADY ENTERED</span>' : '<span class="text-green-600 font-bold">AWAITING ENTRY</span>'}
                </div>
            `;
        };
        
        /**
         * Checks the validity of the input fields and returns the report object or null.
         */
        /**
         * Checks the validity of the input fields and returns the report object or null.
         */
        /**
         * Checks the validity of the input fields and returns the report object or null.
         */
        const checkInputValidity = (classId) => {
            const totalStudents = parseInt(document.getElementById('input-totalStudents').value.trim());
            const presentOnTime = parseInt(document.getElementById('input-presentOnTime').value.trim());
            const tardyToday = parseInt(document.getElementById('input-tardyToday').value.trim());
            const progressReportBrought = parseInt(document.getElementById('input-progressReportBrought').value.trim());
            const progressReportSigned = parseInt(document.getElementById('input-progressReportSigned').value.trim());

            if (isNaN(totalStudents) || isNaN(presentOnTime) || isNaN(tardyToday) || isNaN(progressReportBrought) || isNaN(progressReportSigned) ||
                totalStudents < 0 || presentOnTime < 0 || tardyToday < 0 || progressReportBrought < 0 || progressReportSigned < 0) {
                showMessage('Input Error', 'Please ensure all fields are filled with non-negative numbers.');
                return null;
            }

            const presentTotal = presentOnTime + tardyToday;
            
            if (presentTotal > totalStudents) {
                showMessage('Input Error', 'Present On-Time + Tardy cannot exceed Total Students.');
                return null;
            }
            if (progressReportBrought > totalStudents) {
                showMessage('Input Error', 'Reports Brought cannot exceed Total Students in Class.');
                return null;
            }
            if (progressReportSigned > progressReportBrought) {
                showMessage('Input Error', 'Reports Signed cannot exceed Reports Brought.');
                return null;
            }
            
            const classDef = getCurrentClassDefinitions().find(c => c.id === classId);

            return {
                classId: classId,
                className: classDef.name,
                totalStudents: totalStudents,
                presentToday: presentOnTime,
                tardyToday: tardyToday,
                progressReportBrought: progressReportBrought,
                progressReportSigned: progressReportSigned,
                // Server timestamp will be added on save
                // userId and dateId are available globally/contextually
            };
        };
        
        /**
         * Opens the modal and populates the form for the selected class.
         * This function is called by the onclick handler on each class card.
         * @param {string} classId - The ID of the class card clicked.
         */
        window.selectClass = (classId) => {
            // Find the class definition
            const classDef = getCurrentClassDefinitions().find(c => c.id === classId);
            if (!classDef) {
                showMessage('Error', `Class ID ${classId} not found.`);
                return;
            }

            // Get the existing report data for the selected date
            const report = currentReports[classId] || {};
            
            // Set global state
            selectedClassId = classId;

            // 1. Render the form
            const contentContainer = document.getElementById('details-panel-content');
            contentContainer.innerHTML = renderReportForm(classDef, report);
            
            // 2. Render the footer buttons (Save/Close)
            const footerContainer = document.getElementById('modal-footer');
            footerContainer.innerHTML = `
                <div class="flex justify-between w-full gap-3">
                    <button id="save-report-btn" onclick="saveReport('${classId}')" 
                            class="flex items-center justify-center bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md flex-1 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg id="save-spinner" class="animate-spin-slow h-5 w-5 text-white mr-3 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span id="save-button-text">üíæ Save</span>
                    </button>
                    <button onclick="closeModal()" 
                            class="bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-600 transition duration-150 shadow-md flex-1">
                        Close
                    </button>
                </div>
            `;

            // 3. Show the modal
            document.getElementById('report-modal').classList.remove('hidden');
        };

        /**
         * Saves the daily report data to Firestore.
         * This function is passed the classId from the button's onclick handler.
         * NOTE: This function requires Firebase imports (doc, runTransaction, serverTimestamp)
         */
        window.saveReport = async (classId) => {
            if (isSaving || !userId) return; 

            const saveButton = document.getElementById('save-report-btn');
            const spinner = document.getElementById('save-spinner');
            const buttonText = document.getElementById('save-button-text');
            
            // 1. Validate inputs and get the report object
            const newReport = checkInputValidity(classId);
            if (!newReport) {
                return; // checkInputValidity already showed the error message
            }

            // 2. Set UI to saving state
            isSaving = true;
            saveButton.disabled = true;
            buttonText.textContent = 'Saving...';
            spinner.classList.remove('hidden');

            try {
                // Determine the document ID for the daily report
                const dailyReportDocRef = doc(db, 'users', userId, 'dailyReports', selectedDateId, 'classes', classId);
                
                // Add metadata for the database record
            const dataToSave = {
                ...newReport,
                dateId: selectedDateId,
                userId: userId,
                userName: currentUserName, // <<< NEW LINE: Store the user's name
                timestamp: serverTimestamp(), // Use server timestamp for accurate ordering/timing
            };

                // --- TRANSACTION to Update Daily Report and Accumulated Scores ---
                await runTransaction(db, async (transaction) => {
                    
                    // A. Update the Daily Report
                    transaction.set(dailyReportDocRef, dataToSave);
                    
                    // B. Update/Create Accumulated Score
                    const accumulatedScoreDocRef = doc(db, 'users', userId, 'accumulatedScores', classId);
                    
                    // Calculate the new daily score
                    const dailyScore = calculateDailyScore(newReport);
                    
                    // Get the current accumulated score 
                    const accumulatedDoc = await transaction.get(accumulatedScoreDocRef);
                    const accumulatedData = accumulatedDoc.exists() ? accumulatedDoc.data() : {
                        totalScore: 0,
                        daysCount: 0,
                        lastReportDate: null,
                        lastScoreContribution: 0
                    };
                    
                    let newTotalScore = accumulatedData.totalScore;
                    let newDaysCount = accumulatedData.daysCount;
                    let scoreContribution = dailyScore;

                    // CHECK: Is the user re-saving an existing report for a date that already contributed?
                    if (accumulatedData.lastReportDate === selectedDateId) {
                        // Subtract the old score contribution
                        newTotalScore -= accumulatedData.lastScoreContribution;
                        // daysCount remains the same 
                    } else {
                        // This is a NEW report for a new date.
                        newDaysCount += 1;
                    }
                    
                    // Add the new score contribution
                    newTotalScore += scoreContribution;
                    
                    // Final update of the accumulated score document
                    transaction.set(accumulatedScoreDocRef, {
                        totalScore: newTotalScore,
                        daysCount: newDaysCount,
                        lastReportDate: selectedDateId, 
                        lastScoreContribution: scoreContribution 
                    });

                }); // End of transaction

                showMessage('Success!', `Report for ${classId} on ${getDisplayDate(selectedDateId)} saved successfully!`);
                
                // Close the modal after successful save
                closeModal();

            } catch (error) {
                console.error(`Error saving report for ${classId}:`, error);
                showMessage('Error', `Failed to save report for ${classId}: ${error.message}`);
                
            } finally {
                isSaving = false;
                saveButton.disabled = false;
                buttonText.textContent = 'üíæ Save';
                spinner.classList.add('hidden');
            }
        };

        // --- FIREBASE AND AUTHENTICATION ---

const handleAppReady = async () => {
    document.getElementById('date-selector').value = todayDateId;
    document.getElementById('header-dept-selector').value = selectedDepartment;
    
    // Load class definitions from Firebase
    await loadClassDefinitions();
    
    // Load admin list and check if current user is admin
    await loadAdminList();
    
    // Load menu visibility settings
    await loadMenuVisibility();
    
    // Set up real-time listener for class definitions
    setupClassDefinitionsListener();
    
    // We ensure the spinner is visible and rely on setupFirestoreListeners to hide the loading message when data is received.
    document.getElementById('loading-spinner').classList.remove('hidden'); // Ensure spinner is visible
    document.getElementById('initial-message-text').textContent = "Authentication Complete! Fetching data...";
    setupFirestoreListeners(); // Set up listeners
    // REMOVED: The setTimeout logic. The listener will now correctly hide the overlay once data is available.
};


        const initializeFirebase = () => {
            const initialMessageDiv = document.getElementById('initial-message');
            const messageText = document.getElementById('initial-message-text');
            const spinner = document.getElementById('loading-spinner');
            const errorDetails = document.getElementById('error-details');

            messageText.textContent = "Connecting to database and authenticating user...";
            initialMessageDiv.classList.remove('hidden');
            spinner.classList.remove('hidden');
            errorDetails.classList.add('hidden');

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated as:", userId);
                        document.getElementById('user-id-display').textContent = `ID: ${userId}`;
                        isAuthReady = true;
                        handleAppReady();
                        
                    } else {
                        // Attempt to sign in if not already authenticated
                        try {
                            // On public hosts, initialAuthToken will be null, so we fall back to anonymous sign-in.
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            // onAuthStateChanged should fire again with the user
                        } catch (error) {
                            console.error("Authentication failed:", error);
                            spinner.classList.add('hidden');
                            messageText.textContent = "Authentication Failed. Access Denied.";
                            errorDetails.textContent = `Error: ${error.message}`;
                            errorDetails.classList.remove('hidden');
                            showMessage('Authentication Error', `Could not sign in to the database. ${error.message}`);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                spinner.classList.add('hidden');
                messageText.textContent = 'Error: Failed to initialize Firebase.';
                errorDetails.textContent = `Check config and console. Error: ${error.message}`;
                errorDetails.classList.remove('hidden');
                showMessage('Initialization Error', 'The app could not connect to the database. See console for details.');
            }
        };

        // --- FIRESTORE LISTENERS ---
const setupFirestoreListeners = () => {
    if (!isAuthReady) return; 

    // 1. Daily Report Listener - LISTEN TO THE SINGLE DOCUMENT PER DATE
// Path: /artifacts/{appId}/public/data/daily_attendance_reports/{dateID}
const dailyReportDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily_attendance_reports', selectedDateId);

// Unsubscribe from old listener if it exists
if (window.dailyReportUnsubscribe) {
    window.dailyReportUnsubscribe();
}
    
    // Store the selectedDateId at the time the listener is created
    // This allows us to check if the data returned is for the date the user is currently viewing.
    const expectedDateId = selectedDateId;

    window.dailyReportUnsubscribe = onSnapshot(dailyReportDocRef, (docSnapshot) => {
    const newReports = {};
    const expectedDateId = selectedDateId; 
    
    // If the document exists, its fields are the class reports
    if (docSnapshot.exists()) {
        const data = docSnapshot.data();
        
        // Iterate through all fields in the document
        Object.keys(data).forEach(key => {
            // Filter out non-class fields (like 'audit_trail' and 'lastUpdated')
            // This assumes all class IDs contain a hyphen, e.g., 'Boys-1A'.
            if (key !== 'audit_trail' && key !== 'lastUpdated' && key.includes('-')) {
                // Normalize old class IDs to new format (adds department prefix if missing)
                const normalizedKey = normalizeClassId(key);
                
                // Only include if it belongs to the currently selected department
                if (normalizedKey.startsWith(`${selectedDepartment}-`)) {
                    newReports[normalizedKey] = data[key];
                }
            }
        });
    } else {
        console.log(`No daily report document found for ${expectedDateId}.`);
    }

    // Update the global state
    currentReports = newReports;
    console.log(`Daily Reports updated for ${expectedDateId} (Document Fetch):`, currentReports);
    // Re-render the class tiles with the fresh data (Uses renderClassList for consistency)
    renderClassList();
    // If the modal is open, ensure it reflects the latest data
    if (selectedClassId && !document.getElementById('report-modal').classList.contains('hidden')) {
        openReportModal(selectedClassId);
    }

    // Hide the initial message overlay once data is received
    const initialMessage = document.getElementById('initial-message');
    if (!initialMessage.classList.contains('hidden')) {
        initialMessage.classList.add('hidden');
    }
}, (error) => {
    console.error("Error fetching daily reports:", error);
    // Display error, but keep the UI minimally functional
    currentReports = {};
    renderClassList();
    document.getElementById('initial-message-text').textContent = "Error loading daily reports. See console.";
    document.getElementById('error-details').textContent = `Firestore Error: ${error.message}`;
    document.getElementById('error-details').classList.remove('hidden');
});

    // 2. Listener for Accumulated Scores (Always uses the latest data for overall ranking)
    // Unsubscribe from old listener if it exists
    if (window.accumulatedScoresUnsubscribe) {
        window.accumulatedScoresUnsubscribe();
    }
    
    const scoresCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'accumulated_class_scores');
    
    window.accumulatedScoresUnsubscribe = onSnapshot(scoresCollectionRef, (querySnapshot) => {
        const newScores = {};
        querySnapshot.forEach(doc => {
            // Normalize old class IDs to new format
            const normalizedId = normalizeClassId(doc.id);
            
            // Only include if it belongs to the currently selected department
            if (normalizedId.startsWith(`${selectedDepartment}-`)) {
                newScores[normalizedId] = doc.data();
            }
        });
        currentAccumulatedScores = newScores;
        console.log('Accumulated Scores updated:', currentAccumulatedScores);
        // Re-render only if the main class list is visible
        if (document.getElementById('initial-message').classList.contains('hidden')) {
            renderClassList(); // Use renderClassList for consistency
        }
    }, (error) => {
        console.error("Error fetching accumulated scores:", error);
    });
};

        // --- RENDERING FUNCTIONS (UI/UX) ---

        /**
         * Renders the overall class list with Daily and Accumulated Scores using the high-density grid.
         */
        /**
         * Renders the overall class list with Daily and Accumulated Scores using the high-density grid.
         */

         // --- START RANKING UTILITIES (NEW) ---
        
        /**
         * Calculates ranks based on dailyScoreValue, ignoring any class with a score of -1 (N/A).
         * @param {Array<Object>} classes - Array of class objects, each with a 'dailyScoreValue' property.
         * @returns {Map<string, number>} A map where key is classId and value is the rank (1, 2, or 3).
         */
        const calculateRanks = (classes) => {
            // 1. Filter out classes with no score (-1 or null/undefined) and sort descending
            const rankedClasses = classes
                .filter(c => c.dailyScoreValue !== null && c.dailyScoreValue !== -1)
                .sort((a, b) => b.dailyScoreValue - a.dailyScoreValue);

            const rankMap = new Map();
            let currentRank = 1;
            let lastScore = null;

            for (let i = 0; i < rankedClasses.length && currentRank <= 3; i++) {
                const classItem = rankedClasses[i];

                if (lastScore === null || classItem.dailyScoreValue < lastScore) {
                    // This is a new, lower score, so the rank is i + 1.
                    currentRank = i + 1;
                }
                
                // Only assign if we are 1st, 2nd, or 3rd
                if (currentRank <= 3) {
                    rankMap.set(classItem.id, currentRank);
                }
                
                lastScore = classItem.dailyScoreValue;
            }

            return rankMap;
        };

        /**
         * Helper function to generate the Trophy HTML based on rank using emojis.
         * @param {number} rank - The rank (1, 2, or 3).
         * @returns {string} HTML string for the rank badge.
         */
        const getTrophyHtml = (rank) => {
            let emoji = '';
            let colorClass = 'ml-1 text-sm leading-none'; 

            if (rank === 1) {
                emoji = 'ü•á';
            } else if (rank === 2) {
                emoji = 'ü•à';
            } else if (rank === 3) {
                emoji = 'ü•â';
            } else {
                return ''; 
            }
            
            return `<span class="${colorClass}">${emoji}</span>`;
        };

        // --- END RANKING UTILITIES ---
        /**
         * Renders the overall class list with Daily and Accumulated Scores using the high-density grid.
         */
        /**
         * Renders the overall class list with Daily and Accumulated Scores using the high-density grid.
         */
        /**
         * Renders the overall class list with Daily and Accumulated Scores using the high-density grid.
         */
        // Locate and replace the ENTIRE 'renderClassList' function with the code below.
const renderClassList = () => {
    const container = document.getElementById('scores-view');
    container.innerHTML = '';
    
    // Step 1: Map all class data
    const allClassesInitial = getCurrentClassDefinitions().map(classDef => {
        const report = currentReports[classDef.id] || {}; 
        const rawAccumulated = currentAccumulatedScores[classDef.id] || {};
        
        const accumulated = {
            totalScore: rawAccumulated.totalScore || 0,
            daysCount: rawAccumulated.daysCount || 0,
            lastScoreContribution: rawAccumulated.lastScoreContribution || 0,
            lastReportDate: rawAccumulated.lastReportDate || ''
        };
        
        const dailyReportHasData = report.totalStudents !== undefined && report.totalStudents !== 0 && Object.keys(report).length > 1;
        const dailyScoreValue = dailyReportHasData ? calculateDailyScore(report) : -1; 
        const dailyScoreText = dailyReportHasData ? `${dailyScoreValue.toFixed(2)}` : 'N/A';
        
        const isCumulativeData = accumulated.daysCount > 0;
        const averageScore = isCumulativeData ? (accumulated.totalScore / accumulated.daysCount) : 0;
        const cumulativeAvgText = averageScore.toFixed(2); 

        const cumulativeTitle = isCumulativeData 
            ? `Cumulative Breakdown:\nTotal Points: ${accumulated.totalScore.toFixed(2)}\nTotal Days: ${accumulated.daysCount}\nLast Score Added: ${accumulated.lastScoreContribution.toFixed(2)}\nLast Report Date: ${accumulated.lastReportDate || 'Unknown'}`
            : `No previous reports recorded.`;

        const borderColorClass = getPerformanceBorder(averageScore, isCumulativeData);
        const performance = getPerformanceStatus(averageScore, isCumulativeData);
        
        const totalStudents = report.totalStudents || 0;
        const presentToday = report.presentToday || 0;
        const tardyToday = report.tardyToday || 0;
        const absentToday = totalStudents > 0 ? (totalStudents - presentToday - tardyToday) : 0;
        const reportBrought = report.progressReportBrought || 0;
        const reportSigned = report.progressReportSigned || 0;
        
        return {
            ...classDef,
            dailyScoreValue, 
            dailyScoreText,
            averageScore: cumulativeAvgText, 
            borderColorClass, 
            performance, 
            cumulativeTitle, 
            totalStudents,
            presentToday,
            tardyToday,
            absentToday,
            reportBrought,
            reportSigned
        };
    });

    // Step 2: Determine Ranks
    const rankMap = calculateRanks(allClassesInitial);
    
    // Step 3: Re-map by gender
    let girlsClasses = [];
    let boysClasses = [];
    
    allClassesInitial.forEach(c => {
        const classWithRank = { ...c, rank: rankMap.get(c.id) || 0 };
        // Check gender property instead of ID prefix
        if (c.gender === 'Girls') girlsClasses.push(classWithRank);
        else if (c.gender === 'Boys') boysClasses.push(classWithRank);
    });

    // --- Helper function to render a section ---
    const renderSection = (classes, title, headerColor, headerBg) => {
        if (classes.length === 0) return '';

        return `
            <div class="mb-4">
                <h2 class="text-xl font-extrabold ${headerColor} border-b-2 border-gray-300 pb-1 mb-2">
                    ${title}
                </h2>
                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2">
                    ${classes.map(c => {
                        const cardBgColor = c.id.startsWith('Girls') ? 'bg-pink-50' : 'bg-blue-50';
                        const avgScoreWidth = Math.min(parseFloat(c.averageScore), 100).toFixed(0);
                        const presentColor = c.presentToday >= (c.totalStudents * 0.9) ? 'text-green-600' : 'text-red-500';
                        const trophyHtml = getTrophyHtml(c.rank);
                        
                        return `
                            <div class="p-2 ${cardBgColor} rounded-xl shadow-md transition transform duration-300 ease-in-out hover:scale-[1.03] hover:shadow-xl h-full cursor-pointer
                                         border-l-4 ${c.borderColorClass}" 
                                 onclick="selectClass('${c.id}')"
                                 title="${c.cumulativeTitle.replace(/"/g, '&quot;')}"> 
                                    
                                <div class="flex justify-between items-center mb-1">
                                    <div class="flex items-center">
                                        <span class="font-extrabold text-sm text-gray-900 leading-tight">${c.name}</span>
                                        ${trophyHtml}
                                    </div>
                                    <span class="w-2.5 h-2.5 rounded-full ${c.performance.bg} block" title="Cumulative Status: ${c.performance.text}"></span>
                                </div>
                                
                                <div class="flex items-end mb-2">
                                    <p class="text-2xs text-gray-500 font-semibold mr-1 leading-none">Daily:</p>
                                    <p class="font-extrabold text-base text-indigo-700 leading-none">${c.dailyScoreText}%</p>
                                </div>
                                <div class="grid grid-cols-6 gap-0 text-center w-full pb-1 border-b border-gray-100 divide-x divide-gray-200">
                                    
                                    <div class="flex flex-col">
                                        <span class="text-2xs text-gray-500 font-medium leading-none">T</span>
                                        <span class="text-xs font-bold text-gray-800 leading-snug">${c.totalStudents}</span>
                                    </div>

                                    <div class="flex flex-col">
                                        <span class="text-2xs text-gray-500 font-medium leading-none">P</span>
                                        <span class="text-xs font-bold ${presentColor} leading-snug">${c.presentToday}</span>
                                    </div>
                                    
                                    <div class="flex flex-col">
                                        <span class="text-2xs text-gray-500 font-medium leading-none">T</span>
                                        <span class="text-xs font-bold text-gray-600 leading-snug">${c.tardyToday}</span>
                                    </div>
                                    
                                    <div class="flex flex-col">
                                        <span class="text-2xs text-gray-500 font-medium leading-none">A</span>
                                        <span class="text-xs font-bold text-red-600 leading-snug">${c.absentToday}</span>
                                    </div>

                                    <div class="flex flex-col">
                                        <span class="text-2xs text-gray-500 font-medium leading-none">R</span>
                                        <span class="text-xs font-bold text-gray-800 leading-snug">${c.reportBrought}</span>
                                    </div>

                                    <div class="flex flex-col">
                                        <span class="text-2xs text-gray-500 font-medium leading-none">S</span>
                                        <span class="text-xs font-bold text-gray-800 leading-snug">${c.reportSigned}</span>
                                    </div>
                                </div>
                                
                                <p class="text-2xs text-gray-500 leading-none mt-2">Avg (${c.averageScore}%):</p>
                                <div class="h-1 bg-gray-200 rounded-full">
                                    <div class="h-1 bg-blue-500 rounded-full transition-all duration-300" style="width: ${avgScoreWidth}%;"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    // Step 4: Render both sections
    let htmlContent = '';
    htmlContent += renderSection(girlsClasses, 'Girls Section', 'text-pink-600', 'bg-pink-100');
    htmlContent += renderSection(boysClasses, 'Boys Section', 'text-blue-600', 'bg-blue-100');
    
    container.innerHTML = htmlContent;

    if (allClassesInitial.length === 0) {
         container.innerHTML = `<p class="text-center text-gray-500 italic py-10">No class added. Please contact admin</p>`;
    } else if (allClassesInitial.every(c => c.performance.text === 'No Data')) {
         container.insertAdjacentHTML('afterbegin', `<p class="text-center text-sm font-semibold text-gray-600 bg-yellow-50 p-2 rounded-lg mb-4">Database is empty. Click any class card to enter today's first report!</p>`);
    }
};
        
        /**
         * Updates only the Daily Class Score (DCS) text and color in the open modal.
         */
        const updateModalScoreDisplay = (classId) => {
            const report = currentReports[classId];
            if (!report) return;

            const dailyScore = calculateDailyScore(report);
            const scoreElement = document.getElementById('daily-class-score');
            
            if (scoreElement) {
                scoreElement.textContent = `DCS: ${dailyScore.toFixed(2)} / 100`;
                const colorClass = dailyScore >= 80 ? 'text-green-600' : dailyScore >= 50 ? 'text-yellow-600' : 'text-red-600';
                scoreElement.className = `text-lg font-bold ${colorClass}`;
            }
        }


        /**
         * Renders the detail entry panel structure for the selected class into the modal content area.
         */
        /**
         * Renders the detail entry panel structure for the selected class into the modal content area.
         */
        /**
         * Renders the detail entry panel structure for the selected class into the modal content area.
         */
        const renderModalContent = (classId) => {
            const classDef = getCurrentClassDefinitions().find(c => c.id === classId);
            if (!classDef) return;

            const isEditable = selectedDateId === todayDateId;
            const disabledAttr = isEditable ? '' : 'disabled';
            const statusColor = isEditable ? 'text-indigo-700' : 'text-gray-500';

            if (!currentReports[classId]) {
                currentReports[classId] = { totalStudents: 0, presentToday: 0, tardyToday: 0, progressReportBrought: 0, progressReportSigned: 0 };
            }

            selectedClassId = classId;
            const report = currentReports[classId];

            // CRITICAL DEFENSE: Use 0 if the field is missing from the report object
            const totalStudents = report.totalStudents || 0;
            const presentOnTime = report.presentToday || 0;
            const tardyToday = report.tardyToday || 0;
            const reportBrought = report.progressReportBrought || 0;
            const reportSigned = report.progressReportSigned || 0;
            
            // Calculate Present Total and Absent
            const presentTotal = presentOnTime + tardyToday;
            const absentToday = totalStudents > 0 ? Math.max(0, totalStudents - presentTotal) : 0;

            document.getElementById('details-panel-content').innerHTML = `
                <div class="p-4 space-y-4 shadow-none border-none">
                    <div class="flex justify-between items-center border-b pb-2 mb-3">
                        <h2 class="text-2xl font-extrabold ${statusColor}">Class ${classDef.name}</h2>
                        <div id="daily-class-score" class="text-lg font-bold text-gray-400">
                            Loading...
                        </div>
                    </div>
                    
                    <p class="text-sm font-medium text-center ${isEditable ? 'text-green-600' : 'text-red-600'} bg-${isEditable ? 'green-50' : 'red-50'} py-1 rounded-lg border border-${isEditable ? 'green-200' : 'red-200'}">
                        ${isEditable ? 'EDIT MODE: Data entry for today.' : `VIEW MODE: Showing data for ${getDisplayDate(selectedDateId)}`}
                    </p>
                    
                    <!-- Auto-calculated values summary -->
                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 space-y-1">
                        <div class="flex justify-between text-sm">
                            <span class="text-blue-700 font-medium">Present Total:</span>
                            <span class="text-blue-700 font-bold font-mono">${presentTotal}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-red-700 font-medium">Absent Total:</span>
                            <span class="text-red-700 font-bold font-mono">${absentToday}</span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="grid grid-cols-1">
                            <div>
                                <label for="totalStudents" class="block text-xs font-medium text-gray-700 mb-1">Total Students</label>
                                <input type="number" id="totalStudents" value="${totalStudents}" oninput="updateReportEntry('${classId}', 'totalStudents', this.value)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 font-mono text-lg ${disabledAttr ? 'bg-gray-100' : ''}" placeholder="0" min="0" ${disabledAttr}>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="presentOnTime" class="block text-xs font-medium text-gray-700 mb-1">Present On-Time (P)</label>
                                <input type="number" id="presentOnTime" value="${presentOnTime}" oninput="updateReportEntry('${classId}', 'presentToday', this.value)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 font-mono text-lg ${disabledAttr ? 'bg-gray-100' : ''}" placeholder="0" min="0" ${disabledAttr}>
                            </div>
                            <div>
                                <label for="presentTardy" class="block text-xs font-medium text-gray-700 mb-1">Present Tardy (T)</label>
                                <input type="number" id="presentTardy" value="${tardyToday}" oninput="updateReportEntry('${classId}', 'tardyToday', this.value)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 font-mono text-lg ${disabledAttr ? 'bg-gray-100' : ''}" placeholder="0" min="0" ${disabledAttr}>
                            </div>
                        </div>

                        <div class="space-y-3 pt-2 border-t border-dashed">
                            <div>
                                <label for="reportBrought" class="block text-xs font-medium text-gray-700 mb-1">Progress Reports Brought</label>
                                <input type="number" id="reportBrought" value="${reportBrought}" oninput="updateReportEntry('${classId}', 'progressReportBrought', this.value)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 font-mono text-lg ${disabledAttr ? 'bg-gray-100' : ''}" placeholder="0" min="0" ${disabledAttr}>
                            </div>
                            <div>
                                <label for="reportSigned" class="block text-xs font-medium text-gray-700 mb-1">Progress Reports Signed</label>
                                <input type="number" id="reportSigned" value="${reportSigned}" oninput="updateReportEntry('${classId}', 'progressReportSigned', this.value)"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 font-mono text-lg ${disabledAttr ? 'bg-gray-100' : ''}" placeholder="0" min="0" ${disabledAttr}>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="log-history-container" class="mt-6 p-4 bg-gray-50 rounded-xl shadow-inner max-h-64 overflow-y-auto">
                    <p class="text-sm text-gray-400 italic text-center">Loading log history...</p>
                </div>
            `;
            
            updateModalScoreDisplay(classId);

            const modalFooter = document.getElementById('modal-footer');
            if (isEditable) {
                modalFooter.innerHTML = `
                    <div class="flex gap-3">
                        <button id="modal-save-button" onclick="saveClassReport()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold shadow-md hover:bg-green-700 transition duration-150 ease-in-out disabled:opacity-50 flex items-center justify-center" disabled>
                            <span id="modal-save-button-text">üíæ Save</span>
                            <svg id="modal-save-spinner" class="animate-spin-slow h-5 w-5 text-white ml-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                        <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold shadow-md hover:bg-gray-600 transition duration-150 ease-in-out">
                            Close
                        </button>
                    </div>
                `;
            } else {
                 modalFooter.innerHTML = `
                    <button onclick="closeModal()" class="w-full px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold shadow-md hover:bg-gray-700 transition duration-150 ease-in-out">
                        Close View
                    </button>
                `;
            }
        };

        /**
         * Selects a class for detail entry and shows the modal.
         */
        window.selectClass = (classId) => {
            selectedClassId = classId;
            renderModalContent(classId);
            document.getElementById('report-modal').classList.remove('hidden');
            
            // CRITICAL NEW CALL: Fetch and display log history when modal opens
            fetchAndRenderLogHistory(classId);
        };

        // --- DATA INPUT & PROCESSING ---

        /**
         * Updates the local state object for the selected class report and performs data integrity checks.
         */
        window.updateReportEntry = (classId, key, value) => {
            if (selectedDateId !== todayDateId) return;

            let numValue = parseInt(value, 10);
            if (isNaN(numValue) || numValue < 0) numValue = 0;
            
            if (!currentReports[classId]) {
                currentReports[classId] = { totalStudents: 0, presentToday: 0, tardyToday: 0, progressReportBrought: 0, progressReportSigned: 0 };
            }

            // Retrieve total first to validate before setting
            const total = currentReports[classId].totalStudents || 0;
            
            // Clamp the value if it's presentToday or tardyToday and exceeds total
            if (key === 'presentToday' || key === 'tardyToday') {
                if (numValue > total) {
                    numValue = total;
                    const inputElement = document.getElementById(key === 'presentToday' ? 'presentOnTime' : 'presentTardy');
                    if (inputElement) inputElement.value = numValue;
                }
            }
            
            currentReports[classId][key] = numValue;

            // Retrieve latest values after setting
            let presentOnTime = currentReports[classId].presentToday || 0;
            let tardy = currentReports[classId].tardyToday || 0;

            // 1. Logic to ensure (Present On-Time + Tardy) does not exceed Total
            if (key === 'presentToday' || key === 'tardyToday' || key === 'totalStudents') {
                
                const presentTotal = presentOnTime + tardy;
                
                if (presentTotal > total) {
                    // Prioritize the most recent change by adjusting the other field
                    if (key === 'presentToday') {
                        // Adjust tardy to fit
                        currentReports[classId].tardyToday = Math.max(0, total - presentOnTime);
                        tardy = currentReports[classId].tardyToday;
                        const tardyInput = document.getElementById('presentTardy');
                        if (tardyInput) tardyInput.value = tardy;
                    } else if (key === 'tardyToday') {
                        // Adjust present on-time to fit
                        currentReports[classId].presentToday = Math.max(0, total - tardy);
                        presentOnTime = currentReports[classId].presentToday;
                        const presentInput = document.getElementById('presentOnTime');
                        if (presentInput) presentInput.value = presentOnTime;
                    } else if (key === 'totalStudents') {
                        // If total decreases, clamp both values
                        if (presentOnTime > total) {
                            currentReports[classId].presentToday = total;
                            presentOnTime = total;
                            const presentInput = document.getElementById('presentOnTime');
                            if (presentInput) presentInput.value = presentOnTime;
                        }
                        if (tardy > total) {
                            currentReports[classId].tardyToday = 0;
                            tardy = 0;
                            const tardyInput = document.getElementById('presentTardy');
                            if (tardyInput) tardyInput.value = tardy;
                        }
                    }
                }
                
                // Update Present Total (Auto)
                const finalPresentTotal = presentOnTime + tardy;
                const presentTotalInput = document.getElementById('presentTotal');
                if (presentTotalInput) presentTotalInput.value = finalPresentTotal;
                
                // Calculate Absent
                const absent = Math.max(0, total - finalPresentTotal);
                const absentInput = document.getElementById('absentTotal');
                if (absentInput) absentInput.value = absent;
            }

            // 2. Standard overflow checks for Reports
            const dependentKeys = ['progressReportBrought', 'progressReportSigned'];
            
            if (key === 'totalStudents') {
                // Check all
                ['presentToday', 'tardyToday', 'progressReportBrought', 'progressReportSigned'].forEach(k => {
                     if ((currentReports[classId][k] || 0) > total) {
                         currentReports[classId][k] = total;
                         // Update DOM
                         let elId = k === 'progressReportBrought' ? 'reportBrought' : k === 'progressReportSigned' ? 'reportSigned' : k;
                         const el = document.getElementById(elId);
                         if(el) el.value = total;
                     }
                });
            } else if (dependentKeys.includes(key) && numValue > total) {
                currentReports[classId][key] = total;
                let inputId = key === 'progressReportBrought' ? 'reportBrought' : 'reportSigned';
                const inputElement = document.getElementById(inputId);
                if (inputElement) inputElement.value = total;
            }

            updateModalScoreDisplay(classId);
            document.getElementById('modal-save-button').disabled = false;
        };

        /**
 * Executes the save operation for a single class.
 */
window.saveClassReport = async () => {
    if (selectedDateId !== todayDateId) {
        showMessage('Access Denied', 'You can only save or modify reports for the current date.');
        return;
    }
    const classId = selectedClassId;
    if (isSaving || !isAuthReady || !classId) return;

    // CRITICAL: Re-check user name before saving for accountability
    await ensureUserName();
    if (!currentUserName) {
        showMessage('Action Blocked', 'You must enter your name to save a report for accountability.');
        return;
    }

    isSaving = true;
    const saveButton = document.getElementById('modal-save-button');
    const buttonText = document.getElementById('modal-save-button-text');
    const spinner = document.getElementById('modal-save-spinner');
    saveButton.disabled = true;
    buttonText.textContent = 'Saving...';
    spinner.classList.remove('hidden');

    const report = currentReports[classId];
    if (!report || report.totalStudents <= 0) {
        showMessage('Save Failed', `Cannot save report for ${classId}. Please enter the total number of students.`);
        isSaving = false;
        saveButton.disabled = false;
        buttonText.textContent = 'üíæ Save';
        spinner.classList.add('hidden');
        return;
    }

    // Determine if this is an update or new entry for logging
    const isUpdate = currentReports[classId]?.lastUpdated !== undefined;
    const action = isUpdate ? 'Report Update' : 'New Report Entry';
    const newDailyScore = calculateDailyScore(report);
    let message = ''; // Initialize message for use in the final success block

    try {
    // 1. Transaction for Daily Report (update fields) and Audit Log (create new document)
    await runTransaction(db, async (transaction) => {
        // A. Daily Report Document Reference (single document per date)
        const dailyReportDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'daily_attendance_reports', todayDateId);

        // 1. Prepare the Daily Report Payload (Map Field) - Uses serverTimestamp() correctly
        const dailyReportPayload = {
            lastUpdated: serverTimestamp(),
            dailyScore: newDailyScore, 
            ...report
        };

        // Create update object for the main document
        const updates = {
            [classId]: dailyReportPayload, 
        };
        
        // Set/Merge the main report update
        transaction.set(dailyReportDocRef, updates, { merge: true });

        // B. Audit Log Subcollection Reference
        const auditTrailColRef = collection(dailyReportDocRef, 'audit_trail');
        
        // 2. Prepare the Log Entry (for the new subcollection document)
        // Since this is a TOP-LEVEL field in a new document, serverTimestamp() is valid here.
        const logEntry = {
            classId: classId, // Add class ID for filtering in read logic (Step 2.2 uses this)
            userName: currentUserName,
            userId: userId,
            action: action,
            timestamp: serverTimestamp(), // FIX: Valid here as it's a top-level field
            score: newDailyScore, 
            reportData: dailyReportPayload // Safe to nest serverTimestamp here.
        };

        // Add the new log entry document to the subcollection
        transaction.set(doc(auditTrailColRef), logEntry);
    });
        // 2. Separate Transaction for Accumulated Score Update
        // This existing logic ensures safe read-modify-write for cumulative totals.

        const accumulatedDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'accumulated_class_scores', classId);
        
        await runTransaction(db, async (transaction) => {
            const accumulatedDoc = await transaction.get(accumulatedDocRef);
            
            // CRITICAL DEFENSE: Get data with defaults
            const data = accumulatedDoc.exists() ? accumulatedDoc.data() : {};
            let newTotalScore = data.totalScore || 0;
            let newDaysCount = data.daysCount || 0;
            let lastReportDate = data.lastReportDate || '';
            let lastScoreContribution = data.lastScoreContribution || 0;

            // *** CRITICAL PATCH FOR LEGACY DATA (from original code) *** // Ensures lastScoreContribution is not zero if totalScore is positive for same-day correction
            if (accumulatedDoc.exists() && lastReportDate === todayDateId && lastScoreContribution === 0 && newTotalScore > 0) {
                console.warn(`[LEGACY DATA FIX] Re-aligning lastScoreContribution from totalScore (${newTotalScore}) for same-day correction on ${classId}.`);
                lastScoreContribution = newTotalScore;
            }
            // *** END LEGACY PATCH ***

            if (lastReportDate !== todayDateId) {
                // CASE A: NEW DAY - Add new score and increment day count
                newTotalScore += newDailyScore;
                newDaysCount += 1;
                lastReportDate = todayDateId;
                message = `Report for ${classId} saved successfully, and cumulative score added for a new day.`;
                lastScoreContribution = newDailyScore; // Update contribution
            } else if (newDailyScore !== lastScoreContribution) {
                // CASE B: SAME DAY, SCORE CHANGED - Correct the score contribution
                // Subtract the old contribution
                newTotalScore -= lastScoreContribution;
                // Add the new score
                newTotalScore += newDailyScore;
                // Day count remains the same
                message = `Report for ${classId} updated successfully. Cumulative score corrected from ${lastScoreContribution.toFixed(2)} to ${newDailyScore.toFixed(2)}.`;
                lastScoreContribution = newDailyScore; // Update contribution
            } else {
                // CASE C: SAME DAY, NO CHANGE (or initial save without accumulated data)
                message = `Report for ${classId} saved successfully (no cumulative score change).`;
            }
            
            // Final update of the accumulated score document
            transaction.set(accumulatedDocRef, {
                totalScore: newTotalScore,
                daysCount: newDaysCount,
                lastReportDate: todayDateId,
                lastScoreContribution: lastScoreContribution
            });
        });
        
        showMessage('Success!', message); // Use the more detailed message
        // Close the modal after successful save
        closeModal();
    } catch (error) {
        console.error(`Error saving report for ${classId}:`, error);
        showMessage('Error', `Failed to save report for ${classId}: ${error.message}`);
    } finally {
        isSaving = false;
        saveButton.disabled = false;
        buttonText.textContent = 'üíæ Save';
        spinner.classList.add('hidden');
    }
};

                // --- INITIALIZATION ---
                
                window.onload = () => {
                    initializeFirebase();
                };
                
                // Copy user ID utility
        document.getElementById('user-id-display-mobile').addEventListener('click', () => {
            const idText = document.getElementById('user-id-display-mobile').textContent;
            const id = idText.replace('ID: ', '');
            try {
                const tempInput = document.createElement('textarea');
                tempInput.value = id;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showMessage('Copied!', `User ID: ${id} has been copied to your clipboard.`);
            } catch (err) {
                console.error('Could not copy text: ', err);
                showMessage('Error', 'Failed to copy User ID to clipboard.');
            }
        });
    </script>
    <script>
        // ... all your other existing functions (initializeFirebase, handleDateChange, showMessage, etc.) ...
        
        // --- MOBILE MENU LOGIC ---
        const menuToggle = document.getElementById('menu-toggle');
        const mobileNavMenu = document.getElementById('mobile-nav-menu');
        
        menuToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            mobileNavMenu.classList.toggle('hidden');
            
            // Sync user ID display in the mobile menu when opened
            const userIdDisplay = document.getElementById('user-id-display').textContent;
            document.getElementById('user-id-display-mobile').textContent = userIdDisplay;
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (!mobileNavMenu.classList.contains('hidden') && 
                !mobileNavMenu.contains(e.target) && 
                e.target !== menuToggle) {
                mobileNavMenu.classList.add('hidden');
            }
        });
        
        // Prevent menu from closing when clicking inside it
        mobileNavMenu.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Update the mobile user ID on initial load
        document.addEventListener('DOMContentLoaded', () => {
             // Pulls the ID from the hidden element (source of truth) and pushes it to the visible element
             const userIdDisplay = document.getElementById('user-id-display').textContent;
             document.getElementById('user-id-display-mobile').textContent = userIdDisplay;
        });
        
        // Copy user ID utility - The user clicks the visible element in the menu
        document.getElementById('user-id-display-mobile').addEventListener('click', () => {
            // We copy the text from the hidden element, which holds the authentic ID
            const idText = document.getElementById('user-id-display').textContent;
            const id = idText.replace('ID: ', '');
            try {
                const tempInput = document.createElement('textarea');
                tempInput.value = id;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showMessage('Copied!', `User ID: ${id} has been copied to your clipboard.`);
            } catch (err) {
                console.error('Could not copy text: ', err);
                showMessage('Error', 'Failed to copy User ID to clipboard.');
            }
        });
        
        // --- INITIALIZATION (Ensure this is at the end) ---
        window.onload = () => {
            initializeFirebase();
        };

    </script>
</body>
</html>
    </script>
</body>

</html>



